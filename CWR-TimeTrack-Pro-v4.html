<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CWR Consulting ¬∑ TimeTrack Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Plus+Jakarta+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f8f6f2;
  --surface: #ffffff;
  --surface2: #faf9f7;
  --border: #e8e4de;
  --border2: #d4cec6;
  --pink: #e8187a;
  --pink-light: #fce8f2;
  --pink-mid: #f472b6;
  --orange: #f4620a;
  --orange-light: #fff0e8;
  --green: #15803d;
  --green-light: #dcfce7;
  --green-mid: #22c55e;
  --text: #1a1612;
  --text2: #4a4540;
  --muted: #8a847c;
  --shadow: 0 2px 12px rgba(0,0,0,0.07);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.1);
}
/* DARK MODE */
body.dark {
  --bg: #0f0d0b;
  --surface: #1c1917;
  --surface2: #242220;
  --border: #2e2b28;
  --border2: #3d3935;
  --pink-light: #3d1228;
  --orange-light: #2d1800;
  --green-light: #0a2318;
  --text: #f0ede8;
  --text2: #c8c4be;
  --muted: #7a7670;
  --shadow: 0 2px 12px rgba(0,0,0,0.3);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.5);
}
body.dark tbody tr:hover td { background: #1f1d1b; }
body.dark .invoice-preview { background: #1c1917; color: #f0ede8; }
body.dark .cal-day.has-entries { background: #200f18; }

/* DARK MODE TOGGLE */
.dark-toggle {
  width: 44px; height: 24px;
  background: var(--border2);
  border-radius: 12px;
  position: relative;
  cursor: pointer;
  border: none;
  transition: background 0.25s;
  flex-shrink: 0;
}
.dark-toggle.on { background: var(--pink); }
.dark-toggle::after {
  content: '';
  position: absolute;
  width: 18px; height: 18px;
  background: #fff;
  border-radius: 50%;
  top: 3px; left: 3px;
  transition: left 0.25s;
}
.dark-toggle.on::after { left: 23px; }
.mode-label { font-size: 11px; color: var(--muted); }

* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Plus Jakarta Sans', sans-serif;
  font-size: 13.5px;
  min-height: 100vh;
  transition: background 0.25s, color 0.25s;
}

/* HEADER */
header {
  background: var(--surface);
  border-bottom: 2px solid var(--border);
  padding: 0 32px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: 64px;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: var(--shadow);
}
.logo {
  font-family: 'Playfair Display', serif;
  font-size: 22px;
  font-weight: 900;
  color: var(--pink);
  letter-spacing: -0.5px;
}
.logo span { color: var(--muted); font-weight: 700; }
nav { display: flex; gap: 2px; }
nav button {
  background: none;
  border: none;
  color: var(--muted);
  font-family: 'Plus Jakarta Sans', sans-serif;
  font-size: 13px;
  font-weight: 500;
  padding: 8px 14px;
  cursor: pointer;
  border-radius: 8px;
  transition: all 0.15s;
}
nav button:hover { color: var(--text); background: var(--surface2); }
nav button.active { color: var(--pink); background: var(--pink-light); font-weight: 600; }

/* TIMER WIDGET IN HEADER */
.timer-widget {
  display: flex;
  align-items: center;
  gap: 10px;
  background: var(--surface2);
  border: 1.5px solid var(--border);
  border-radius: 40px;
  padding: 6px 16px 6px 10px;
}
.timer-display {
  font-family: 'Playfair Display', serif;
  font-size: 18px;
  font-weight: 700;
  color: var(--text);
  letter-spacing: 1px;
  min-width: 72px;
  text-align: center;
}
.timer-display.running { color: var(--orange); }
.timer-btn {
  width: 32px; height: 32px;
  border-radius: 50%;
  border: none;
  cursor: pointer;
  font-size: 14px;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.15s;
}
.timer-btn.start { background: var(--green); color: #fff; }
.timer-btn.start:hover { background: #166534; }
.timer-btn.stop { background: var(--orange); color: #fff; }
.timer-btn.stop:hover { background: #c2410c; }
.timer-btn.reset { background: var(--border); color: var(--muted); }
.timer-btn.reset:hover { background: var(--border2); }
.timer-project-mini {
  font-size: 11px;
  color: var(--muted);
  max-width: 120px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

main { padding: 28px 32px; max-width: 1440px; margin: 0 auto; }
.view { display: none; }
.view.active { display: block; }

/* PAGE HEADER */
.page-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 24px; }
.page-title { font-family: 'Playfair Display', serif; font-size: 30px; font-weight: 900; color: var(--text); }
.page-sub { color: var(--muted); font-size: 12px; margin-top: 4px; }

/* BUTTONS */
.btn {
  background: var(--surface);
  border: 1.5px solid var(--border2);
  color: var(--text2);
  font-family: 'Plus Jakarta Sans', sans-serif;
  font-size: 12.5px;
  font-weight: 500;
  padding: 8px 16px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.15s;
  display: inline-flex; align-items: center; gap: 6px;
}
.btn:hover { border-color: var(--pink); color: var(--pink); background: var(--pink-light); }
.btn-primary { background: var(--pink); color: #fff; border-color: var(--pink); }
.btn-primary:hover { background: #c41268; color: #fff; border-color: #c41268; }
.btn-orange { background: var(--orange); color: #fff; border-color: var(--orange); }
.btn-orange:hover { background: #c2510a; color: #fff; }
.btn-green { background: var(--green); color: #fff; border-color: var(--green); }
.btn-green:hover { background: #166534; color: #fff; }
.btn-danger { border-color: #fca5a5; color: #dc2626; }
.btn-danger:hover { background: #fee2e2; border-color: #dc2626; }
.btn-sm { padding: 5px 10px; font-size: 11.5px; }
.btn-group { display: flex; gap: 8px; flex-wrap: wrap; }

/* CARDS */
.card {
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: 14px;
  padding: 24px;
  box-shadow: var(--shadow);
}
.card-title {
  font-family: 'Playfair Display', serif;
  font-size: 17px;
  font-weight: 700;
  margin-bottom: 18px;
  color: var(--text);
}

/* STAT CARDS */
.stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 24px; }
.stat-card {
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: 14px;
  padding: 22px;
  box-shadow: var(--shadow);
  position: relative;
  overflow: hidden;
}
.stat-card::after {
  content: '';
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 3px;
}
.stat-card.pink::after { background: var(--pink); }
.stat-card.orange::after { background: var(--orange); }
.stat-card.green::after { background: var(--green-mid); }
.stat-card.teal::after { background: #0891b2; }
.stat-label { color: var(--muted); font-size: 11px; font-weight: 600; letter-spacing: 0.8px; text-transform: uppercase; margin-bottom: 10px; }
.stat-value { font-family: 'Playfair Display', serif; font-size: 38px; font-weight: 900; line-height: 1; color: var(--text); }
.stat-sub { color: var(--muted); font-size: 11px; margin-top: 6px; }

/* DASHBOARD GRID */
.dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

/* BAR CHART */
.bar-chart { display: flex; flex-direction: column; gap: 10px; }
.bar-row { display: flex; align-items: center; gap: 10px; }
.bar-label { width: 110px; font-size: 11px; color: var(--muted); text-align: right; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.bar-track { flex: 1; background: var(--surface2); border-radius: 6px; height: 22px; overflow: hidden; border: 1px solid var(--border); }
.bar-fill { height: 100%; border-radius: 6px; transition: width 0.8s cubic-bezier(.4,0,.2,1); }
.bar-fill.pink { background: linear-gradient(90deg, var(--pink), #f472b6); }
.bar-fill.orange { background: linear-gradient(90deg, var(--orange), #fb923c); }
.bar-fill.green { background: linear-gradient(90deg, var(--green), #22c55e); }
.bar-val { width: 44px; font-size: 11px; color: var(--text2); font-weight: 600; text-align: right; }

/* RECENT ENTRIES */
.entry-list { display: flex; flex-direction: column; }
.entry-item { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border); }
.entry-item:last-child { border-bottom: none; }
.entry-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.entry-info { flex: 1; min-width: 0; }
.entry-project { font-size: 12.5px; font-weight: 500; }
.entry-meta { color: var(--muted); font-size: 11px; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.entry-hours { font-family: 'Playfair Display', serif; font-size: 18px; font-weight: 700; color: var(--pink); flex-shrink: 0; }

/* TIMESHEET */
.week-nav {
  display: flex; align-items: center; gap: 12px; margin-bottom: 20px;
  background: var(--surface); border: 1.5px solid var(--border);
  border-radius: 12px; padding: 14px 20px; box-shadow: var(--shadow);
}
.week-label { font-family: 'Playfair Display', serif; font-size: 18px; font-weight: 700; flex: 1; }
.week-hours { font-size: 13px; color: var(--muted); }
.week-hours strong { color: var(--orange); }

table { width: 100%; border-collapse: collapse; }
th {
  text-align: left; color: var(--muted);
  font-size: 11px; font-weight: 600; letter-spacing: 0.7px; text-transform: uppercase;
  padding: 12px 14px; background: var(--surface2);
  border-bottom: 1.5px solid var(--border);
}
td { padding: 11px 14px; border-bottom: 1px solid var(--border); vertical-align: middle; }
tr:last-child td { border-bottom: none; }
tbody tr:hover td { background: #fdf8ff; }
tfoot td { background: var(--surface2); font-weight: 600; }

.tag-pink { color: var(--pink); font-weight: 600; font-size: 12px; }
.tag-orange { color: var(--orange); font-weight: 600; }
.tag-green { color: var(--green); font-weight: 600; }
.amt { color: var(--green); font-weight: 500; }

/* FORMS */
input, select, textarea {
  background: var(--surface2);
  border: 1.5px solid var(--border);
  color: var(--text);
  font-family: 'Plus Jakarta Sans', sans-serif;
  font-size: 13px;
  padding: 9px 12px;
  border-radius: 8px;
  outline: none;
  transition: border-color 0.15s, box-shadow 0.15s;
  width: 100%;
}
input:focus, select:focus, textarea:focus {
  border-color: var(--pink);
  box-shadow: 0 0 0 3px rgba(232,24,122,0.08);
}
select option { background: #fff; }
.form-group { margin-bottom: 14px; }
.form-label { color: var(--text2); font-size: 11.5px; font-weight: 600; letter-spacing: 0.4px; text-transform: uppercase; margin-bottom: 6px; display: block; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }

/* MODAL */
.modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 200; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
.modal-overlay.open { display: flex; }
.modal { background: var(--surface); border: 1.5px solid var(--border); border-radius: 18px; padding: 32px; width: 560px; max-height: 88vh; overflow-y: auto; box-shadow: var(--shadow-lg); }
.modal-title { font-family: 'Playfair Display', serif; font-size: 22px; font-weight: 900; margin-bottom: 24px; color: var(--text); }
.modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border); }

/* STATUS */
.status-badge { font-size: 10.5px; font-weight: 600; padding: 3px 9px; border-radius: 20px; text-transform: uppercase; letter-spacing: 0.4px; }
.status-active { background: var(--green-light); color: var(--green); }
.status-inactive { background: var(--surface2); color: var(--muted); }

/* PROJECTS */
.projects-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(330px, 1fr)); gap: 16px; }
.project-card {
  background: var(--surface); border: 1.5px solid var(--border); border-radius: 14px; padding: 22px;
  box-shadow: var(--shadow); transition: all 0.2s; cursor: default;
}
.project-card:hover { border-color: var(--pink); box-shadow: 0 4px 20px rgba(232,24,122,0.1); transform: translateY(-1px); }
.project-code { color: var(--pink); font-size: 11px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; }
.project-name { font-family: 'Playfair Display', serif; font-size: 17px; font-weight: 700; margin: 4px 0 2px; }
.project-client { color: var(--muted); font-size: 12px; }
.project-rate { color: var(--green); font-weight: 600; font-size: 13px; margin-top: 10px; }
.task-pill { display: inline-block; background: var(--pink-light); color: var(--pink); border-radius: 20px; padding: 3px 10px; font-size: 11px; font-weight: 500; margin: 3px 3px 3px 0; }
.project-tasks { margin-top: 12px; border-top: 1px solid var(--border); padding-top: 12px; }
.project-card-footer { display: flex; align-items: center; justify-content: space-between; margin-top: 14px; border-top: 1px solid var(--border); padding-top: 12px; }

/* REPORTS */
.report-controls { background: var(--surface); border: 1.5px solid var(--border); border-radius: 12px; padding: 18px 22px; display: flex; gap: 14px; align-items: flex-end; margin-bottom: 20px; flex-wrap: wrap; box-shadow: var(--shadow); }
.report-controls .form-group { margin: 0; min-width: 150px; }

/* INVOICE */
.invoice-preview {
  background: #fff; border: 1.5px solid var(--border); border-radius: 14px;
  padding: 48px; max-width: 720px; margin: 0 auto; box-shadow: var(--shadow-lg);
  font-family: 'Plus Jakarta Sans', sans-serif;
}
.invoice-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 40px; }
.invoice-logo { font-family: 'Playfair Display', serif; font-size: 26px; font-weight: 900; color: var(--pink); }
.invoice-number { font-size: 12px; color: var(--muted); text-align: right; }
.invoice-number strong { display: block; font-family: 'Playfair Display', serif; font-size: 22px; color: var(--text); }
.invoice-parties { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 36px; }
.invoice-party-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); margin-bottom: 6px; }
.invoice-party-name { font-size: 16px; font-weight: 700; margin-bottom: 2px; }
.invoice-party-detail { font-size: 12px; color: var(--muted); line-height: 1.6; }
.invoice-table { width: 100%; border-collapse: collapse; margin-bottom: 24px; }
.invoice-table th { background: var(--pink); color: #fff; font-size: 11px; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; padding: 10px 14px; }
.invoice-table th:first-child { border-radius: 8px 0 0 8px; }
.invoice-table th:last-child { border-radius: 0 8px 8px 0; }
.invoice-table td { padding: 11px 14px; border-bottom: 1px solid var(--border); font-size: 13px; }
.invoice-table tfoot td { font-weight: 700; border-bottom: none; }
.invoice-totals { border-top: 2px solid var(--border); padding-top: 16px; max-width: 280px; margin-left: auto; }
.invoice-total-row { display: flex; justify-content: space-between; padding: 5px 0; font-size: 13px; }
.invoice-total-row.grand { font-size: 16px; font-weight: 700; color: var(--pink); border-top: 1.5px solid var(--border); margin-top: 8px; padding-top: 10px; }
.invoice-footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border); font-size: 11px; color: var(--muted); text-align: center; line-height: 1.8; }
.invoice-badge { display: inline-block; background: var(--orange-light); color: var(--orange); border-radius: 4px; padding: 2px 8px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
.invoiced-badge { display:inline-block; background: var(--green-light); color: var(--green); border-radius: 20px; padding: 2px 8px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; }
.invoice-history-row { display:flex; align-items:center; gap:12px; padding:12px 0; border-bottom:1px solid var(--border); }
.invoice-history-row:last-child { border-bottom:none; }
.inv-hist-num { font-weight:700; color:var(--pink); min-width:80px; }
.inv-hist-client { flex:1; font-size:12px; }
.inv-hist-amt { color:var(--green); font-weight:600; min-width:80px; text-align:right; }
.inv-hist-status { min-width:70px; text-align:right; }

/* CALENDAR */
.calendar-nav { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; background: var(--surface); border: 1.5px solid var(--border); border-radius: 12px; padding: 14px 20px; box-shadow: var(--shadow); }
.cal-month-label { font-family: 'Playfair Display', serif; font-size: 20px; font-weight: 900; flex: 1; }
.cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
.cal-header { text-align: center; font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase; padding: 8px 0; letter-spacing: 0.5px; }
.cal-day {
  background: var(--surface); border: 1.5px solid var(--border); border-radius: 10px;
  padding: 8px; min-height: 90px; cursor: pointer; transition: all 0.15s; position: relative;
}
.cal-day:hover { border-color: var(--pink); background: var(--pink-light); }
.cal-day.today { border-color: var(--pink); border-width: 2px; }
.cal-day.other-month { background: var(--surface2); opacity: 0.5; }
.cal-day.has-entries { background: #fff8fc; }
.cal-day-num { font-size: 12px; font-weight: 700; color: var(--text2); margin-bottom: 4px; }
.cal-day.today .cal-day-num { color: var(--pink); }
.cal-entry-dot { font-size: 10px; line-height: 1.4; color: var(--pink); font-weight: 500; }
.cal-day-total { position: absolute; bottom: 6px; right: 8px; font-size: 10px; font-weight: 700; color: var(--orange); }
.cal-legend { display: flex; gap: 16px; align-items: center; margin-top: 14px; font-size: 11px; color: var(--muted); }

/* TOAST */
.toast { position: fixed; bottom: 24px; right: 24px; background: var(--pink); color: #fff; padding: 12px 20px; border-radius: 10px; font-size: 13px; font-weight: 500; z-index: 999; transform: translateY(80px); opacity: 0; transition: all 0.3s cubic-bezier(.4,0,.2,1); box-shadow: 0 4px 16px rgba(232,24,122,0.3); }
.toast.show { transform: translateY(0); opacity: 1; }

.empty-state { text-align: center; padding: 60px 20px; color: var(--muted); }
.empty-state .icon { font-size: 44px; margin-bottom: 12px; }

/* PRINT */
@media print {
  header, .no-print { display: none !important; }
  body { background: white; }
  .invoice-preview { box-shadow: none; border: none; }
}
</style>
</head>
<body>

<header>
  <div class="logo"><span style="color:var(--text);font-size:15px;font-weight:700;letter-spacing:0">CWR Consulting</span> &nbsp; TimeTrack <span>Pro</span></div>
  <nav>
    <button class="active" onclick="showView('dashboard')">Dashboard</button>
    <button onclick="showView('timesheet')">Timesheet</button>
    <button onclick="showView('calendar')">Calendar</button>
    <button onclick="showView('projects')">Projects</button>
    <button onclick="showView('expenses')">Expenses</button>
    <button onclick="showView('reports')">Reports</button>
    <button onclick="showView('invoice')">Invoice</button>
  </nav>

  <!-- LIVE TIMER -->
  <div style="display:flex;align-items:center;gap:12px;">
    <div style="display:flex;align-items:center;gap:6px;">
      <span class="mode-label" id="mode-label">‚òÄÔ∏è</span>
      <button class="dark-toggle" id="dark-toggle" onclick="toggleDark()"></button>
    </div>
  <div class="timer-widget">
    <select id="timer-project-select" style="width:130px;font-size:11px;padding:5px 8px;border-radius:6px;" onchange="updateTimerProject()">
      <option value="">Pick project‚Ä¶</option>
    </select>
    <div class="timer-display" id="timer-display">00:00:00</div>
    <button class="timer-btn start" id="timer-start-btn" onclick="timerToggle()" title="Start">‚ñ∂</button>
    <button class="timer-btn reset" onclick="timerReset()" title="Reset">‚Ü∫</button>
    <button class="timer-btn stop" onclick="timerLog()" title="Log Time" style="font-size:11px;font-weight:700;width:auto;padding:0 8px;border-radius:6px;">Log</button>
  </div>
  </div>
</header>

<main>

<!-- DASHBOARD -->
<div class="view active" id="view-dashboard">
  <div class="page-header">
    <div>
      <div class="page-title">Good <span id="greeting-time"></span> üëã</div>
      <div class="page-sub" id="dash-date"></div>
    </div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="openAddEntry()">Ôºã Log Time</button>
      <button class="btn btn-orange" onclick="showView('invoice')">üßæ Create Invoice</button>
    </div>
  </div>

  <div class="stat-grid">
    <div class="stat-card pink">
      <div class="stat-label">Hours This Week</div>
      <div class="stat-value" id="stat-week">0.0</div>
      <div class="stat-sub">of 40 target hours</div>
    </div>
    <div class="stat-card orange">
      <div class="stat-label">Billable This Month</div>
      <div class="stat-value" id="stat-billable">$0</div>
      <div class="stat-sub" id="stat-billable-hrs">0 hrs logged</div>
    </div>
    <div class="stat-card green">
      <div class="stat-label">Active Projects</div>
      <div class="stat-value" id="stat-projects">0</div>
      <div class="stat-sub">currently tracked</div>
    </div>
    <div class="stat-card teal">
      <div class="stat-label">Hours This Month</div>
      <div class="stat-value" id="stat-month">0.0</div>
      <div class="stat-sub">total logged</div>
    </div>
  </div>

  <div class="dash-grid">
    <div class="card">
      <div class="card-title">Hours by Project</div>
      <div class="bar-chart" id="chart-projects"></div>
    </div>
    <div class="card">
      <div class="card-title">Recent Entries</div>
      <div class="entry-list" id="recent-entries"></div>
    </div>
  </div>
</div>

<!-- TIMESHEET -->
<div class="view" id="view-timesheet">
  <div class="page-header">
    <div><div class="page-title">Timesheet</div><div class="page-sub">Daily time log</div></div>
    <button class="btn btn-primary" onclick="openAddEntry()">Ôºã Add Entry</button>
  </div>
  <div class="week-nav">
    <button class="btn" onclick="prevWeek()">‚Üê Prev</button>
    <div class="week-label" id="week-label"></div>
    <span class="week-hours">Total: <strong id="week-total-hrs">0h</strong></span>
    <button class="btn" onclick="nextWeek()">Next ‚Üí</button>
    <button class="btn btn-primary" onclick="goToday()">Today</button>
  </div>
  <div class="card" style="padding:0;overflow:hidden;">
    <table>
      <thead><tr>
        <th>Date</th><th>Project</th><th>Task</th><th>Description</th>
        <th>Hours</th><th>Rate</th><th>Amount</th><th>Status</th><th></th>
      </tr></thead>
      <tbody id="timesheet-body"></tbody>
      <tfoot id="timesheet-foot"></tfoot>
    </table>
  </div>
</div>

<!-- CALENDAR -->
<div class="view" id="view-calendar">
  <div class="page-header">
    <div><div class="page-title">Calendar View</div><div class="page-sub">Monthly overview of your time</div></div>
    <button class="btn btn-primary" onclick="openAddEntry()">Ôºã Add Entry</button>
  </div>
  <div class="calendar-nav">
    <button class="btn" onclick="prevMonth()">‚Üê Prev</button>
    <div class="cal-month-label" id="cal-month-label"></div>
    <button class="btn" onclick="nextMonth()">Next ‚Üí</button>
    <button class="btn btn-primary" onclick="goCalToday()">Today</button>
  </div>
  <div class="card" style="padding:16px;">
    <div class="cal-grid" id="cal-header-row"></div>
    <div class="cal-grid" id="cal-grid" style="margin-top:4px;"></div>
    <div class="cal-legend">
      <span>üíó = time entry</span>
      <span style="color:var(--orange)">üü† = daily total</span>
    </div>
  </div>
</div>

<!-- PROJECTS -->
<div class="view" id="view-projects">
  <div class="page-header">
    <div><div class="page-title">Projects & Tasks</div><div class="page-sub">Manage project codes and rates</div></div>
    <button class="btn btn-primary" onclick="openAddProject()">Ôºã New Project</button>
  </div>
  <div class="projects-grid" id="projects-grid"></div>
</div>

<!-- REPORTS -->
<div class="view" id="view-reports">
  <div class="page-header">
    <div><div class="page-title">Reports</div><div class="page-sub">Analyze and export your hours</div></div>
    <div class="btn-group">
      <button class="btn btn-green" onclick="exportCSV()">‚¨á Export CSV</button>
      <button class="btn btn-orange" onclick="exportTimeQB()">‚¨á QuickBooks Export</button>
    </div>
  </div>
  <div class="report-controls">
    <div class="form-group"><label class="form-label">From</label><input type="date" id="report-from"></div>
    <div class="form-group"><label class="form-label">To</label><input type="date" id="report-to"></div>
    <div class="form-group">
      <label class="form-label">Project</label>
      <select id="report-project"><option value="">All Projects</option></select>
    </div>
    <div class="form-group">
      <label class="form-label">Group By</label>
      <select id="report-group">
        <option value="project">Project</option>
        <option value="task">Task</option>
        <option value="date">Date</option>
      </select>
    </div>
    <button class="btn btn-primary" onclick="runReport()">Run Report</button>
  </div>
  <div class="card" style="padding:0;overflow:hidden;">
    <table>
      <thead><tr><th>Group</th><th>Project</th><th>Task</th><th>Hours</th><th>Rate</th><th>Billable Amount</th></tr></thead>
      <tbody id="report-body"></tbody>
      <tfoot id="report-foot"></tfoot>
    </table>
  </div>
</div>

<!-- INVOICE -->
<div class="view" id="view-invoice">
  <div class="page-header no-print">
    <div><div class="page-title">Invoice Generator</div><div class="page-sub">Create professional invoices from your time entries</div></div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="buildInvoice()">üîÑ Generate Invoice</button>
      <button class="btn btn-orange" onclick="window.print()">üñ® Print / PDF</button>
    </div>
  </div>

  <div class="card no-print" style="margin-bottom:20px;">
    <div class="card-title">Invoice Settings</div>
    <div class="form-row-3">
      <div class="form-group">
        <label class="form-label">Invoice #</label>
        <div style="display:flex;gap:6px;align-items:center">
          <input type="text" id="inv-number" readonly style="background:var(--surface2);cursor:default;font-weight:700;color:var(--pink)">
          <button class="btn btn-sm" onclick="manualInvNum()" title="Edit manually" style="white-space:nowrap">‚úèÔ∏è Edit</button>
        </div>
      </div>
      <div class="form-group"><label class="form-label">Invoice Date</label><input type="date" id="inv-date"></div>
      <div class="form-group"><label class="form-label">Due Date</label><input type="date" id="inv-due"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Your Name / Company</label><input type="text" id="inv-from-name" placeholder="Your Name or Company"></div>
      <div class="form-group"><label class="form-label">Your Address / Contact</label><input type="text" id="inv-from-addr" placeholder="City, State ¬∑ email@example.com"></div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Bill To Project</label>
        <select id="inv-project"><option value="">Select project‚Ä¶</option></select>
      </div>
      <div class="form-group"><label class="form-label">Date Range</label>
        <div style="display:flex;gap:8px;">
          <input type="date" id="inv-from" style="flex:1">
          <input type="date" id="inv-to" style="flex:1">
        </div>
      </div>
    </div>
    <div class="form-row-3">
      <div class="form-group"><label class="form-label">Tax Rate (%)</label><input type="number" id="inv-tax" value="0" min="0" max="100" step="0.1"></div>
      <div class="form-group"><label class="form-label">Payment Terms</label><input type="text" id="inv-terms" value="Net 30 days"></div>
      <div class="form-group"><label class="form-label">Notes</label><input type="text" id="inv-notes" placeholder="Thank you for your business!"></div>
    </div>
  </div>

  <div id="invoice-preview-area"></div>

  <!-- INVOICE HISTORY -->
  <div class="card no-print" style="margin-top:24px;" id="invoice-history-card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <div class="card-title" style="margin:0">Invoice History</div>
      <span style="font-size:11px;color:var(--muted)">Invoices marked as sent are tracked here</span>
    </div>
    <div id="invoice-history-list"></div>
  </div>
</div>

<!-- EXPENSES -->
<div class="view" id="view-expenses">
  <div class="page-header">
    <div><div class="page-title">Expense Tracking</div><div class="page-sub">Log and manage reimbursable expenses</div></div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="openAddExpense()">Ôºã Add Expense</button>
      <button class="btn btn-green" onclick="exportExpensesCSV()">‚¨á Export CSV</button>
      <button class="btn btn-orange" onclick="exportExpensesQB()">‚¨á QuickBooks Export</button>
    </div>
  </div>

  <!-- Expense Stats -->
  <div class="stat-grid" style="grid-template-columns:repeat(3,1fr);margin-bottom:20px;">
    <div class="stat-card pink">
      <div class="stat-label">This Month</div>
      <div class="stat-value" id="exp-stat-month">$0</div>
      <div class="stat-sub">total expenses</div>
    </div>
    <div class="stat-card orange">
      <div class="stat-label">Unreimbursed</div>
      <div class="stat-value" id="exp-stat-unreimb">$0</div>
      <div class="stat-sub">pending reimbursement</div>
    </div>
    <div class="stat-card green">
      <div class="stat-label">Billable to Clients</div>
      <div class="stat-value" id="exp-stat-billable">$0</div>
      <div class="stat-sub">pass-through expenses</div>
    </div>
  </div>

  <!-- Filters -->
  <div class="report-controls" style="margin-bottom:16px;">
    <div class="form-group"><label class="form-label">From</label><input type="date" id="exp-filter-from"></div>
    <div class="form-group"><label class="form-label">To</label><input type="date" id="exp-filter-to"></div>
    <div class="form-group"><label class="form-label">Project</label>
      <select id="exp-filter-project"><option value="">All Projects</option></select>
    </div>
    <div class="form-group"><label class="form-label">Category</label>
      <select id="exp-filter-cat">
        <option value="">All Categories</option>
        <option>Travel</option><option>Meals</option><option>Software</option>
        <option>Office Supplies</option><option>Subcontractor</option><option>Other</option>
      </select>
    </div>
    <button class="btn btn-primary" onclick="renderExpenses()">Filter</button>
  </div>

  <div class="card" style="padding:0;overflow:hidden;">
    <table>
      <thead><tr>
        <th>Date</th><th>Vendor / Description</th><th>Category</th><th>Project</th>
        <th>Amount</th><th>Billable</th><th>Reimbursed</th><th>Receipt</th><th></th>
      </tr></thead>
      <tbody id="expenses-body"></tbody>
      <tfoot id="expenses-foot"></tfoot>
    </table>
  </div>
</div>

</main>

<!-- ADD EXPENSE MODAL -->
<div class="modal-overlay" id="modal-expense">
  <div class="modal">
    <div class="modal-title">Add Expense</div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Date</label><input type="date" id="exp-date"></div>
      <div class="form-group"><label class="form-label">Amount ($)</label><input type="number" id="exp-amount" step="0.01" placeholder="0.00"></div>
    </div>
    <div class="form-group"><label class="form-label">Vendor / Description</label><input type="text" id="exp-vendor" placeholder="e.g. Delta Airlines, AWS, Office Depot"></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Category</label>
        <select id="exp-category">
          <option>Travel</option><option>Meals</option><option>Software</option>
          <option>Office Supplies</option><option>Subcontractor</option><option>Other</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">Project (optional)</label>
        <select id="exp-project"><option value="">None / General</option></select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Billable to Client?</label>
        <select id="exp-billable"><option value="yes">Yes ‚Äî Bill to client</option><option value="no">No ‚Äî Internal cost</option></select>
      </div>
      <div class="form-group"><label class="form-label">Reimbursed?</label>
        <select id="exp-reimbursed"><option value="no">No ‚Äî Pending</option><option value="yes">Yes ‚Äî Reimbursed</option></select>
      </div>
    </div>
    <div class="form-group"><label class="form-label">Receipt / Notes</label>
      <input type="text" id="exp-receipt" placeholder="Receipt #, notes, or reference"></div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal('modal-expense')">Cancel</button>
      <button class="btn btn-primary" onclick="saveExpense()">Save Expense</button>
    </div>
  </div>
</div>
<div class="modal-overlay" id="modal-entry">
  <div class="modal">
    <div class="modal-title">Log Time Entry</div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Date</label><input type="date" id="entry-date"></div>
      <div class="form-group"><label class="form-label">Hours</label><input type="number" id="entry-hours" min="0.25" max="24" step="0.25" placeholder="0.00"></div>
    </div>
    <div class="form-group"><label class="form-label">Project</label>
      <select id="entry-project" onchange="populateTasks()"><option value="">Select project‚Ä¶</option></select>
    </div>
    <div class="form-group"><label class="form-label">Task</label>
      <select id="entry-task"><option value="">Select task‚Ä¶</option></select>
    </div>
    <div class="form-group"><label class="form-label">Description</label>
      <textarea id="entry-desc" rows="3" placeholder="What did you work on?"></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal('modal-entry')">Cancel</button>
      <button class="btn btn-primary" onclick="saveEntry()">Save Entry</button>
    </div>
  </div>
</div>

<!-- ADD PROJECT MODAL -->
<div class="modal-overlay" id="modal-project">
  <div class="modal">
    <div class="modal-title">New Project</div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Project Code</label><input type="text" id="proj-code" placeholder="e.g. PROJ-001"></div>
      <div class="form-group"><label class="form-label">Billing Rate ($/hr)</label><input type="number" id="proj-rate" placeholder="150.00" step="0.01"></div>
    </div>
    <div class="form-group"><label class="form-label">Project Name</label><input type="text" id="proj-name" placeholder="Full project name"></div>
    <div class="form-group"><label class="form-label">Client Name</label><input type="text" id="proj-client" placeholder="Client or company name"></div>
    <div class="form-group"><label class="form-label">Client Address / Contact</label><input type="text" id="proj-client-addr" placeholder="City, State or email"></div>
    <div class="form-group"><label class="form-label">Tasks (comma-separated)</label><input type="text" id="proj-tasks" placeholder="Analysis, Design, Development, Review"></div>
    <div class="form-group"><label class="form-label">Status</label>
      <select id="proj-status"><option value="active">Active</option><option value="inactive">Inactive</option></select>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal('modal-project')">Cancel</button>
      <button class="btn btn-primary" onclick="saveProject()">Create Project</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ============ DATA ============
let projects = JSON.parse(localStorage.getItem('tt2_projects') || '[]');
let entries = JSON.parse(localStorage.getItem('tt2_entries') || '[]');
let invoiceHistory = JSON.parse(localStorage.getItem('tt2_invoices') || '[]');
let invoiceCounter = parseInt(localStorage.getItem('tt2_inv_counter') || '1');
let expenses = JSON.parse(localStorage.getItem('tt2_expenses') || '[]');

// ============ DARK MODE ============
function toggleDark() {
  document.body.classList.toggle('dark');
  const on = document.body.classList.contains('dark');
  document.getElementById('dark-toggle').classList.toggle('on', on);
  document.getElementById('mode-label').textContent = on ? 'üåô' : '‚òÄÔ∏è';
  localStorage.setItem('tt2_dark', on ? '1' : '0');
}
if (localStorage.getItem('tt2_dark') === '1') {
  document.body.classList.add('dark');
  document.getElementById('dark-toggle').classList.add('on');
  document.getElementById('mode-label').textContent = 'üåô';
}

function nextInvNum() {
  const num = String(invoiceCounter).padStart(3,'0');
  return `CWR-${new Date().getFullYear()}-${num}`;
}
function bumpInvCounter() {
  invoiceCounter++;
  localStorage.setItem('tt2_inv_counter', invoiceCounter);
}
function saveInvHistory() { localStorage.setItem('tt2_invoices', JSON.stringify(invoiceHistory)); }

if (projects.length === 0) {
  projects = [
    { id: 'p1', code: 'ACME-001', name: 'ACME Corp Website Redesign', client: 'ACME Corporation', clientAddr: 'New York, NY', rate: 175, tasks: ['Discovery','UX Design','Development','QA','Launch'], status: 'active' },
    { id: 'p2', code: 'BETA-002', name: 'Beta Systems ERP Integration', client: 'Beta Systems LLC', clientAddr: 'Chicago, IL', rate: 200, tasks: ['Requirements','Architecture','Development','Testing','Documentation'], status: 'active' },
    { id: 'p3', code: 'GEN-003', name: 'General Consulting', client: 'Various', clientAddr: '', rate: 150, tasks: ['Strategy','Advisory','Analysis','Reporting'], status: 'active' },
  ];
  sp();
}
if (entries.length === 0) {
  const today = new Date();
  const d = n => { const dt = new Date(today); dt.setDate(dt.getDate()+n); return dt.toISOString().split('T')[0]; };
  entries = [
    { id:'e1', date:d(-6), projectId:'p1', task:'Discovery', desc:'Stakeholder interviews and requirements gathering', hours:4.5 },
    { id:'e2', date:d(-6), projectId:'p3', task:'Strategy', desc:'Market analysis report', hours:2 },
    { id:'e3', date:d(-5), projectId:'p1', task:'UX Design', desc:'Wireframes for homepage and product pages', hours:6 },
    { id:'e4', date:d(-4), projectId:'p2', task:'Requirements', desc:'ERP requirements documentation', hours:5 },
    { id:'e5', date:d(-4), projectId:'p2', task:'Architecture', desc:'System architecture review', hours:3 },
    { id:'e6', date:d(-3), projectId:'p1', task:'Development', desc:'Frontend component library setup', hours:7 },
    { id:'e7', date:d(-2), projectId:'p3', task:'Advisory', desc:'Client advisory call and follow-up', hours:2.5 },
    { id:'e8', date:d(-1), projectId:'p2', task:'Development', desc:'API integration module', hours:8 },
    { id:'e9', date:d(0), projectId:'p1', task:'UX Design', desc:'Mobile responsive design iterations', hours:5 },
    { id:'e10', date:d(0), projectId:'p2', task:'Testing', desc:'Integration test scenarios', hours:3 },
  ];
  se();
}

function sp() { localStorage.setItem('tt2_projects', JSON.stringify(projects)); }
function se() { localStorage.setItem('tt2_entries', JSON.stringify(entries)); }
function gp(id) { return projects.find(p => p.id === id); }

// ============ TIMER ============
let timerSec = 0, timerRunning = false, timerInterval = null, timerProjectId = '';

function populateTimerProjects() {
  const sel = document.getElementById('timer-project-select');
  sel.innerHTML = '<option value="">Pick project‚Ä¶</option>' +
    projects.filter(p=>p.status==='active').map(p=>`<option value="${p.id}">${p.code}</option>`).join('');
}
function updateTimerProject() { timerProjectId = document.getElementById('timer-project-select').value; }
function timerToggle() {
  if (timerRunning) {
    clearInterval(timerInterval); timerRunning = false;
    document.getElementById('timer-start-btn').textContent = '‚ñ∂';
    document.getElementById('timer-start-btn').className = 'timer-btn start';
    document.getElementById('timer-display').classList.remove('running');
  } else {
    timerRunning = true;
    document.getElementById('timer-start-btn').textContent = '‚è∏';
    document.getElementById('timer-start-btn').className = 'timer-btn stop';
    document.getElementById('timer-display').classList.add('running');
    timerInterval = setInterval(() => {
      timerSec++;
      const h = String(Math.floor(timerSec/3600)).padStart(2,'0');
      const m = String(Math.floor((timerSec%3600)/60)).padStart(2,'0');
      const s = String(timerSec%60).padStart(2,'0');
      document.getElementById('timer-display').textContent = `${h}:${m}:${s}`;
    }, 1000);
  }
}
function timerReset() {
  if (timerRunning) timerToggle();
  timerSec = 0;
  document.getElementById('timer-display').textContent = '00:00:00';
  document.getElementById('timer-display').classList.remove('running');
}
function timerLog() {
  if (timerSec < 60) { showToast('Timer needs at least 1 minute to log'); return; }
  const hours = Math.round((timerSec / 3600) * 4) / 4;
  if (!timerProjectId) { showToast('Please select a project for the timer'); return; }
  if (timerRunning) timerToggle();
  document.getElementById('entry-date').value = new Date().toISOString().split('T')[0];
  document.getElementById('entry-hours').value = hours;
  populateProjectSelect('entry-project');
  document.getElementById('entry-project').value = timerProjectId;
  populateTasks();
  document.getElementById('entry-desc').value = '';
  document.getElementById('modal-entry').classList.add('open');
  timerReset();
}

// ============ NAV ============
let calDate = new Date();

function showView(id) {
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  document.getElementById('view-'+id).classList.add('active');
  const labels = ['dashboard','timesheet','calendar','projects','expenses','reports','invoice'];
  const idx = labels.indexOf(id);
  if (idx >= 0) document.querySelectorAll('nav button')[idx].classList.add('active');
  if (id==='dashboard') renderDashboard();
  if (id==='timesheet') renderTimesheet();
  if (id==='calendar') renderCalendar();
  if (id==='projects') renderProjects();
  if (id==='expenses') initExpenses();
  if (id==='reports') { initReports(); runReport(); }
  if (id==='invoice') initInvoice();
}

// ============ DASHBOARD ============
function renderDashboard() {
  const now = new Date();
  const h = now.getHours();
  document.getElementById('greeting-time').textContent = h < 12 ? 'morning' : h < 17 ? 'afternoon' : 'evening';
  document.getElementById('dash-date').textContent = now.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});

  const ws = getWeekStart(now);
  const we = new Date(ws); we.setDate(we.getDate()+6);
  const ms = new Date(now.getFullYear(), now.getMonth(), 1);
  const me = new Date(now.getFullYear(), now.getMonth()+1, 0);
  const wsStr = ws.toISOString().split('T')[0];
  const weStr = we.toISOString().split('T')[0];
  const msStr = ms.toISOString().split('T')[0];
  const meStr = me.toISOString().split('T')[0];

  const wkE = entries.filter(e=>e.date>=wsStr&&e.date<=weStr);
  const moE = entries.filter(e=>e.date>=msStr&&e.date<=meStr);
  const wkH = wkE.reduce((s,e)=>s+e.hours,0);
  const moH = moE.reduce((s,e)=>s+e.hours,0);
  const bill = moE.reduce((s,e)=>{const p=gp(e.projectId);return s+(p?e.hours*p.rate:0);},0);
  const activeP = projects.filter(p=>p.status==='active').length;

  document.getElementById('stat-week').textContent = wkH.toFixed(1);
  document.getElementById('stat-billable').textContent = '$'+Math.round(bill).toLocaleString();
  document.getElementById('stat-billable-hrs').textContent = moH.toFixed(1)+' hrs logged';
  document.getElementById('stat-projects').textContent = activeP;
  document.getElementById('stat-month').textContent = moH.toFixed(1);

  const byProj = {};
  entries.forEach(e=>{const p=gp(e.projectId);if(!p)return;byProj[p.name]=(byProj[p.name]||0)+e.hours;});
  const sorted = Object.entries(byProj).sort((a,b)=>b[1]-a[1]);
  const maxH = sorted[0]?.[1]||1;
  const colors = ['pink','orange','green'];
  document.getElementById('chart-projects').innerHTML = sorted.length ? sorted.map(([name,hrs],i)=>`
    <div class="bar-row">
      <div class="bar-label" title="${name}">${name}</div>
      <div class="bar-track"><div class="bar-fill ${colors[i%3]}" style="width:${(hrs/maxH*100).toFixed(1)}%"></div></div>
      <div class="bar-val">${hrs.toFixed(1)}h</div>
    </div>`).join('') : '<div style="color:var(--muted)">No data yet</div>';

  const recent = [...entries].sort((a,b)=>b.date.localeCompare(a.date)).slice(0,6);
  const dotColors = ['var(--pink)','var(--orange)','var(--green)'];
  document.getElementById('recent-entries').innerHTML = recent.length ? recent.map((e,i)=>{
    const p=gp(e.projectId);
    return `<div class="entry-item">
      <div class="entry-dot" style="background:${dotColors[i%3]}"></div>
      <div class="entry-info">
        <div class="entry-project"><span style="color:var(--pink);font-weight:700">${p?p.code:'?'}</span> ‚Äî ${e.task}</div>
        <div class="entry-meta">${fmtDate(e.date)} ¬∑ ${e.desc.substring(0,52)}${e.desc.length>52?'‚Ä¶':''}</div>
      </div>
      <div class="entry-hours">${e.hours}h</div>
    </div>`;
  }).join('') : '<div class="empty-state"><div class="icon">üìã</div>No entries yet</div>';
}

// ============ TIMESHEET ============
let currentWeek = new Date();

function getWeekStart(d) {
  const dt = new Date(d); const day = dt.getDay();
  dt.setDate(dt.getDate() - day + (day===0?-6:1)); dt.setHours(0,0,0,0); return dt;
}

function renderTimesheet() {
  const ws = getWeekStart(currentWeek);
  const we = new Date(ws); we.setDate(we.getDate()+6);
  const wsStr = ws.toISOString().split('T')[0];
  const weStr = we.toISOString().split('T')[0];
  document.getElementById('week-label').textContent = `Week of ${ws.toLocaleDateString('en-US',{month:'short',day:'numeric'})} ‚Äì ${we.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}`;

  const wkE = entries.filter(e=>e.date>=wsStr&&e.date<=weStr).sort((a,b)=>a.date.localeCompare(b.date));
  let totH=0, totA=0;
  document.getElementById('timesheet-body').innerHTML = wkE.length ? wkE.map(e=>{
    const p=gp(e.projectId); const amt=p?e.hours*p.rate:0;
    totH+=e.hours; totA+=amt;
    const invoicedBadge = e.invoiced ? `<span class="invoiced-badge">‚úì Invoiced</span>` : `<button class="btn btn-sm" onclick="markInvoiced('${e.id}')" style="font-size:10px;padding:3px 8px;border-color:var(--green);color:var(--green)" title="Mark as invoiced">Mark Invoiced</button>`;
    const rowStyle = e.invoiced ? 'opacity:0.6' : '';
    return `<tr style="${rowStyle}">
      <td style="color:var(--muted);white-space:nowrap">${fmtDate(e.date)}</td>
      <td><span class="tag-pink">${p?p.code:'?'}</span> <span style="color:var(--text2)">${p?p.name:'Unknown'}</span></td>
      <td><span style="background:var(--orange-light);color:var(--orange);border-radius:20px;padding:2px 8px;font-size:11px;font-weight:600">${e.task}</span></td>
      <td style="color:var(--muted);max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${e.desc}</td>
      <td class="tag-pink">${e.hours}h</td>
      <td style="color:var(--muted)">$${p?p.rate:0}/hr</td>
      <td class="amt">$${amt.toFixed(2)}</td>
      <td>${invoicedBadge}</td>
      <td><button class="btn btn-sm btn-danger" onclick="deleteEntry('${e.id}')">‚úï</button></td>
    </tr>`;
  }).join('') : `<tr><td colspan="9"><div class="empty-state"><div class="icon">‚è±</div>No entries this week. <a href="#" onclick="openAddEntry()" style="color:var(--pink)">Add one?</a></div></td></tr>`;

  document.getElementById('week-total-hrs').textContent = totH.toFixed(1)+'h';
  document.getElementById('timesheet-foot').innerHTML = wkE.length ? `<tr>
    <td colspan="4" style="font-weight:600">Week Total</td>
    <td class="tag-pink">${totH.toFixed(1)}h</td><td></td>
    <td class="amt">$${totA.toFixed(2)}</td><td></td><td></td>
  </tr>` : '';
}

function prevWeek(){currentWeek.setDate(currentWeek.getDate()-7);renderTimesheet();}
function nextWeek(){currentWeek.setDate(currentWeek.getDate()+7);renderTimesheet();}
function goToday(){currentWeek=new Date();renderTimesheet();}

// ============ CALENDAR ============
function renderCalendar() {
  const y = calDate.getFullYear(), m = calDate.getMonth();
  document.getElementById('cal-month-label').textContent = calDate.toLocaleDateString('en-US',{month:'long',year:'numeric'});

  const days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  document.getElementById('cal-header-row').innerHTML = days.map(d=>`<div class="cal-header">${d}</div>`).join('');

  const first = new Date(y, m, 1);
  const last = new Date(y, m+1, 0);
  let startDow = first.getDay() - 1; if (startDow < 0) startDow = 6;

  const cells = [];
  for (let i=0;i<startDow;i++) {
    const dt = new Date(y, m, 1-startDow+i);
    cells.push({date:dt, other:true});
  }
  for (let i=1;i<=last.getDate();i++) cells.push({date:new Date(y,m,i), other:false});
  while (cells.length % 7 !== 0) {
    const dt = new Date(y, m+1, cells.length - last.getDate() - startDow + 1);
    cells.push({date:dt, other:true});
  }

  const todayStr = new Date().toISOString().split('T')[0];
  const entryMap = {};
  entries.forEach(e => {
    if (!entryMap[e.date]) entryMap[e.date] = [];
    entryMap[e.date].push(e);
  });

  document.getElementById('cal-grid').innerHTML = cells.map(cell => {
    const ds = cell.date.toISOString().split('T')[0];
    const dayEntries = entryMap[ds] || [];
    const total = dayEntries.reduce((s,e)=>s+e.hours,0);
    const isToday = ds === todayStr;
    const dots = dayEntries.slice(0,3).map(e=>{
      const p=gp(e.projectId);
      return `<div class="cal-entry-dot" title="${p?p.code:'?'}: ${e.task} (${e.hours}h)">üíó ${p?p.code:'?'}</div>`;
    }).join('');
    return `<div class="cal-day${cell.other?' other-month':''}${isToday?' today':''}${dayEntries.length?' has-entries':''}" onclick="calDayClick('${ds}')">
      <div class="cal-day-num">${cell.date.getDate()}</div>
      ${dots}
      ${total > 0 ? `<div class="cal-day-total">${total}h</div>` : ''}
    </div>`;
  }).join('');
}

function calDayClick(dateStr) {
  document.getElementById('entry-date').value = dateStr;
  populateProjectSelect('entry-project');
  document.getElementById('entry-hours').value = '';
  document.getElementById('entry-task').innerHTML = '<option value="">Select task‚Ä¶</option>';
  document.getElementById('entry-desc').value = '';
  document.getElementById('modal-entry').classList.add('open');
}
function prevMonth(){calDate.setMonth(calDate.getMonth()-1);renderCalendar();}
function nextMonth(){calDate.setMonth(calDate.getMonth()+1);renderCalendar();}
function goCalToday(){calDate=new Date();renderCalendar();}

// ============ PROJECTS ============
function renderProjects() {
  const grid = document.getElementById('projects-grid');
  grid.innerHTML = projects.length ? projects.map(p=>`
    <div class="project-card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div>
          <div class="project-code">${p.code}</div>
          <div class="project-name">${p.name}</div>
          <div class="project-client">${p.client}</div>
        </div>
        <span class="status-badge status-${p.status}">${p.status}</span>
      </div>
      <div class="project-rate">$${p.rate}/hr</div>
      <div class="project-tasks">${p.tasks.map(t=>`<span class="task-pill">${t}</span>`).join('')}</div>
      <div class="project-card-footer">
        <div style="font-size:11px;color:var(--muted)">${entries.filter(e=>e.projectId===p.id).reduce((s,e)=>s+e.hours,0).toFixed(1)} hrs logged</div>
        <div class="btn-group">
          <button class="btn btn-sm" onclick="toggleProject('${p.id}')">${p.status==='active'?'Pause':'Activate'}</button>
          <button class="btn btn-sm btn-danger" onclick="deleteProject('${p.id}')">Delete</button>
        </div>
      </div>
    </div>`).join('') :
    `<div class="empty-state" style="grid-column:1/-1"><div class="icon">üìÅ</div>No projects yet. Create your first project!</div>`;
}

function openAddProject() {
  ['proj-code','proj-name','proj-client','proj-client-addr','proj-tasks','proj-rate'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('proj-status').value='active';
  document.getElementById('modal-project').classList.add('open');
}
function saveProject() {
  const code=document.getElementById('proj-code').value.trim();
  const name=document.getElementById('proj-name').value.trim();
  const client=document.getElementById('proj-client').value.trim();
  const clientAddr=document.getElementById('proj-client-addr').value.trim();
  const tasks=document.getElementById('proj-tasks').value.split(',').map(t=>t.trim()).filter(Boolean);
  const rate=parseFloat(document.getElementById('proj-rate').value);
  const status=document.getElementById('proj-status').value;
  if(!code||!name||!rate||tasks.length===0){showToast('Please fill all required fields');return;}
  projects.push({id:'p'+Date.now(),code,name,client,clientAddr,rate,tasks,status});
  sp(); closeModal('modal-project'); renderProjects(); showToast('Project created!');
}
function toggleProject(id){const p=projects.find(p=>p.id===id);if(p){p.status=p.status==='active'?'inactive':'active';sp();renderProjects();}}
function deleteProject(id){projects=projects.filter(p=>p.id!==id);sp();renderProjects();showToast('Project deleted');}

// ============ ENTRY ============
function openAddEntry() {
  populateProjectSelect('entry-project');
  document.getElementById('entry-date').value=new Date().toISOString().split('T')[0];
  document.getElementById('entry-hours').value='';
  document.getElementById('entry-task').innerHTML='<option value="">Select task‚Ä¶</option>';
  document.getElementById('entry-desc').value='';
  document.getElementById('modal-entry').classList.add('open');
}
function populateProjectSelect(selId) {
  document.getElementById(selId).innerHTML='<option value="">Select project‚Ä¶</option>'+
    projects.filter(p=>p.status==='active').map(p=>`<option value="${p.id}">${p.code} ‚Äî ${p.name}</option>`).join('');
}
function populateTasks() {
  const p=gp(document.getElementById('entry-project').value);
  document.getElementById('entry-task').innerHTML=p?p.tasks.map(t=>`<option value="${t}">${t}</option>`).join(''):'<option value="">Select task‚Ä¶</option>';
}
function saveEntry() {
  const date=document.getElementById('entry-date').value;
  const hours=parseFloat(document.getElementById('entry-hours').value);
  const projectId=document.getElementById('entry-project').value;
  const task=document.getElementById('entry-task').value;
  const desc=document.getElementById('entry-desc').value;
  if(!date||!hours||!projectId||!task){showToast('Please fill all required fields');return;}
  entries.push({id:'e'+Date.now(),date,projectId,task,desc,hours});
  se(); closeModal('modal-entry');
  const activeView=document.querySelector('.view.active').id;
  if(activeView==='view-timesheet')renderTimesheet();
  if(activeView==='view-calendar')renderCalendar();
  if(activeView==='view-dashboard')renderDashboard();
  showToast('Entry saved! ‚úì');
}
function deleteEntry(id){entries=entries.filter(e=>e.id!==id);se();renderTimesheet();showToast('Entry deleted');}
function markInvoiced(id) {
  const e = entries.find(e=>e.id===id);
  if(e) { e.invoiced=true; e.invoicedDate=new Date().toISOString().split('T')[0]; se(); renderTimesheet(); showToast('Entry marked as invoiced ‚úì'); }
}
function manualInvNum() {
  const current = document.getElementById('inv-number').value;
  const val = prompt('Enter invoice number:', current);
  if(val) { document.getElementById('inv-number').value = val; document.getElementById('inv-number').readOnly = false; }
}

// ============ REPORTS ============
function initReports() {
  const today=new Date();
  document.getElementById('report-from').value=new Date(today.getFullYear(),today.getMonth(),1).toISOString().split('T')[0];
  document.getElementById('report-to').value=today.toISOString().split('T')[0];
  document.getElementById('report-project').innerHTML='<option value="">All Projects</option>'+
    projects.map(p=>`<option value="${p.id}">${p.code} ‚Äî ${p.name}</option>`).join('');
}
function runReport() {
  const from=document.getElementById('report-from').value;
  const to=document.getElementById('report-to').value;
  const pid=document.getElementById('report-project').value;
  const groupBy=document.getElementById('report-group').value;
  let filtered=entries.filter(e=>e.date>=from&&e.date<=to);
  if(pid)filtered=filtered.filter(e=>e.projectId===pid);

  const groups={};
  filtered.forEach(e=>{
    const p=gp(e.projectId);
    const key=groupBy==='project'?(p?p.name:'Unknown'):groupBy==='task'?e.task:e.date;
    if(!groups[key])groups[key]={entries:[],project:p};
    groups[key].entries.push(e);
  });

  let totH=0,totA=0;
  const rows=Object.entries(groups).sort((a,b)=>a[0].localeCompare(b[0])).map(([key,data])=>{
    const hrs=data.entries.reduce((s,e)=>s+e.hours,0);
    const amt=data.entries.reduce((s,e)=>{const p=gp(e.projectId);return s+(p?e.hours*p.rate:0);},0);
    totH+=hrs;totA+=amt;
    const p=data.project;
    const proj=p?`<span class="tag-pink">${p.code}</span> ${p.name}`:'Various';
    const task=groupBy==='task'?key:data.entries.map(e=>e.task).filter((v,i,a)=>a.indexOf(v)===i).slice(0,3).join(', ');
    return `<tr>
      <td style="font-weight:600">${groupBy==='date'?fmtDate(key):key}</td>
      <td>${proj}</td>
      <td style="color:var(--muted)">${task}</td>
      <td class="tag-pink">${hrs.toFixed(1)}h</td>
      <td style="color:var(--muted)">${p?'$'+p.rate+'/hr':'‚Äî'}</td>
      <td class="amt">$${amt.toFixed(2)}</td>
    </tr>`;
  });
  document.getElementById('report-body').innerHTML=rows.length?rows.join(''):
    `<tr><td colspan="6"><div class="empty-state"><div class="icon">üìä</div>No data for selected range</div></td></tr>`;
  document.getElementById('report-foot').innerHTML=rows.length?`<tr>
    <td colspan="3" style="font-weight:700;padding-left:14px">Total</td>
    <td class="tag-pink">${totH.toFixed(1)}h</td><td></td>
    <td class="amt" style="font-weight:700">$${totA.toFixed(2)}</td>
  </tr>`:'';
}
function exportCSV() {
  const from=document.getElementById('report-from').value, to=document.getElementById('report-to').value;
  const filtered=entries.filter(e=>e.date>=from&&e.date<=to);
  const rows=[['Date','Project Code','Project Name','Client','Task','Description','Hours','Rate','Amount']];
  filtered.forEach(e=>{const p=gp(e.projectId);rows.push([e.date,p?.code||'',p?.name||'',p?.client||'',e.task,`"${e.desc}"`,e.hours,p?.rate||0,((p?.rate||0)*e.hours).toFixed(2)]);});
  const csv=rows.map(r=>r.join(',')).join('\n');
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download=`timesheet-${from}-to-${to}.csv`;a.click();showToast('CSV exported! ‚úì');
}

// ============ INVOICE ============
function initInvoice() {
  const today=new Date();
  const due=new Date(today); due.setDate(due.getDate()+30);
  document.getElementById('inv-date').value=today.toISOString().split('T')[0];
  document.getElementById('inv-due').value=due.toISOString().split('T')[0];
  const ms=new Date(today.getFullYear(),today.getMonth(),1);
  document.getElementById('inv-from').value=ms.toISOString().split('T')[0];
  document.getElementById('inv-to').value=today.toISOString().split('T')[0];
  document.getElementById('inv-number').value=nextInvNum();
  document.getElementById('inv-number').readOnly=true;
  document.getElementById('inv-project').innerHTML='<option value="">Select project‚Ä¶</option>'+
    projects.filter(p=>p.status==='active').map(p=>`<option value="${p.id}">${p.code} ‚Äî ${p.name}</option>`).join('');
  renderInvoiceHistory();
  buildInvoice();
}

function buildInvoice() {
  const invNum=document.getElementById('inv-number').value||'INV-001';
  const invDate=document.getElementById('inv-date').value;
  const invDue=document.getElementById('inv-due').value;
  const fromName=document.getElementById('inv-from-name').value||'Your Name';
  const fromAddr=document.getElementById('inv-from-addr').value||'your@email.com';
  const pid=document.getElementById('inv-project').value;
  const from=document.getElementById('inv-from').value;
  const to=document.getElementById('inv-to').value;
  const taxRate=parseFloat(document.getElementById('inv-tax').value)||0;
  const terms=document.getElementById('inv-terms').value||'Net 30';
  const notes=document.getElementById('inv-notes').value||'Thank you for your business!';

  let filtered=entries.filter(e=>e.date>=from&&e.date<=to);
  if(pid) filtered=filtered.filter(e=>e.projectId===pid);

  const p=pid?gp(pid):null;
  const clientName=p?p.client:'Client';
  const clientAddr=p?.clientAddr||'';

  // Group by task
  const taskGroups={};
  filtered.forEach(e=>{
    const ep=gp(e.projectId);
    const key=`${ep?ep.code:''}_${e.task}`;
    if(!taskGroups[key])taskGroups[key]={task:e.task,project:ep,hours:0};
    taskGroups[key].hours+=e.hours;
  });

  const lineItems=Object.values(taskGroups);
  const subtotal=lineItems.reduce((s,li)=>s+(li.project?li.hours*li.project.rate:0),0);
  const tax=subtotal*taxRate/100;
  const total=subtotal+tax;

  if(!filtered.length){
    document.getElementById('invoice-preview-area').innerHTML=`<div class="empty-state card"><div class="icon">üßæ</div>No time entries found for the selected project and date range. Adjust the settings above.</div>`;
    return;
  }

  document.getElementById('invoice-preview-area').innerHTML=`
  <div class="invoice-preview">
    <div class="invoice-header">
      <div>
        <div class="invoice-logo">CWR Consulting</div>
        <div style="font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;color:var(--muted);margin-top:2px;letter-spacing:0.3px">TimeTrack Pro ¬∑ Professional Services</div>
        <div style="margin-top:10px;font-size:12px;color:var(--muted);line-height:1.7">${fromName}<br>${fromAddr}</div>
      </div>
      <div class="invoice-number">
        <span class="invoice-badge">Invoice</span>
        <strong>${invNum}</strong>
        <div style="margin-top:6px;font-size:11px;color:var(--muted)">
          Issued: ${fmtDateLong(invDate)}<br>
          Due: ${fmtDateLong(invDue)}
        </div>
      </div>
    </div>

    <div class="invoice-parties">
      <div>
        <div class="invoice-party-label">Bill From</div>
        <div class="invoice-party-name">${fromName}</div>
        <div class="invoice-party-detail">${fromAddr}</div>
      </div>
      <div>
        <div class="invoice-party-label">Bill To</div>
        <div class="invoice-party-name">${clientName}</div>
        <div class="invoice-party-detail">${clientAddr}<br>For services: ${fmtDateLong(from)} ‚Äì ${fmtDateLong(to)}</div>
      </div>
    </div>

    <table class="invoice-table">
      <thead><tr>
        <th style="text-align:left">Description</th>
        <th style="text-align:left">Project</th>
        <th style="text-align:center">Hours</th>
        <th style="text-align:right">Rate</th>
        <th style="text-align:right">Amount</th>
      </tr></thead>
      <tbody>
        ${lineItems.map(li=>`<tr>
          <td>${li.task}</td>
          <td style="color:var(--muted)">${li.project?li.project.code:''}</td>
          <td style="text-align:center">${li.hours.toFixed(2)}</td>
          <td style="text-align:right;color:var(--muted)">$${li.project?li.project.rate:0}/hr</td>
          <td style="text-align:right;font-weight:600">$${(li.project?li.hours*li.project.rate:0).toFixed(2)}</td>
        </tr>`).join('')}
      </tbody>
    </table>

    <div class="invoice-totals">
      <div class="invoice-total-row"><span>Subtotal</span><span>$${subtotal.toFixed(2)}</span></div>
      ${taxRate>0?`<div class="invoice-total-row"><span>Tax (${taxRate}%)</span><span>$${tax.toFixed(2)}</span></div>`:''}
      <div class="invoice-total-row grand"><span>Total Due</span><span>$${total.toFixed(2)}</span></div>
    </div>

    <div class="invoice-footer">
      <strong>Payment Terms:</strong> ${terms}<br>
      ${notes}<br>
      CWR Consulting ¬∑ Generated ${new Date().toLocaleDateString()}
    </div>
  </div>
  <div class="no-print" style="max-width:720px;margin:16px auto 0;display:flex;gap:10px;justify-content:flex-end">
    <button class="btn btn-green" onclick="markInvoiceSent('${invNum}','${clientName}',${total},'${invDate}','${invDue}')">‚úì Mark as Sent & Save to History</button>
    <button class="btn btn-primary" onclick="autoMarkEntriesInvoiced('${from}','${to}','${pid}')">üìå Mark All Entries as Invoiced</button>
  </div>`;
}

function markInvoiceSent(num, client, total, date, due) {
  // Check if already saved
  if(invoiceHistory.find(i=>i.num===num)) { showToast('Already saved to history'); return; }
  invoiceHistory.unshift({ num, client, total, date, due, status:'sent', savedAt:new Date().toISOString() });
  saveInvHistory();
  bumpInvCounter();
  // Update the invoice number field for next invoice
  document.getElementById('inv-number').value = nextInvNum();
  renderInvoiceHistory();
  showToast(`Invoice ${num} saved to history ‚úì`);
}

function autoMarkEntriesInvoiced(from, to, pid) {
  let count=0;
  entries.forEach(e=>{
    if(e.date>=from && e.date<=to && !e.invoiced) {
      if(!pid || e.projectId===pid) { e.invoiced=true; e.invoicedDate=new Date().toISOString().split('T')[0]; count++; }
    }
  });
  se();
  showToast(`${count} entries marked as invoiced ‚úì`);
}

function renderInvoiceHistory() {
  const el = document.getElementById('invoice-history-list');
  if(!el) return;
  if(!invoiceHistory.length) {
    el.innerHTML='<div style="color:var(--muted);font-size:12px;padding:12px 0">No invoices sent yet. Generate an invoice and click "Mark as Sent" to track it here.</div>';
    return;
  }
  el.innerHTML = invoiceHistory.map(inv=>`
    <div class="invoice-history-row">
      <div class="inv-hist-num">${inv.num}</div>
      <div class="inv-hist-client">
        <div style="font-weight:500">${inv.client}</div>
        <div style="color:var(--muted);font-size:11px">Sent ${fmtDateLong(inv.date)} ¬∑ Due ${fmtDateLong(inv.due)}</div>
      </div>
      <div class="inv-hist-amt">$${Number(inv.total).toFixed(2)}</div>
      <div class="inv-hist-status">
        <select style="font-size:11px;padding:4px 8px;width:auto" onchange="updateInvStatus('${inv.num}',this.value)">
          <option value="sent" ${inv.status==='sent'?'selected':''}>Sent</option>
          <option value="paid" ${inv.status==='paid'?'selected':''}>Paid ‚úì</option>
          <option value="overdue" ${inv.status==='overdue'?'selected':''}>Overdue</option>
          <option value="draft" ${inv.status==='draft'?'selected':''}>Draft</option>
        </select>
      </div>
      <div><button class="btn btn-sm btn-danger" onclick="deleteInvHistory('${inv.num}')">‚úï</button></div>
    </div>`).join('');
}

function updateInvStatus(num, status) {
  const inv = invoiceHistory.find(i=>i.num===num);
  if(inv) { inv.status=status; saveInvHistory(); showToast(`Invoice ${num} marked as ${status}`); }
}
function deleteInvHistory(num) {
  invoiceHistory = invoiceHistory.filter(i=>i.num!==num);
  saveInvHistory(); renderInvoiceHistory(); showToast('Removed from history');
}

// ============ EXPENSES ============
function saveExpenses() { localStorage.setItem('tt2_expenses', JSON.stringify(expenses)); }

function initExpenses() {
  const today = new Date();
  const ms = new Date(today.getFullYear(), today.getMonth(), 1);
  document.getElementById('exp-filter-from').value = ms.toISOString().split('T')[0];
  document.getElementById('exp-filter-to').value = today.toISOString().split('T')[0];
  document.getElementById('exp-filter-project').innerHTML = '<option value="">All Projects</option>' +
    projects.map(p=>`<option value="${p.id}">${p.code} ‚Äî ${p.name}</option>`).join('');
  renderExpenses();
}

function renderExpenses() {
  const from = document.getElementById('exp-filter-from').value;
  const to = document.getElementById('exp-filter-to').value;
  const pid = document.getElementById('exp-filter-project').value;
  const cat = document.getElementById('exp-filter-cat').value;

  let filtered = expenses.filter(e => e.date >= from && e.date <= to);
  if (pid) filtered = filtered.filter(e => e.projectId === pid);
  if (cat) filtered = filtered.filter(e => e.category === cat);
  filtered.sort((a,b) => b.date.localeCompare(a.date));

  // Stats for this month
  const today = new Date();
  const ms = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
  const me = today.toISOString().split('T')[0];
  const monthExp = expenses.filter(e => e.date >= ms && e.date <= me);
  const monthTotal = monthExp.reduce((s,e) => s + e.amount, 0);
  const unreimb = expenses.filter(e => e.reimbursed === 'no').reduce((s,e) => s + e.amount, 0);
  const billable = expenses.filter(e => e.billable === 'yes').reduce((s,e) => s + e.amount, 0);

  document.getElementById('exp-stat-month').textContent = '$' + monthTotal.toFixed(2);
  document.getElementById('exp-stat-unreimb').textContent = '$' + unreimb.toFixed(2);
  document.getElementById('exp-stat-billable').textContent = '$' + billable.toFixed(2);

  let totalAmt = 0;
  const catColors = { Travel:'var(--orange)', Meals:'var(--green)', Software:'var(--pink)', 'Office Supplies':'#0891b2', Subcontractor:'#7c3aed', Other:'var(--muted)' };

  document.getElementById('expenses-body').innerHTML = filtered.length ? filtered.map(e => {
    const p = gp(e.projectId);
    totalAmt += e.amount;
    const catColor = catColors[e.category] || 'var(--muted)';
    return `<tr>
      <td style="color:var(--muted);white-space:nowrap">${fmtDate(e.date)}</td>
      <td style="font-weight:500">${e.vendor}</td>
      <td><span style="background:${catColor}22;color:${catColor};border-radius:20px;padding:2px 9px;font-size:11px;font-weight:600">${e.category}</span></td>
      <td>${p ? `<span class="tag-pink">${p.code}</span>` : '<span style="color:var(--muted)">‚Äî</span>'}</td>
      <td style="font-weight:600">$${e.amount.toFixed(2)}</td>
      <td>${e.billable==='yes' ? '<span class="invoiced-badge">Billable</span>' : '<span style="color:var(--muted);font-size:11px">Internal</span>'}</td>
      <td>${e.reimbursed==='yes'
        ? '<span class="invoiced-badge">‚úì Reimbursed</span>'
        : `<button class="btn btn-sm" style="font-size:10px;padding:3px 8px;border-color:var(--orange);color:var(--orange)" onclick="markReimbursed('${e.id}')">Mark Paid</button>`}</td>
      <td style="color:var(--muted);font-size:11px">${e.receipt || '‚Äî'}</td>
      <td><button class="btn btn-sm btn-danger" onclick="deleteExpense('${e.id}')">‚úï</button></td>
    </tr>`;
  }).join('') : `<tr><td colspan="9"><div class="empty-state"><div class="icon">üßæ</div>No expenses found. Add your first expense!</div></td></tr>`;

  document.getElementById('expenses-foot').innerHTML = filtered.length ? `<tr>
    <td colspan="4" style="font-weight:700;padding-left:14px">Total</td>
    <td style="font-weight:700;color:var(--orange)">$${totalAmt.toFixed(2)}</td>
    <td colspan="4"></td>
  </tr>` : '';
}

function openAddExpense() {
  document.getElementById('exp-date').value = new Date().toISOString().split('T')[0];
  document.getElementById('exp-amount').value = '';
  document.getElementById('exp-vendor').value = '';
  document.getElementById('exp-receipt').value = '';
  document.getElementById('exp-project').innerHTML = '<option value="">None / General</option>' +
    projects.filter(p=>p.status==='active').map(p=>`<option value="${p.id}">${p.code} ‚Äî ${p.name}</option>`).join('');
  document.getElementById('modal-expense').classList.add('open');
}

function saveExpense() {
  const date = document.getElementById('exp-date').value;
  const amount = parseFloat(document.getElementById('exp-amount').value);
  const vendor = document.getElementById('exp-vendor').value.trim();
  const category = document.getElementById('exp-category').value;
  const projectId = document.getElementById('exp-project').value;
  const billable = document.getElementById('exp-billable').value;
  const reimbursed = document.getElementById('exp-reimbursed').value;
  const receipt = document.getElementById('exp-receipt').value.trim();
  if (!date || !amount || !vendor) { showToast('Please fill date, amount, and vendor'); return; }
  expenses.push({ id: 'x' + Date.now(), date, amount, vendor, category, projectId, billable, reimbursed, receipt });
  saveExpenses(); closeModal('modal-expense'); renderExpenses(); showToast('Expense saved! ‚úì');
}

function markReimbursed(id) {
  const e = expenses.find(x => x.id === id);
  if (e) { e.reimbursed = 'yes'; saveExpenses(); renderExpenses(); showToast('Marked as reimbursed ‚úì'); }
}

function deleteExpense(id) {
  expenses = expenses.filter(x => x.id !== id);
  saveExpenses(); renderExpenses(); showToast('Expense deleted');
}

function exportExpensesCSV() {
  const rows = [['Date','Vendor','Category','Project','Amount','Billable','Reimbursed','Receipt']];
  expenses.forEach(e => {
    const p = gp(e.projectId);
    rows.push([e.date, e.vendor, e.category, p?p.name:'', e.amount.toFixed(2), e.billable, e.reimbursed, e.receipt]);
  });
  const csv = rows.map(r => r.map(v=>`"${v}"`).join(',')).join('\n');
  const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download = `CWR-expenses-${new Date().toISOString().split('T')[0]}.csv`; a.click();
  showToast('Expenses CSV exported ‚úì');
}

function exportExpensesQB() {
  // QuickBooks IIF format
  const lines = [
    '!TRNS\tTRNSTYPE\tDATE\tACCNT\tNAME\tAMOUNT\tMEMO\tCLASS',
    '!SPL\tTRNSTYPE\tDATE\tACCNT\tNAME\tAMOUNT\tMEMO\tCLASS',
    '!ENDTRNS'
  ];
  expenses.forEach(e => {
    const p = gp(e.projectId);
    const dateStr = new Date(e.date+'T12:00:00').toLocaleDateString('en-US');
    const acct = e.category === 'Travel' ? 'Travel & Entertainment' :
                 e.category === 'Meals' ? 'Meals & Entertainment' :
                 e.category === 'Software' ? 'Software Subscriptions' :
                 e.category === 'Subcontractor' ? 'Contract Labor' : 'Office Expenses';
    const cls = p ? p.name : '';
    lines.push(`TRNS\tEXPENSE\t${dateStr}\tChecking\t${e.vendor}\t-${e.amount.toFixed(2)}\t${e.vendor}\t${cls}`);
    lines.push(`SPL\tEXPENSE\t${dateStr}\t${acct}\t${e.vendor}\t${e.amount.toFixed(2)}\t${e.category}\t${cls}`);
    lines.push('ENDTRNS');
  });
  const iif = lines.join('\n');
  const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([iif],{type:'text/plain'}));
  a.download = `CWR-expenses-QB-${new Date().toISOString().split('T')[0]}.iif`; a.click();
  showToast('QuickBooks IIF exported ‚úì');
}

// ============ QUICKBOOKS TIME EXPORT ============
function exportTimeQB() {
  // QuickBooks IIF format for time entries
  const lines = [
    '!TIMERHDR\tVER\tREL\tCOMPANYNAME\tIMPORTEDBEFORE\tFROMTIMER',
    'TIMERHDR\t8\t0\tCWR Consulting\tN\tN',
    '!TIMER\tEMPLOYEE\tCUSTOMER:JOB\tSERVICEITEM\tDURATION\tPROJECT\tNOTES\tBILLINGSTATUS',
    '!ENDTIMER'
  ];
  entries.forEach(e => {
    const p = gp(e.projectId);
    const hrs = Math.floor(e.hours);
    const mins = Math.round((e.hours - hrs) * 60);
    const dur = `${String(hrs).padStart(2,'0')}:${String(mins).padStart(2,'0')}`;
    lines.splice(lines.length-1, 0, `TIMER\tConsultant\t${p?p.client:''}\t${e.task}\t${dur}\t${p?p.name:''}\t${e.desc}\t1`);
  });
  const iif = lines.join('\n');
  const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([iif],{type:'text/plain'}));
  a.download = `CWR-time-QB-${new Date().toISOString().split('T')[0]}.iif`; a.click();
  showToast('QuickBooks Time IIF exported ‚úì');
}

// ============ UTILS ============
function fmtDate(ds){return new Date(ds+'T12:00:00').toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});}
function fmtDateLong(ds){if(!ds)return'';return new Date(ds+'T12:00:00').toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});}
function closeModal(id){document.getElementById(id).classList.remove('open');}
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500);}
document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');}));

// INIT
populateTimerProjects();
renderDashboard();
renderTimesheet();
</script>
</body>
</html>
