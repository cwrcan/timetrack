<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CWR Consulting ¬∑ TimeTrack Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Plus+Jakarta+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f8f6f2; --surface: #ffffff; --surface2: #faf9f7;
  --border: #e8e4de; --border2: #d4cec6;
  --pink: #e8187a; --pink-light: #fce8f2;
  --orange: #f4620a; --orange-light: #fff0e8;
  --green: #15803d; --green-light: #dcfce7; --green-mid: #22c55e;
  --text: #1a1612; --text2: #4a4540; --muted: #8a847c;
  --shadow: 0 2px 12px rgba(0,0,0,0.07); --shadow-lg: 0 8px 32px rgba(0,0,0,0.1);
}
body.dark {
  --bg:#0f0d0b; --surface:#1c1917; --surface2:#242220;
  --border:#2e2b28; --border2:#3d3935;
  --pink-light:#3d1228; --orange-light:#2d1800; --green-light:#0a2318;
  --text:#f0ede8; --text2:#c8c4be; --muted:#7a7670;
  --shadow:0 2px 12px rgba(0,0,0,0.3); --shadow-lg:0 8px 32px rgba(0,0,0,0.5);
}
body.dark tbody tr:hover td { background:#1f1d1b; }
body.dark .invoice-preview { background:#1c1917; color:#f0ede8; }
body.dark .cal-day.has-entries { background:#200f18; }
.dark-toggle { width:44px;height:24px;background:var(--border2);border-radius:12px;position:relative;cursor:pointer;border:none;transition:background .25s;flex-shrink:0; }
.dark-toggle.on { background:var(--pink); }
.dark-toggle::after { content:'';position:absolute;width:18px;height:18px;background:#fff;border-radius:50%;top:3px;left:3px;transition:left .25s; }
.dark-toggle.on::after { left:23px; }
.mode-label { font-size:11px;color:var(--muted); }
* { box-sizing:border-box;margin:0;padding:0; }
body { background:var(--bg);color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:13.5px;min-height:100vh;transition:background .25s,color .25s; }
header { background:var(--surface);border-bottom:2px solid var(--border);padding:0 32px;display:flex;align-items:center;justify-content:space-between;height:64px;position:sticky;top:0;z-index:100;box-shadow:var(--shadow); }
.logo { font-family:'Playfair Display',serif;font-size:22px;font-weight:900;color:var(--pink);letter-spacing:-.5px; }
.logo span { color:var(--muted);font-weight:700; }
nav { display:flex;gap:2px; }
nav button { background:none;border:none;color:var(--muted);font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:500;padding:8px 14px;cursor:pointer;border-radius:8px;transition:all .15s; }
nav button:hover { color:var(--text);background:var(--surface2); }
nav button.active { color:var(--pink);background:var(--pink-light);font-weight:600; }
.timer-widget { display:flex;align-items:center;gap:10px;background:var(--surface2);border:1.5px solid var(--border);border-radius:40px;padding:6px 16px 6px 10px; }
.timer-display { font-family:'Playfair Display',serif;font-size:18px;font-weight:700;color:var(--text);letter-spacing:1px;min-width:72px;text-align:center; }
.timer-display.running { color:var(--orange); }
.timer-btn { width:32px;height:32px;border-radius:50%;border:none;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;transition:all .15s; }
.timer-btn.start { background:var(--green);color:#fff; }
.timer-btn.stop { background:var(--orange);color:#fff; }
.timer-btn.reset { background:var(--border);color:var(--muted); }
main { padding:28px 32px;max-width:1440px;margin:0 auto; }
.view { display:none; }
.view.active { display:block; }
.page-header { display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:24px; }
.page-title { font-family:'Playfair Display',serif;font-size:30px;font-weight:900;color:var(--text); }
.page-sub { color:var(--muted);font-size:12px;margin-top:4px; }
.btn { background:var(--surface);border:1.5px solid var(--border2);color:var(--text2);font-family:'Plus Jakarta Sans',sans-serif;font-size:12.5px;font-weight:500;padding:8px 16px;border-radius:8px;cursor:pointer;transition:all .15s;display:inline-flex;align-items:center;gap:6px; }
.btn:hover { border-color:var(--pink);color:var(--pink);background:var(--pink-light); }
.btn-primary { background:var(--pink);color:#fff;border-color:var(--pink); }
.btn-primary:hover { background:#c41268;color:#fff;border-color:#c41268; }
.btn-orange { background:var(--orange);color:#fff;border-color:var(--orange); }
.btn-orange:hover { background:#c2510a;color:#fff; }
.btn-green { background:var(--green);color:#fff;border-color:var(--green); }
.btn-green:hover { background:#166534;color:#fff; }
.btn-danger { border-color:#fca5a5;color:#dc2626; }
.btn-danger:hover { background:#fee2e2;border-color:#dc2626; }
.btn-sm { padding:5px 10px;font-size:11.5px; }
.btn-group { display:flex;gap:8px;flex-wrap:wrap; }
.card { background:var(--surface);border:1.5px solid var(--border);border-radius:14px;padding:24px;box-shadow:var(--shadow); }
.card-title { font-family:'Playfair Display',serif;font-size:17px;font-weight:700;margin-bottom:18px;color:var(--text); }
.stat-grid { display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:24px; }
.stat-card { background:var(--surface);border:1.5px solid var(--border);border-radius:14px;padding:22px;box-shadow:var(--shadow);position:relative;overflow:hidden; }
.stat-card::after { content:'';position:absolute;bottom:0;left:0;right:0;height:3px; }
.stat-card.pink::after { background:var(--pink); }
.stat-card.orange::after { background:var(--orange); }
.stat-card.green::after { background:var(--green-mid); }
.stat-card.teal::after { background:#0891b2; }
.stat-label { color:var(--muted);font-size:11px;font-weight:600;letter-spacing:.8px;text-transform:uppercase;margin-bottom:10px; }
.stat-value { font-family:'Playfair Display',serif;font-size:38px;font-weight:900;line-height:1;color:var(--text); }
.stat-sub { color:var(--muted);font-size:11px;margin-top:6px; }
.dash-grid { display:grid;grid-template-columns:1fr 1fr;gap:16px; }
.bar-chart { display:flex;flex-direction:column;gap:10px; }
.bar-row { display:flex;align-items:center;gap:10px; }
.bar-label { width:110px;font-size:11px;color:var(--muted);text-align:right;white-space:nowrap;overflow:hidden;text-overflow:ellipsis; }
.bar-track { flex:1;background:var(--surface2);border-radius:6px;height:22px;overflow:hidden;border:1px solid var(--border); }
.bar-fill { height:100%;border-radius:6px;transition:width .8s cubic-bezier(.4,0,.2,1); }
.bar-fill.pink { background:linear-gradient(90deg,var(--pink),#f472b6); }
.bar-fill.orange { background:linear-gradient(90deg,var(--orange),#fb923c); }
.bar-fill.green { background:linear-gradient(90deg,var(--green),#22c55e); }
.bar-val { width:44px;font-size:11px;color:var(--text2);font-weight:600;text-align:right; }
.entry-list { display:flex;flex-direction:column; }
.entry-item { display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border); }
.entry-item:last-child { border-bottom:none; }
.entry-dot { width:10px;height:10px;border-radius:50%;flex-shrink:0; }
.entry-info { flex:1;min-width:0; }
.entry-project { font-size:12.5px;font-weight:500; }
.entry-meta { color:var(--muted);font-size:11px;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis; }
.entry-hours { font-family:'Playfair Display',serif;font-size:18px;font-weight:700;color:var(--pink);flex-shrink:0; }
.week-nav { display:flex;align-items:center;gap:12px;margin-bottom:20px;background:var(--surface);border:1.5px solid var(--border);border-radius:12px;padding:14px 20px;box-shadow:var(--shadow); }
.week-label { font-family:'Playfair Display',serif;font-size:18px;font-weight:700;flex:1; }
.week-hours { font-size:13px;color:var(--muted); }
.week-hours strong { color:var(--orange); }
table { width:100%;border-collapse:collapse; }
th { text-align:left;color:var(--muted);font-size:11px;font-weight:600;letter-spacing:.7px;text-transform:uppercase;padding:12px 14px;background:var(--surface2);border-bottom:1.5px solid var(--border); }
td { padding:11px 14px;border-bottom:1px solid var(--border);vertical-align:middle; }
tr:last-child td { border-bottom:none; }
tbody tr:hover td { background:#fdf8ff; }
tbody tr.clickable-row { cursor:pointer; }
tbody tr.clickable-row:hover td { background:var(--pink-light); }
tfoot td { background:var(--surface2);font-weight:600; }
.tag-pink { color:var(--pink);font-weight:600;font-size:12px; }
.tag-orange { color:var(--orange);font-weight:600; }
.tag-green { color:var(--green);font-weight:600; }
.amt { color:var(--green);font-weight:500; }
input,select,textarea { background:var(--surface2);border:1.5px solid var(--border);color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;padding:9px 12px;border-radius:8px;outline:none;transition:border-color .15s,box-shadow .15s;width:100%; }
input:focus,select:focus,textarea:focus { border-color:var(--pink);box-shadow:0 0 0 3px rgba(232,24,122,.08); }
select option { background:#fff; }
.form-group { margin-bottom:14px; }
.form-label { color:var(--text2);font-size:11.5px;font-weight:600;letter-spacing:.4px;text-transform:uppercase;margin-bottom:6px;display:block; }
.form-row { display:grid;grid-template-columns:1fr 1fr;gap:12px; }
.form-row-3 { display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px; }
.modal-overlay { display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:200;align-items:center;justify-content:center;backdrop-filter:blur(4px); }
.modal-overlay.open { display:flex; }
.modal { background:var(--surface);border:1.5px solid var(--border);border-radius:18px;padding:32px;width:580px;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow-lg); }
.modal-title { font-family:'Playfair Display',serif;font-size:22px;font-weight:900;margin-bottom:24px;color:var(--text); }
.modal-actions { display:flex;gap:8px;justify-content:flex-end;margin-top:24px;padding-top:20px;border-top:1px solid var(--border); }
.status-badge { font-size:10.5px;font-weight:600;padding:3px 9px;border-radius:20px;text-transform:uppercase;letter-spacing:.4px; }
.status-active { background:var(--green-light);color:var(--green); }
.status-inactive { background:var(--surface2);color:var(--muted); }
.projects-grid { display:grid;grid-template-columns:repeat(auto-fill,minmax(330px,1fr));gap:16px; }
.project-card { background:var(--surface);border:1.5px solid var(--border);border-radius:14px;padding:22px;box-shadow:var(--shadow);transition:all .2s;cursor:pointer; }
.project-card:hover { border-color:var(--pink);box-shadow:0 4px 20px rgba(232,24,122,.1);transform:translateY(-1px); }
.project-code { color:var(--pink);font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase; }
.project-name { font-family:'Playfair Display',serif;font-size:17px;font-weight:700;margin:4px 0 2px; }
.project-client { color:var(--muted);font-size:12px; }
.project-rate { color:var(--green);font-weight:600;font-size:13px;margin-top:10px; }
.task-pill { display:inline-block;background:var(--pink-light);color:var(--pink);border-radius:20px;padding:3px 10px;font-size:11px;font-weight:500;margin:3px 3px 3px 0; }
.project-tasks { margin-top:12px;border-top:1px solid var(--border);padding-top:12px; }
.project-card-footer { display:flex;align-items:center;justify-content:space-between;margin-top:14px;border-top:1px solid var(--border);padding-top:12px; }
.report-controls { background:var(--surface);border:1.5px solid var(--border);border-radius:12px;padding:18px 22px;display:flex;gap:14px;align-items:flex-end;margin-bottom:20px;flex-wrap:wrap;box-shadow:var(--shadow); }
.report-controls .form-group { margin:0;min-width:150px; }
.report-summary { background:var(--surface);border:1.5px solid var(--border);border-radius:12px;padding:20px 24px;margin-bottom:20px;box-shadow:var(--shadow);line-height:1.75;font-size:13.5px;color:var(--text2); }
.report-summary strong { color:var(--text); }
.invoice-preview { background:#fff;border:1.5px solid var(--border);border-radius:14px;padding:48px;max-width:760px;margin:0 auto;box-shadow:var(--shadow-lg);font-family:'Plus Jakarta Sans',sans-serif; }
.invoice-header { display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:36px; }
.invoice-logo { font-family:'Playfair Display',serif;font-size:26px;font-weight:900;color:var(--pink); }
.invoice-number { font-size:12px;color:var(--muted);text-align:right; }
.invoice-number strong { display:block;font-family:'Playfair Display',serif;font-size:28px;color:var(--text); }
.invoice-parties { display:grid;grid-template-columns:1fr 1fr;gap:40px;margin-bottom:32px; }
.invoice-party-label { font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:6px; }
.invoice-party-name { font-size:16px;font-weight:700;margin-bottom:2px; }
.invoice-party-detail { font-size:12px;color:var(--muted);line-height:1.7; }
.invoice-table { width:100%;border-collapse:collapse;margin-bottom:24px; }
.invoice-table th { background:var(--pink);color:#fff;font-size:11px;font-weight:600;letter-spacing:.5px;text-transform:uppercase;padding:10px 14px; }
.invoice-table th:first-child { border-radius:8px 0 0 8px; }
.invoice-table th:last-child { border-radius:0 8px 8px 0; }
.invoice-table td { padding:11px 14px;border-bottom:1px solid var(--border);font-size:13px; }
.invoice-table .section-header td { background:var(--surface2);font-weight:700;font-size:11px;letter-spacing:.5px;text-transform:uppercase;color:var(--muted);padding:8px 14px; }
.invoice-totals { border-top:2px solid var(--border);padding-top:16px;max-width:280px;margin-left:auto; }
.invoice-total-row { display:flex;justify-content:space-between;padding:5px 0;font-size:13px; }
.invoice-total-row.grand { font-size:16px;font-weight:700;color:var(--pink);border-top:1.5px solid var(--border);margin-top:8px;padding-top:10px; }
.invoice-footer { margin-top:40px;padding-top:20px;border-top:1px solid var(--border);font-size:11px;color:var(--muted);text-align:center;line-height:1.8; }
.invoice-badge { display:inline-block;background:var(--orange-light);color:var(--orange);border-radius:4px;padding:4px 12px;font-size:14px;font-weight:700;text-transform:uppercase;letter-spacing:.5px; }
.invoiced-badge { display:inline-block;background:var(--green-light);color:var(--green);border-radius:20px;padding:2px 8px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.4px; }
.invoice-history-row { display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--border); }
.invoice-history-row:last-child { border-bottom:none; }
.inv-hist-num { font-weight:700;color:var(--pink);min-width:100px; }
.inv-hist-client { flex:1;font-size:12px; }
.inv-hist-amt { color:var(--green);font-weight:600;min-width:80px;text-align:right; }
.calendar-nav { display:flex;align-items:center;gap:12px;margin-bottom:20px;background:var(--surface);border:1.5px solid var(--border);border-radius:12px;padding:14px 20px;box-shadow:var(--shadow); }
.cal-month-label { font-family:'Playfair Display',serif;font-size:20px;font-weight:900;flex:1; }
.cal-grid { display:grid;grid-template-columns:repeat(7,1fr);gap:4px; }
.cal-header { text-align:center;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;padding:8px 0;letter-spacing:.5px; }
.cal-day { background:var(--surface);border:1.5px solid var(--border);border-radius:10px;padding:8px;min-height:100px;cursor:pointer;transition:all .15s;position:relative; }
.cal-day:hover { border-color:var(--pink);background:var(--pink-light); }
.cal-day.today { border-color:var(--pink);border-width:2px; }
.cal-day.other-month { background:var(--surface2);opacity:.5; }
.cal-day.has-entries { background:#fff8fc; }
.cal-day-num { font-size:12px;font-weight:700;color:var(--text2);margin-bottom:4px; }
.cal-day.today .cal-day-num { color:var(--pink); }
.cal-entry-link { font-size:10px;line-height:1.6;color:var(--pink);font-weight:500;cursor:pointer;display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;border-radius:3px;padding:1px 2px; }
.cal-entry-link:hover { background:var(--pink-light);text-decoration:underline; }
.cal-add-btn { font-size:10px;color:var(--muted);cursor:pointer;display:block;margin-top:2px; }
.cal-add-btn:hover { color:var(--pink); }
.cal-day-total { position:absolute;bottom:6px;right:8px;font-size:10px;font-weight:700;color:var(--orange); }
.cal-legend { display:flex;gap:16px;align-items:center;margin-top:14px;font-size:11px;color:var(--muted); }
.toast { position:fixed;bottom:24px;right:24px;background:var(--pink);color:#fff;padding:12px 20px;border-radius:10px;font-size:13px;font-weight:500;z-index:999;transform:translateY(80px);opacity:0;transition:all .3s cubic-bezier(.4,0,.2,1);box-shadow:0 4px 16px rgba(232,24,122,.3); }
.toast.show { transform:translateY(0);opacity:1; }
.empty-state { text-align:center;padding:60px 20px;color:var(--muted); }
.empty-state .icon { font-size:44px;margin-bottom:12px; }
.edit-hint { font-size:11px;color:var(--muted);font-style:italic;margin-top:4px; }
@media print { header,.no-print { display:none!important; } body { background:white; } .invoice-preview { box-shadow:none;border:none; } }
/* Retainer tracker */
.retainer-card { background:var(--surface);border:1.5px solid var(--border);border-radius:14px;padding:20px 24px;margin-bottom:16px;box-shadow:var(--shadow);transition:box-shadow .2s; }
.retainer-card:hover { box-shadow:var(--shadow-lg); }
.retainer-header { display:flex;align-items:center;justify-content:space-between;margin-bottom:4px; }
.retainer-name { font-family:'Playfair Display',serif;font-size:17px;font-weight:700; }
.retainer-meta { color:var(--muted);font-size:12px;margin-top:2px;margin-bottom:10px; }
.retainer-gauge-track { height:18px;background:var(--border);border-radius:9px;overflow:hidden;margin:10px 0 6px; }
.retainer-gauge-fill { height:100%;border-radius:9px;transition:width .6s cubic-bezier(.4,0,.2,1); }
.retainer-gauge-fill.ok   { background:linear-gradient(90deg,var(--green),#22c55e); }
.retainer-gauge-fill.warn { background:linear-gradient(90deg,var(--orange),#fbbf24); }
.retainer-gauge-fill.over { background:linear-gradient(90deg,#dc2626,var(--orange)); }
.retainer-stats { display:flex;gap:24px;flex-wrap:wrap; }
.retainer-stat { display:flex;flex-direction:column; }
.retainer-stat-val { font-size:22px;font-weight:700;font-family:'Playfair Display',serif;line-height:1.1; }
.retainer-stat-label { font-size:10px;text-transform:uppercase;letter-spacing:.6px;color:var(--muted);font-weight:600;margin-top:2px; }
.annual-month-link { color:var(--pink);cursor:pointer;font-weight:600; }
.annual-month-link:hover { text-decoration:underline; }
</style>
</head>
<body>
<header>
  <div class="logo"><span style="color:var(--text);font-size:15px;font-weight:700;letter-spacing:0">CWR Consulting</span> &nbsp; TimeTrack <span>Pro</span></div>
  <nav>
    <button class="active" onclick="showView('dashboard')">Dashboard</button>
    <button onclick="showView('timesheet')">Timesheet</button>
    <button onclick="showView('calendar')">Calendar</button>
    <button onclick="showView('projects')">Projects</button>
    <button onclick="showView('expenses')">Expenses</button>
    <button onclick="showView('reports')">Reports</button>
    <button onclick="showView('annual')">Annual</button>
    <button onclick="showView('retainer')">Retainers</button>
    <button onclick="showView('invoice')">Invoice</button>
  </nav>
  <div style="display:flex;align-items:center;gap:12px;">
    <div style="display:flex;align-items:center;gap:6px;">
      <span class="mode-label" id="mode-label">‚òÄÔ∏è</span>
      <button class="dark-toggle" id="dark-toggle" onclick="toggleDark()"></button>
    </div>
    <div class="timer-widget">
      <select id="timer-project-select" style="width:130px;font-size:11px;padding:5px 8px;border-radius:6px;" onchange="updateTimerProject()"><option value="">Pick project‚Ä¶</option></select>
      <div class="timer-display" id="timer-display">00:00:00</div>
      <button class="timer-btn start" id="timer-start-btn" onclick="timerToggle()" title="Start">‚ñ∂</button>
      <button class="timer-btn reset" onclick="timerReset()" title="Reset">‚Ü∫</button>
      <button class="timer-btn stop" onclick="timerLog()" style="font-size:11px;font-weight:700;width:auto;padding:0 8px;border-radius:6px;">Log</button>
    </div>
  </div>
</header>

<main>
<!-- DASHBOARD -->
<div class="view active" id="view-dashboard">
  <div class="page-header">
    <div><div class="page-title">Good <span id="greeting-time"></span> üëã</div><div class="page-sub" id="dash-date"></div></div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="openEntryModal()">Ôºã Log Time</button>
      <button class="btn btn-orange" onclick="showView('invoice')">üßæ Create Invoice</button>
      <button class="btn" onclick="showView('annual')" style="border-color:var(--pink);color:var(--pink);">üìä Annual Report</button>
      <button class="btn" onclick="showView('retainer')" style="border-color:var(--green);color:var(--green);">‚è≥ Retainers</button>
    </div>
  </div>
  <!-- Billable stats row -->
  <div class="stat-grid">
    <div class="stat-card pink"><div class="stat-label">Hours This Week</div><div class="stat-value" id="stat-week">0.0</div><div class="stat-sub">of 40 target hours</div></div>
    <div class="stat-card orange"><div class="stat-label">Billable This Month</div><div class="stat-value" id="stat-billable">$0</div><div class="stat-sub" id="stat-billable-hrs">0 billable hrs</div></div>
    <div class="stat-card green"><div class="stat-label">Active Projects</div><div class="stat-value" id="stat-projects">0</div><div class="stat-sub">currently tracked</div></div>
    <div class="stat-card teal"><div class="stat-label">Billable Hours</div><div class="stat-value" id="stat-month">0.0</div><div class="stat-sub">logged this month</div></div>
  </div>
  <!-- Non-billable stats row -->
  <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:var(--muted);margin:4px 0 8px;padding-left:2px;">Non-Billable Activity This Month</div>
  <div class="stat-grid" style="margin-bottom:24px;">
    <div class="stat-card" style="background:var(--surface2);border-color:var(--border);">
      <div class="stat-label">Non-Billable Hours</div>
      <div class="stat-value" id="stat-nonbill-hrs" style="color:var(--text2)">0.0</div>
      <div class="stat-sub" id="stat-nonbill-proj-count">across 0 projects</div>
    </div>
    <div class="stat-card" style="background:var(--surface2);border-color:var(--border);">
      <div class="stat-label">Non-Billable Value</div>
      <div class="stat-value" id="stat-nonbill-amt" style="color:var(--text2)">$0</div>
      <div class="stat-sub">at project rates ¬∑ not invoiced</div>
    </div>
    <div class="stat-card" style="background:var(--surface2);border-color:var(--border);">
      <div class="stat-label">% of Month's Hours</div>
      <div class="stat-value" id="stat-nonbill-pct" style="color:var(--text2)">0%</div>
      <div class="stat-sub">non-billable share</div>
    </div>
    <div class="stat-card" style="background:var(--surface2);border-color:var(--border);">
      <div class="stat-label">Non-Billable Projects</div>
      <div class="stat-value" id="stat-nonbill-projs" style="color:var(--text2)">0</div>
      <div class="stat-sub">with activity this month</div>
    </div>
  </div>
  <div class="dash-grid">
    <div class="card"><div class="card-title">Hours by Project</div><div class="bar-chart" id="chart-projects"></div></div>
    <div class="card"><div class="card-title">Recent Entries</div><div class="entry-list" id="recent-entries"></div></div>
  </div>
</div>

<!-- TIMESHEET -->
<div class="view" id="view-timesheet">
  <div class="page-header">
    <div><div class="page-title">Timesheet</div><div class="page-sub">Click any row to view or edit ¬∑ <span class="edit-hint">entries are editable</span></div></div>
    <button class="btn btn-primary" onclick="openEntryModal()">Ôºã Add Entry</button>
  </div>
  <div class="week-nav">
    <button class="btn" onclick="prevWeek()">‚Üê Prev</button>
    <div class="week-label" id="week-label"></div>
    <span class="week-hours">Total: <strong id="week-total-hrs">0h</strong></span>
    <button class="btn" onclick="nextWeek()">Next ‚Üí</button>
    <button class="btn btn-primary" onclick="goToday()">Today</button>
  </div>
  <div class="card" style="padding:0;overflow:hidden;">
    <table><thead><tr>
      <th>Date</th><th>Project</th><th>Task</th><th>Description</th>
      <th>Hours</th><th>Rate</th><th>Amount</th><th>Status</th><th></th>
    </tr></thead>
    <tbody id="timesheet-body"></tbody>
    <tfoot id="timesheet-foot"></tfoot></table>
  </div>
</div>

<!-- CALENDAR -->
<div class="view" id="view-calendar">
  <div class="page-header">
    <div><div class="page-title">Calendar View</div><div class="page-sub">Click an entry to edit ¬∑ Click a day to add</div></div>
    <button class="btn btn-primary" onclick="openEntryModal()">Ôºã Add Entry</button>
  </div>
  <div class="calendar-nav">
    <button class="btn" onclick="prevMonth()">‚Üê Prev</button>
    <div class="cal-month-label" id="cal-month-label"></div>
    <button class="btn" onclick="nextMonth()">Next ‚Üí</button>
    <button class="btn btn-primary" onclick="goCalToday()">Today</button>
  </div>
  <div class="card" style="padding:16px;">
    <div class="cal-grid" id="cal-header-row"></div>
    <div class="cal-grid" id="cal-grid" style="margin-top:4px;"></div>
    <div class="cal-legend"><span>üíó = click entry to edit</span><span style="color:var(--orange)">üü† = daily total</span></div>
  </div>
</div>

<!-- PROJECTS -->
<div class="view" id="view-projects">
  <div class="page-header">
    <div><div class="page-title">Projects & Tasks</div><div class="page-sub">Click any project card to edit all fields</div></div>
    <button class="btn btn-primary" onclick="openProjectModal()">Ôºã New Project</button>
  </div>
  <div class="projects-grid" id="projects-grid"></div>
</div>

<!-- EXPENSES -->
<div class="view" id="view-expenses">
  <div class="page-header">
    <div><div class="page-title">Expense Tracking</div><div class="page-sub">Click any row to edit ¬∑ Mileage auto-calculated</div></div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="openExpenseModal()">Ôºã Add Expense</button>
      <button class="btn btn-green" onclick="exportExpensesCSV()">‚¨á Export CSV</button>
      <button class="btn btn-orange" onclick="exportExpensesQB()">‚¨á QuickBooks</button>
    </div>
  </div>
  <div class="stat-grid" style="grid-template-columns:repeat(3,1fr);margin-bottom:20px;">
    <div class="stat-card pink"><div class="stat-label">This Month</div><div class="stat-value" id="exp-stat-month">$0</div><div class="stat-sub">total expenses</div></div>
    <div class="stat-card orange"><div class="stat-label">Unreimbursed</div><div class="stat-value" id="exp-stat-unreimb">$0</div><div class="stat-sub">pending reimbursement</div></div>
    <div class="stat-card green"><div class="stat-label">Billable to Clients</div><div class="stat-value" id="exp-stat-billable">$0</div><div class="stat-sub">pass-through expenses</div></div>
  </div>
  <div class="report-controls" style="margin-bottom:16px;">
    <div class="form-group"><label class="form-label">From</label><input type="date" id="exp-filter-from"></div>
    <div class="form-group"><label class="form-label">To</label><input type="date" id="exp-filter-to"></div>
    <div class="form-group"><label class="form-label">Project</label><select id="exp-filter-project"><option value="">All Projects</option></select></div>
    <div class="form-group"><label class="form-label">Category</label>
      <select id="exp-filter-cat"><option value="">All</option><option>Travel</option><option>Meals</option><option>Mileage</option><option>Software</option><option>Office Supplies</option><option>Subcontractor</option><option>Other</option></select>
    </div>
    <button class="btn btn-primary" onclick="renderExpenses()">Filter</button>
  </div>
  <div class="card" style="padding:0;overflow:hidden;">
    <table><thead><tr>
      <th>Date</th><th>Vendor / Description</th><th>Category</th><th>Project</th>
      <th>Miles</th><th>Amount</th><th>Billable</th><th>Reimbursed</th><th></th>
    </tr></thead>
    <tbody id="expenses-body"></tbody>
    <tfoot id="expenses-foot"></tfoot></table>
  </div>
</div>

<!-- REPORTS -->
<div class="view" id="view-reports">
  <div class="page-header">
    <div><div class="page-title">Reports</div><div class="page-sub">Includes billable expenses in totals</div></div>
    <div class="btn-group">
      <button class="btn" onclick="showView('annual')" style="border-color:var(--pink);color:var(--pink);">üìä Annual Summary</button>
      <button class="btn btn-green" onclick="exportCSV()">‚¨á CSV</button>
      <button class="btn" onclick="exportReportWord()" style="border-color:#2b579a;color:#2b579a;">‚¨á Word (.doc)</button>
      <button class="btn" onclick="exportReportPDF()" style="border-color:#c0392b;color:#c0392b;">‚¨á PDF</button>
      <button class="btn btn-orange" onclick="exportTimeQB()">‚¨á QuickBooks</button>
    </div>
  </div>
  <div class="report-controls">
    <div class="form-group"><label class="form-label">From</label><input type="date" id="report-from"></div>
    <div class="form-group"><label class="form-label">To</label><input type="date" id="report-to"></div>
    <div class="form-group"><label class="form-label">Project</label><select id="report-project"><option value="">All Projects</option></select></div>
    <div class="form-group"><label class="form-label">Group By</label>
      <select id="report-group"><option value="project">Project</option><option value="task">Task</option><option value="date">Date</option></select>
    </div>
    <button class="btn btn-primary" onclick="runReport()">Run Report</button>
  </div>
  <div class="report-summary" id="report-summary" style="display:none;"></div>
  <div class="card" style="padding:0;overflow:hidden;">
    <table><thead><tr><th>Group</th><th>Project</th><th>Task / Detail</th><th>Description</th><th>Hours</th><th>Rate</th><th>Amount</th></tr></thead>
    <tbody id="report-body"></tbody>
    <tfoot id="report-foot"></tfoot></table>
  </div>
</div>

<!-- INVOICE -->
<div class="view" id="view-invoice">
  <div class="page-header no-print">
    <div><div class="page-title">Invoice Generator</div><div class="page-sub">Includes billable expenses automatically</div></div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="buildInvoice()">üîÑ Generate Invoice</button>
      <button class="btn btn-orange" onclick="window.print()">üñ® Print / PDF</button>
    </div>
  </div>
  <div class="card no-print" style="margin-bottom:20px;">
    <div class="card-title">Invoice Settings</div>
    <div class="form-row-3">
      <div class="form-group"><label class="form-label">Invoice #</label>
        <div style="display:flex;gap:6px;align-items:center;">
          <input type="text" id="inv-number" readonly style="font-weight:700;color:var(--pink);">
          <button class="btn btn-sm" onclick="manualInvNum()" style="white-space:nowrap">‚úèÔ∏è Edit</button>
        </div>
      </div>
      <div class="form-group"><label class="form-label">Invoice Date</label><input type="date" id="inv-date"></div>
      <div class="form-group"><label class="form-label">Due Date</label><input type="date" id="inv-due"></div>
    </div>
    <div style="border-top:1px solid var(--border);margin:12px 0 16px;padding-top:16px;">
      <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--muted);margin-bottom:12px;">Your Business Information</div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Business Name</label><input type="text" id="inv-from-name" placeholder="CWR Consulting"></div>
        <div class="form-group"><label class="form-label">Full Address (Street, City, State, ZIP)</label><input type="text" id="inv-from-addr1" placeholder="123 Main St, Suite 100, Washington, DC 20001"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Phone Number</label><input type="text" id="inv-from-phone" placeholder="(202) 555-0100"></div>
        <div class="form-group"><label class="form-label">Email</label><input type="text" id="inv-from-email" placeholder="your@email.com"></div>
      </div>
    </div>
    <div style="border-top:1px solid var(--border);margin:4px 0 16px;padding-top:16px;">
      <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--muted);margin-bottom:12px;">Client Information</div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Bill To Project</label>
          <select id="inv-project" onchange="autofillClientFromProject()"><option value="">Select project‚Ä¶</option></select>
        </div>
        <div class="form-group"><label class="form-label">Client Name</label><input type="text" id="inv-client-name" placeholder="Client Company Name"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Client Address</label><input type="text" id="inv-client-addr" placeholder="456 Client Ave, City, State ZIP"></div>
        <div class="form-group"><label class="form-label">Client Phone</label><input type="text" id="inv-client-phone" placeholder="(202) 555-0200"></div>
      </div>
      <div class="form-group"><label class="form-label">Client Email</label><input type="text" id="inv-client-email" placeholder="billing@client.com"></div>
    </div>
    <div style="border-top:1px solid var(--border);margin:4px 0 16px;padding-top:16px;">
      <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--muted);margin-bottom:12px;">Billing Period & Options</div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Date Range</label>
          <div style="display:flex;gap:8px;"><input type="date" id="inv-from" style="flex:1"><input type="date" id="inv-to" style="flex:1"></div>
        </div>
        <div class="form-group"><label class="form-label">Tax Rate (%)</label><input type="number" id="inv-tax" value="0" min="0" max="100" step="0.1"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Payment Terms</label><input type="text" id="inv-terms" value="Net 30 days"></div>
        <div class="form-group"><label class="form-label">Notes / Wire Instructions</label><input type="text" id="inv-notes" placeholder="Thank you for your business!"></div>
      </div>
      <div class="form-group"><label class="form-label">Invoice Footer Text (optional ‚Äî leave blank to hide)</label><input type="text" id="inv-footer-text" placeholder="e.g. Federal EIN: 12-3456789 ¬∑ ACH routing info ¬∑ www.cwrconsulting.com"></div>
    </div>
  </div>
  <div id="invoice-preview-area"></div>
  <div class="card no-print" style="margin-top:24px;" id="invoice-history-card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <div class="card-title" style="margin:0">Invoice History</div>
      <span style="font-size:11px;color:var(--muted)">Mark as Sent to track here</span>
    </div>
    <div id="invoice-history-list"></div>
  </div>
<!-- YEAR-END REPORT -->
<div class="view" id="view-annual">
  <div class="page-header">
    <div><div class="page-title">Annual Summary</div><div class="page-sub">Billable revenue only ¬∑ Click a month row to drill into that month's report</div></div>
    <div class="btn-group">
      <select id="annual-year" onchange="renderAnnual()" style="padding:8px 12px;border-radius:8px;border:1.5px solid var(--border2);background:var(--surface);color:var(--text);font-size:13px;"></select>
      <button class="btn btn-green" onclick="exportAnnualCSV()">‚¨á Export CSV</button>
      <button class="btn" onclick="exportAnnualPDF()" style="border-color:#c0392b;color:#c0392b;">‚¨á PDF</button>
    </div>
  </div>
  <div class="stat-grid" style="grid-template-columns:repeat(4,1fr);margin-bottom:20px;">
    <div class="stat-card pink"><div class="stat-label">Annual Revenue</div><div class="stat-value" id="annual-total">$0</div><div class="stat-sub">billable fees only</div></div>
    <div class="stat-card orange"><div class="stat-label">Total Hours</div><div class="stat-value" id="annual-hours">0</div><div class="stat-sub">logged this year</div></div>
    <div class="stat-card green"><div class="stat-label">Best Month</div><div class="stat-value" id="annual-best-month">‚Äî</div><div class="stat-sub" id="annual-best-amt"></div></div>
    <div class="stat-card teal"><div class="stat-label">Avg / Month</div><div class="stat-value" id="annual-avg">$0</div><div class="stat-sub">billable revenue</div></div>
  </div>
  <div class="dash-grid" style="grid-template-columns:1fr 1fr;margin-bottom:20px;">
    <div class="card"><div class="card-title">Revenue by Month</div><div class="bar-chart" id="annual-bar-chart"></div></div>
    <div class="card"><div class="card-title">Top Clients by Revenue</div><div class="bar-chart" id="annual-client-chart"></div></div>
  </div>
  <div class="card" style="padding:0;overflow:hidden;">
    <table><thead><tr>
      <th>Month</th><th>Billable Hours</th><th>Revenue</th><th>Expenses</th><th>Total</th><th>Top Project</th>
    </tr></thead>
    <tbody id="annual-body"></tbody>
    <tfoot id="annual-foot"></tfoot></table>
  </div>
</div>

<!-- RETAINER TRACKER -->
<div class="view" id="view-retainer">
  <div class="page-header">
    <div><div class="page-title">Retainer Tracker</div><div class="page-sub">Monitor hours burned against monthly retainer agreements</div></div>
    <button class="btn btn-primary" onclick="openRetainerModal()">Ôºã Add Retainer</button>
  </div>
  <div id="retainer-list"></div>
  <div class="card" style="margin-top:20px;padding:0;overflow:hidden;" id="retainer-log-card" style="display:none">
    <div style="padding:16px 20px 12px;display:flex;align-items:center;justify-content:space-between;">
      <div class="card-title" style="margin:0">Recent Retainer Activity</div>
    </div>
    <table><thead><tr><th>Date</th><th>Project</th><th>Task</th><th>Description</th><th>Hours</th></tr></thead>
    <tbody id="retainer-log-body"></tbody></table>
  </div>
</div>
</main>

<!-- ENTRY MODAL (add & edit) -->
<div class="modal-overlay" id="modal-entry">
  <div class="modal">
    <div class="modal-title" id="entry-modal-title">Log Time Entry</div>
    <input type="hidden" id="entry-editing-id">
    <div class="form-row">
      <div class="form-group"><label class="form-label">Date</label><input type="date" id="entry-date"></div>
      <div class="form-group"><label class="form-label">Hours</label><input type="number" id="entry-hours" min="0.25" max="24" step="0.25" placeholder="0.00"></div>
    </div>
    <div class="form-group"><label class="form-label">Project</label>
      <select id="entry-project" onchange="populateTasks()"><option value="">Select project‚Ä¶</option></select>
    </div>
    <div class="form-group"><label class="form-label">Task</label>
      <select id="entry-task"><option value="">Select task‚Ä¶</option></select>
    </div>
    <div class="form-group"><label class="form-label">Description</label>
      <textarea id="entry-desc" rows="3" placeholder="What did you work on?"></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn btn-danger btn-sm" id="entry-delete-btn" style="margin-right:auto;display:none;" onclick="deleteCurrentEntry()">Delete</button>
      <button class="btn" onclick="closeModal('modal-entry')">Cancel</button>
      <button class="btn btn-primary" onclick="saveEntry()">Save Entry</button>
    </div>
  </div>
</div>

<!-- PROJECT MODAL (add & edit) -->
<div class="modal-overlay" id="modal-project">
  <div class="modal">
    <div class="modal-title" id="proj-modal-title">New Project</div>
    <input type="hidden" id="proj-editing-id">
    <div class="form-row">
      <div class="form-group"><label class="form-label">Project Code</label><input type="text" id="proj-code" placeholder="e.g. PROJ-001"></div>
      <div class="form-group"><label class="form-label">Billing Rate ($/hr)</label><input type="number" id="proj-rate" placeholder="150.00" step="0.01"></div>
    </div>
    <div class="form-group"><label class="form-label">Project Name</label><input type="text" id="proj-name" placeholder="Full project name"></div>
    <div class="form-group"><label class="form-label">Client Name</label><input type="text" id="proj-client" placeholder="Client or company name"></div>
    <div class="form-group"><label class="form-label">Client Address</label><input type="text" id="proj-client-addr" placeholder="123 Main St, City, State ZIP"></div>
    <div class="form-group"><label class="form-label">Client Phone</label><input type="text" id="proj-client-phone" placeholder="(202) 555-0200"></div>
    <div class="form-group"><label class="form-label">Client Email</label><input type="text" id="proj-client-email" placeholder="contact@client.com"></div>
    <div class="form-group"><label class="form-label">Task Categories (comma-separated)</label>
      <input type="text" id="proj-tasks" placeholder="Analysis, Design, Development, Review">
    </div>
    <div class="form-group"><label class="form-label">Status</label>
      <select id="proj-status">
        <option value="active-billable">Active ‚Äî Bill to Client</option>
        <option value="active-nonbillable">Active ‚Äî Non-billable</option>
        <option value="inactive-nonbillable">Inactive ‚Äî Non-billable</option>
        <option value="inactive-billed">Inactive ‚Äî Billed to Client</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="btn btn-danger btn-sm" id="proj-delete-btn" style="margin-right:auto;display:none;" onclick="deleteCurrentProject()">Delete Project</button>
      <button class="btn" onclick="closeModal('modal-project')">Cancel</button>
      <button class="btn btn-primary" onclick="saveProject()">Save Project</button>
    </div>
  </div>
</div>

<!-- EXPENSE MODAL (add & edit) -->
<div class="modal-overlay" id="modal-expense">
  <div class="modal">
    <div class="modal-title" id="exp-modal-title">Add Expense</div>
    <input type="hidden" id="exp-editing-id">
    <div class="form-row">
      <div class="form-group"><label class="form-label">Date</label><input type="date" id="exp-date"></div>
      <div class="form-group"><label class="form-label">Amount ($) ‚Äî or leave 0 for mileage-only</label><input type="number" id="exp-amount" step="0.01" placeholder="0.00" value="0"></div>
    </div>
    <div class="form-group"><label class="form-label">Vendor / Description</label><input type="text" id="exp-vendor" placeholder="e.g. Delta Airlines, AWS, Office Depot"></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Category</label>
        <select id="exp-category" onchange="toggleMileage()">
          <option>Travel</option><option>Meals</option><option>Mileage</option><option>Software</option>
          <option>Office Supplies</option><option>Subcontractor</option><option>Other</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">Project (optional)</label>
        <select id="exp-project"><option value="">None / General</option></select>
      </div>
    </div>
    <div id="mileage-section" style="display:none;background:var(--orange-light);border:1.5px solid var(--border);border-radius:10px;padding:14px;margin-bottom:14px;">
      <div style="font-size:11px;font-weight:700;color:var(--orange);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px;">üöó Mileage Calculator</div>
      <div class="form-row">
        <div class="form-group" style="margin:0"><label class="form-label">Miles Driven</label><input type="number" id="exp-miles" step="0.1" placeholder="0.0" oninput="calcMileage()"></div>
        <div class="form-group" style="margin:0"><label class="form-label">Rate per Mile (IRS: $0.67)</label><input type="number" id="exp-mileage-rate" value="0.67" step="0.01" oninput="calcMileage()"></div>
      </div>
      <div style="margin-top:10px;font-size:12px;color:var(--orange);font-weight:600" id="mileage-calc-display"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Billable to Client?</label>
        <select id="exp-billable"><option value="yes">Yes ‚Äî Bill to client</option><option value="no">No ‚Äî Internal cost</option></select>
      </div>
      <div class="form-group"><label class="form-label">Reimbursed?</label>
        <select id="exp-reimbursed"><option value="no">No ‚Äî Pending</option><option value="internal">No ‚Äî Internal Cost</option><option value="yes">Yes ‚Äî Reimbursed</option></select>
      </div>
    </div>
    <div class="form-group"><label class="form-label">Receipt / Notes</label><input type="text" id="exp-receipt" placeholder="Receipt #, notes, or reference"></div>
    <div class="modal-actions">
      <button class="btn btn-danger btn-sm" id="exp-delete-btn" style="margin-right:auto;display:none;" onclick="deleteCurrentExpense()">Delete</button>
      <button class="btn" onclick="closeModal('modal-expense')">Cancel</button>
      <button class="btn btn-primary" onclick="saveExpense()">Save Expense</button>
    </div>
  </div>
</div>

<!-- RETAINER MODAL -->
<div class="modal-overlay" id="modal-retainer">
  <div class="modal">
    <div class="modal-title" id="retainer-modal-title">Add Retainer</div>
    <input type="hidden" id="ret-editing-id">
    <div class="form-row">
      <div class="form-group"><label class="form-label">Retainer Name</label><input type="text" id="ret-name" placeholder="e.g. ACME Monthly Retainer"></div>
      <div class="form-group"><label class="form-label">Project</label><select id="ret-project"><option value="">Select project‚Ä¶</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Monthly Hours Included</label><input type="number" id="ret-hours" min="1" step="0.5" placeholder="20"></div>
      <div class="form-group"><label class="form-label">Monthly Fee ($)</label><input type="number" id="ret-fee" min="0" step="100" placeholder="3000"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Start Date</label><input type="date" id="ret-start"></div>
      <div class="form-group"><label class="form-label">End Date (leave blank if ongoing)</label><input type="date" id="ret-end"></div>
    </div>
    <div class="form-group"><label class="form-label">Notes</label><input type="text" id="ret-notes" placeholder="e.g. Rolls over unused hours, max 5 hrs rollover"></div>
    <div class="modal-actions">
      <button class="btn btn-danger" id="ret-delete-btn" onclick="deleteCurrentRetainer()" style="display:none;margin-right:auto">Delete</button>
      <button class="btn" onclick="closeModal('modal-retainer')">Cancel</button>
      <button class="btn btn-primary" onclick="saveRetainer()">Save Retainer</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ============ DATA ============
let projects = JSON.parse(localStorage.getItem('tt2_projects') || '[]');
let entries  = JSON.parse(localStorage.getItem('tt2_entries')  || '[]');
let expenses = JSON.parse(localStorage.getItem('tt2_expenses') || '[]');
let invoiceHistory  = JSON.parse(localStorage.getItem('tt2_invoices') || '[]');
let invoiceCounter  = parseInt(localStorage.getItem('tt2_inv_counter') || '1');
let retainers = JSON.parse(localStorage.getItem('tt2_retainers') || '[]');
// Business profile (persisted)
let bizProfile = JSON.parse(localStorage.getItem('tt2_biz') || '{}');

function sp()  { localStorage.setItem('tt2_projects', JSON.stringify(projects)); }
function se()  { localStorage.setItem('tt2_entries',  JSON.stringify(entries)); }
function sx()  { localStorage.setItem('tt2_expenses', JSON.stringify(expenses)); }
function sih() { localStorage.setItem('tt2_invoices', JSON.stringify(invoiceHistory)); }
function sbiz(){ localStorage.setItem('tt2_biz', JSON.stringify(bizProfile)); }
function sr()  { localStorage.setItem('tt2_retainers', JSON.stringify(retainers)); }
function gp(id){ return projects.find(p => p.id === id); }
function ge(id){ return entries.find(e => e.id === id); }
function gx(id){ return expenses.find(x => x.id === id); }
function gr(id){ return retainers.find(r => r.id === id); }

function nextInvNum(){ return `CWR-${new Date().getFullYear()}-${String(invoiceCounter).padStart(3,'0')}`; }
function bumpInvCounter(){ invoiceCounter++; localStorage.setItem('tt2_inv_counter', invoiceCounter); }

// Status helper
function statusLabel(s){
  return s==='active-billable'?'Active ‚Äì Bill to Client':
         s==='active-nonbillable'?'Active ‚Äì Non-billable':
         s==='inactive-nonbillable'?'Inactive ‚Äì Non-billable':
         s==='inactive-billed'?'Inactive ‚Äì Billed to Client':
         s||'Active ‚Äì Bill to Client';
}
function statusClass(s){
  return (s||'').startsWith('active') ? 'status-active' : 'status-inactive';
}
function isActiveProject(p){
  return !p.status || p.status.startsWith('active');
}

// Seed demo data
if (projects.length === 0) {
  projects = [
    { id:'p1', code:'ACME-001', name:'ACME Corp Website Redesign', client:'ACME Corporation', clientAddr:'New York, NY 10001', clientPhone:'(212) 555-0100', clientEmail:'projects@acme.com', rate:175, tasks:['Discovery','UX Design','Development','QA','Launch'], status:'active-billable' },
    { id:'p2', code:'BETA-002', name:'Beta Systems ERP Integration', client:'Beta Systems LLC', clientAddr:'Chicago, IL 60601', clientPhone:'(312) 555-0200', clientEmail:'info@beta.com', rate:200, tasks:['Requirements','Architecture','Development','Testing','Documentation'], status:'active-billable' },
    { id:'p3', code:'GEN-003', name:'General Consulting', client:'Various', clientAddr:'', clientPhone:'', clientEmail:'', rate:150, tasks:['Strategy','Advisory','Analysis','Reporting'], status:'active-nonbillable' },
  ];
  sp();
}
if (entries.length === 0) {
  const today = new Date();
  const d = n => { const dt = new Date(today); dt.setDate(dt.getDate()+n); return dt.toISOString().split('T')[0]; };
  entries = [
    {id:'e1',date:d(-6),projectId:'p1',task:'Discovery',desc:'Stakeholder interviews and requirements gathering',hours:4.5},
    {id:'e2',date:d(-6),projectId:'p3',task:'Strategy',desc:'Market analysis report',hours:2},
    {id:'e3',date:d(-5),projectId:'p1',task:'UX Design',desc:'Wireframes for homepage and product pages',hours:6},
    {id:'e4',date:d(-4),projectId:'p2',task:'Requirements',desc:'ERP requirements documentation',hours:5},
    {id:'e5',date:d(-4),projectId:'p2',task:'Architecture',desc:'System architecture review',hours:3},
    {id:'e6',date:d(-3),projectId:'p1',task:'Development',desc:'Frontend component library setup',hours:7},
    {id:'e7',date:d(-2),projectId:'p3',task:'Advisory',desc:'Client advisory call and follow-up',hours:2.5},
    {id:'e8',date:d(-1),projectId:'p2',task:'Development',desc:'API integration module',hours:8},
    {id:'e9',date:d(0),projectId:'p1',task:'UX Design',desc:'Mobile responsive design iterations',hours:5},
    {id:'e10',date:d(0),projectId:'p2',task:'Testing',desc:'Integration test scenarios',hours:3},
  ];
  se();
}

// ============ DARK MODE ============
function toggleDark(){
  document.body.classList.toggle('dark');
  const on = document.body.classList.contains('dark');
  document.getElementById('dark-toggle').classList.toggle('on', on);
  document.getElementById('mode-label').textContent = on ? 'üåô' : '‚òÄÔ∏è';
  localStorage.setItem('tt2_dark', on ? '1' : '0');
}
if (localStorage.getItem('tt2_dark') === '1') {
  document.body.classList.add('dark');
  document.getElementById('dark-toggle').classList.add('on');
  document.getElementById('mode-label').textContent = 'üåô';
}

// ============ TIMER ============
let timerSec=0, timerRunning=false, timerInterval=null, timerProjectId='';
function populateTimerProjects(){
  const sel=document.getElementById('timer-project-select');
  sel.innerHTML='<option value="">Pick project‚Ä¶</option>'+projects.filter(isActiveProject).map(p=>`<option value="${p.id}">${p.code}</option>`).join('');
}
function updateTimerProject(){ timerProjectId=document.getElementById('timer-project-select').value; }
function timerToggle(){
  if(timerRunning){
    clearInterval(timerInterval); timerRunning=false;
    document.getElementById('timer-start-btn').textContent='‚ñ∂';
    document.getElementById('timer-start-btn').className='timer-btn start';
    document.getElementById('timer-display').classList.remove('running');
  } else {
    timerRunning=true;
    document.getElementById('timer-start-btn').textContent='‚è∏';
    document.getElementById('timer-start-btn').className='timer-btn stop';
    document.getElementById('timer-display').classList.add('running');
    timerInterval=setInterval(()=>{
      timerSec++;
      const h=String(Math.floor(timerSec/3600)).padStart(2,'0');
      const m=String(Math.floor((timerSec%3600)/60)).padStart(2,'0');
      const s=String(timerSec%60).padStart(2,'0');
      document.getElementById('timer-display').textContent=`${h}:${m}:${s}`;
    },1000);
  }
}
function timerReset(){
  if(timerRunning)timerToggle();
  timerSec=0;
  document.getElementById('timer-display').textContent='00:00:00';
  document.getElementById('timer-display').classList.remove('running');
}
function timerLog(){
  if(timerSec<60){showToast('Timer needs at least 1 minute');return;}
  if(!timerProjectId){showToast('Please select a project');return;}
  const hours=Math.round((timerSec/3600)*4)/4;
  if(timerRunning)timerToggle();
  openEntryModal(null, timerProjectId, hours);
  timerReset();
}

// ============ NAV ============
let calDate=new Date();
function showView(id){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  document.getElementById('view-'+id).classList.add('active');
  const labels=['dashboard','timesheet','calendar','projects','expenses','reports','annual','retainer','invoice'];
  const idx=labels.indexOf(id);
  if(idx>=0) document.querySelectorAll('nav button')[idx].classList.add('active');
  if(id==='dashboard') renderDashboard();
  if(id==='timesheet') renderTimesheet();
  if(id==='calendar')  renderCalendar();
  if(id==='projects')  renderProjects();
  if(id==='expenses')  initExpenses();
  if(id==='reports')   {initReports();runReport();}
  if(id==='annual')    initAnnual();
  if(id==='retainer')  renderRetainers();
  if(id==='invoice')   initInvoice();
}

// ============ DASHBOARD ============
function renderDashboard(){
  const now=new Date();
  const h=now.getHours();
  document.getElementById('greeting-time').textContent=h<12?'morning':h<17?'afternoon':'evening';
  document.getElementById('dash-date').textContent=now.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});

  const ws=getWeekStart(now), we=new Date(ws); we.setDate(we.getDate()+6);
  const msDate=new Date(now.getFullYear(),now.getMonth(),1);
  const meDate=new Date(now.getFullYear(),now.getMonth()+1,0);
  const msStr=msDate.toISOString().split('T')[0];
  const meStr=meDate.toISOString().split('T')[0];

  const wkE=entries.filter(e=>e.date>=ws.toISOString().split('T')[0]&&e.date<=we.toISOString().split('T')[0]);
  const moE=entries.filter(e=>e.date>=msStr&&e.date<=meStr);

  // Split month entries into strictly billable vs non-billable
  const billableE   =moE.filter(e=>{const p=gp(e.projectId);return p&&p.status==='active-billable';});
  const nonBillableE=moE.filter(e=>{const p=gp(e.projectId);return !p||p.status!=='active-billable';});

  const wkH  =wkE.reduce((s,e)=>s+e.hours,0);
  const billH =billableE.reduce((s,e)=>s+e.hours,0);
  const billAmt=billableE.reduce((s,e)=>{const p=gp(e.projectId);return s+(p?e.hours*p.rate:0);},0);

  const nonBillH  =nonBillableE.reduce((s,e)=>s+e.hours,0);
  const nonBillAmt=nonBillableE.reduce((s,e)=>{const p=gp(e.projectId);return s+(p?e.hours*p.rate:0);},0);
  const nonBillProjs=new Set(nonBillableE.map(e=>e.projectId).filter(Boolean));
  const totalMonthH=billH+nonBillH;
  const nonBillPct=totalMonthH>0?Math.round(nonBillH/totalMonthH*100):0;

  // Top row ‚Äî billable only
  document.getElementById('stat-week').textContent=wkH.toFixed(1);
  document.getElementById('stat-billable').textContent='$'+Math.round(billAmt).toLocaleString();
  document.getElementById('stat-billable-hrs').textContent=billH.toFixed(1)+' billable hrs';
  document.getElementById('stat-projects').textContent=projects.filter(isActiveProject).length;
  document.getElementById('stat-month').textContent=billH.toFixed(1);

  // Non-billable row
  document.getElementById('stat-nonbill-hrs').textContent=nonBillH.toFixed(1);
  document.getElementById('stat-nonbill-proj-count').textContent='across '+nonBillProjs.size+' project'+(nonBillProjs.size!==1?'s':'');
  document.getElementById('stat-nonbill-amt').textContent='$'+Math.round(nonBillAmt).toLocaleString();
  document.getElementById('stat-nonbill-pct').textContent=nonBillPct+'%';
  document.getElementById('stat-nonbill-projs').textContent=nonBillProjs.size;

  // Hours by project bar chart
  const byProj={};
  entries.forEach(e=>{const p=gp(e.projectId);if(!p)return;byProj[p.name]=(byProj[p.name]||0)+e.hours;});
  const sorted=Object.entries(byProj).sort((a,b)=>b[1]-a[1]);
  const maxH=sorted[0]?.[1]||1;
  const clrs=['pink','orange','green'];
  document.getElementById('chart-projects').innerHTML=sorted.length?sorted.map(([name,hrs],i)=>`
    <div class="bar-row"><div class="bar-label" title="${name}">${name}</div>
    <div class="bar-track"><div class="bar-fill ${clrs[i%3]}" style="width:${(hrs/maxH*100).toFixed(1)}%"></div></div>
    <div class="bar-val">${hrs.toFixed(1)}h</div></div>`).join(''):'<div style="color:var(--muted)">No data yet</div>';

  // Recent entries
  const recent=[...entries].sort((a,b)=>b.date.localeCompare(a.date)).slice(0,6);
  const dotClrs=['var(--pink)','var(--orange)','var(--green)'];
  document.getElementById('recent-entries').innerHTML=recent.length?recent.map((e,i)=>{
    const p=gp(e.projectId);
    const isBillable=p&&p.status==='active-billable';
    return `<div class="entry-item" style="cursor:pointer" onclick="openEntryModal('${e.id}')">
      <div class="entry-dot" style="background:${dotClrs[i%3]}"></div>
      <div class="entry-info">
        <div class="entry-project"><span style="color:var(--pink);font-weight:700">${p?p.code:'?'}</span> ‚Äî ${e.task}${isBillable?'':' <span style="font-size:10px;color:var(--muted);font-weight:400">(non-billable)</span>'}</div>
        <div class="entry-meta">${fmtDate(e.date)} ¬∑ ${e.desc.substring(0,52)}${e.desc.length>52?'‚Ä¶':''}</div>
      </div>
      <div class="entry-hours">${e.hours}h</div>
    </div>`;
  }).join(''):'<div class="empty-state"><div class="icon">üìã</div>No entries yet</div>';
}

// ============ TIMESHEET ============
let currentWeek=new Date();
function getWeekStart(d){
  const dt=new Date(d);const day=dt.getDay();
  dt.setDate(dt.getDate()-day+(day===0?-6:1));dt.setHours(0,0,0,0);return dt;
}
function renderTimesheet(){
  const ws=getWeekStart(currentWeek), we=new Date(ws); we.setDate(we.getDate()+6);
  const wsStr=ws.toISOString().split('T')[0], weStr=we.toISOString().split('T')[0];
  document.getElementById('week-label').textContent=`Week of ${ws.toLocaleDateString('en-US',{month:'short',day:'numeric'})} ‚Äì ${we.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}`;
  const wkE=entries.filter(e=>e.date>=wsStr&&e.date<=weStr).sort((a,b)=>a.date.localeCompare(b.date));
  let totH=0,totA=0;
  document.getElementById('timesheet-body').innerHTML=wkE.length?wkE.map(e=>{
    const p=gp(e.projectId);const amt=p?e.hours*p.rate:0;
    totH+=e.hours;totA+=amt;
    const inv=e.invoiced?'<span class="invoiced-badge">‚úì Invoiced</span>':`<button class="btn btn-sm" onclick="event.stopPropagation();markInvoiced('${e.id}')" style="font-size:10px;padding:3px 8px;border-color:var(--green);color:var(--green)">Mark Invoiced</button>`;
    return `<tr class="clickable-row" onclick="openEntryModal('${e.id}')" title="Click to edit">
      <td style="color:var(--muted);white-space:nowrap">${fmtDate(e.date)}</td>
      <td><span class="tag-pink">${p?p.code:'?'}</span> ${p?p.name:'Unknown'}</td>
      <td><span style="background:var(--orange-light);color:var(--orange);border-radius:20px;padding:2px 8px;font-size:11px;font-weight:600">${e.task}</span></td>
      <td style="color:var(--muted);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${e.desc}</td>
      <td class="tag-pink">${e.hours}h</td>
      <td style="color:var(--muted)">$${p?p.rate:0}/hr</td>
      <td class="amt">$${amt.toFixed(2)}</td>
      <td>${inv}</td>
      <td><button class="btn btn-sm btn-danger" onclick="event.stopPropagation();deleteEntryById('${e.id}')">‚úï</button></td>
    </tr>`;
  }).join(''):`<tr><td colspan="9"><div class="empty-state"><div class="icon">‚è±</div>No entries this week. <a href="#" onclick="openEntryModal()" style="color:var(--pink)">Add one?</a></div></td></tr>`;
  document.getElementById('week-total-hrs').textContent=totH.toFixed(1)+'h';
  document.getElementById('timesheet-foot').innerHTML=wkE.length?`<tr><td colspan="4" style="font-weight:600">Week Total</td><td class="tag-pink">${totH.toFixed(1)}h</td><td></td><td class="amt">$${totA.toFixed(2)}</td><td></td><td></td></tr>`:'';
}
function prevWeek(){currentWeek.setDate(currentWeek.getDate()-7);renderTimesheet();}
function nextWeek(){currentWeek.setDate(currentWeek.getDate()+7);renderTimesheet();}
function goToday(){currentWeek=new Date();renderTimesheet();}

// ============ CALENDAR ============
function renderCalendar(){
  const y=calDate.getFullYear(),m=calDate.getMonth();
  document.getElementById('cal-month-label').textContent=calDate.toLocaleDateString('en-US',{month:'long',year:'numeric'});
  const days=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  document.getElementById('cal-header-row').innerHTML=days.map(d=>`<div class="cal-header">${d}</div>`).join('');
  const first=new Date(y,m,1),last=new Date(y,m+1,0);
  let startDow=first.getDay()-1;if(startDow<0)startDow=6;
  const cells=[];
  for(let i=0;i<startDow;i++){const dt=new Date(y,m,1-startDow+i);cells.push({date:dt,other:true});}
  for(let i=1;i<=last.getDate();i++)cells.push({date:new Date(y,m,i),other:false});
  while(cells.length%7!==0){const dt=new Date(y,m+1,cells.length-last.getDate()-startDow+1);cells.push({date:dt,other:true});}
  const todayStr=new Date().toISOString().split('T')[0];
  const entryMap={};
  entries.forEach(e=>{if(!entryMap[e.date])entryMap[e.date]=[];entryMap[e.date].push(e);});
  document.getElementById('cal-grid').innerHTML=cells.map(cell=>{
    const ds=cell.date.toISOString().split('T')[0];
    const dayEntries=entryMap[ds]||[];
    const total=dayEntries.reduce((s,e)=>s+e.hours,0);
    const isToday=ds===todayStr;
    const links=dayEntries.map(e=>{
      const p=gp(e.projectId);
      return `<div class="cal-entry-link" onclick="event.stopPropagation();openEntryModal('${e.id}')" title="${p?p.code:'?'}: ${e.task} (${e.hours}h)">üíó ${p?p.code:'?'}: ${e.hours}h</div>`;
    }).join('');
    return `<div class="cal-day${cell.other?' other-month':''}${isToday?' today':''}${dayEntries.length?' has-entries':''}" onclick="openEntryModal(null,null,null,'${ds}')">
      <div class="cal-day-num">${cell.date.getDate()}</div>
      ${links}
      ${!cell.other ? '<div class="cal-add-btn">+ add</div>' : ''}
      ${total>0 ? '<div class="cal-day-total">'+total+'h</div>' : ''}
    </div>`;
  }).join('');
}
function prevMonth(){calDate.setMonth(calDate.getMonth()-1);renderCalendar();}
function nextMonth(){calDate.setMonth(calDate.getMonth()+1);renderCalendar();}
function goCalToday(){calDate=new Date();renderCalendar();}

// ============ ENTRY MODAL (add + edit) ============
function openEntryModal(editId, preselectProjectId, preselectHours, preselectDate){
  const e = editId ? ge(editId) : null;
  document.getElementById('entry-editing-id').value = editId || '';
  document.getElementById('entry-modal-title').textContent = e ? 'Edit Time Entry' : 'Log Time Entry';
  document.getElementById('entry-delete-btn').style.display = e ? 'inline-flex' : 'none';
  populateProjectSelect('entry-project');
  document.getElementById('entry-date').value    = e ? e.date    : (preselectDate || new Date().toISOString().split('T')[0]);
  document.getElementById('entry-hours').value   = e ? e.hours   : (preselectHours || '');
  document.getElementById('entry-project').value = e ? e.projectId : (preselectProjectId || '');
  populateTasks(e ? e.task : null);
  document.getElementById('entry-task').value    = e ? e.task    : '';
  document.getElementById('entry-desc').value    = e ? e.desc    : '';
  document.getElementById('modal-entry').classList.add('open');
}
function openAddEntry(){ openEntryModal(); }
function populateProjectSelect(selId){
  document.getElementById(selId).innerHTML='<option value="">Select project‚Ä¶</option>'+
    projects.filter(isActiveProject).map(p=>`<option value="${p.id}">${p.code} ‚Äî ${p.name}</option>`).join('');
}
function populateTasks(selectTask){
  const p=gp(document.getElementById('entry-project').value);
  document.getElementById('entry-task').innerHTML=p?p.tasks.map(t=>`<option value="${t}">${t}</option>`).join(''):'<option value="">Select task‚Ä¶</option>';
  if(selectTask) document.getElementById('entry-task').value=selectTask;
}
function saveEntry(){
  const editId=document.getElementById('entry-editing-id').value;
  const date=document.getElementById('entry-date').value;
  const hours=parseFloat(document.getElementById('entry-hours').value);
  const projectId=document.getElementById('entry-project').value;
  const task=document.getElementById('entry-task').value;
  const desc=document.getElementById('entry-desc').value;
  if(!date||!hours||!projectId||!task){showToast('Please fill all required fields');return;}
  if(editId){
    const e=ge(editId);
    if(e){e.date=date;e.hours=hours;e.projectId=projectId;e.task=task;e.desc=desc;}
    showToast('Entry updated ‚úì');
  } else {
    entries.push({id:'e'+Date.now(),date,projectId,task,desc,hours});
    showToast('Entry saved! ‚úì');
  }
  se(); closeModal('modal-entry');
  const av=document.querySelector('.view.active').id;
  if(av==='view-timesheet')renderTimesheet();
  if(av==='view-calendar')renderCalendar();
  if(av==='view-dashboard')renderDashboard();
}
function deleteCurrentEntry(){
  const id=document.getElementById('entry-editing-id').value;
  if(id&&confirm('Delete this time entry? This cannot be undone.')){entries=entries.filter(e=>e.id!==id);se();closeModal('modal-entry');renderTimesheet();showToast('Entry deleted');}
}
function deleteEntryById(id){if(confirm('Delete this time entry? This cannot be undone.')){entries=entries.filter(e=>e.id!==id);se();renderTimesheet();showToast('Entry deleted');}}
function markInvoiced(id){
  const e=ge(id);
  if(e){e.invoiced=true;e.invoicedDate=new Date().toISOString().split('T')[0];se();renderTimesheet();showToast('Marked as invoiced ‚úì');}
}

// ============ PROJECTS (add + edit) ============
function renderProjects(){
  const grid=document.getElementById('projects-grid');
  grid.innerHTML=projects.length?projects.map(p=>`
    <div class="project-card" onclick="openProjectModal('${p.id}')" title="Click to edit">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div>
          <div class="project-code">${p.code}</div>
          <div class="project-name">${p.name}</div>
          <div class="project-client">${p.client}</div>
        </div>
        <span class="status-badge ${statusClass(p.status)}">${statusLabel(p.status)}</span>
      </div>
      <div class="project-rate">$${p.rate}/hr</div>
      <div class="project-tasks">${p.tasks.map(t=>'<span class="task-pill">'+t+'</span>').join('')}</div>
      <div class="project-card-footer">
        <div style="font-size:11px;color:var(--muted)">${entries.filter(e=>e.projectId===p.id).reduce((s,e)=>s+e.hours,0).toFixed(1)} hrs logged ¬∑ ‚úèÔ∏è click to edit</div>
      </div>
    </div>`).join(''):`<div class="empty-state" style="grid-column:1/-1"><div class="icon">üìÅ</div>No projects yet.</div>`;
}
function openProjectModal(editId){
  const p=editId?projects.find(x=>x.id===editId):null;
  document.getElementById('proj-editing-id').value=editId||'';
  document.getElementById('proj-modal-title').textContent=p?'Edit Project':'New Project';
  document.getElementById('proj-delete-btn').style.display=p?'inline-flex':'none';
  document.getElementById('proj-code').value=p?p.code:'';
  document.getElementById('proj-name').value=p?p.name:'';
  document.getElementById('proj-client').value=p?p.client:'';
  document.getElementById('proj-client-addr').value=p?p.clientAddr||'':'';
  document.getElementById('proj-client-phone').value=p?p.clientPhone||'':'';
  document.getElementById('proj-client-email').value=p?p.clientEmail||'':'';
  document.getElementById('proj-tasks').value=p?p.tasks.join(', '):'';
  document.getElementById('proj-rate').value=p?p.rate:'';
  document.getElementById('proj-status').value=p?p.status:'active-billable';
  document.getElementById('modal-project').classList.add('open');
}
function saveProject(){
  const editId=document.getElementById('proj-editing-id').value;
  const code=document.getElementById('proj-code').value.trim();
  const name=document.getElementById('proj-name').value.trim();
  const client=document.getElementById('proj-client').value.trim();
  const clientAddr=document.getElementById('proj-client-addr').value.trim();
  const clientPhone=document.getElementById('proj-client-phone').value.trim();
  const clientEmail=document.getElementById('proj-client-email').value.trim();
  const tasks=document.getElementById('proj-tasks').value.split(',').map(t=>t.trim()).filter(Boolean);
  const rate=parseFloat(document.getElementById('proj-rate').value);
  const status=document.getElementById('proj-status').value;
  if(!code||!name||!rate||tasks.length===0){showToast('Please fill all required fields');return;}
  if(editId){
    const p=projects.find(x=>x.id===editId);
    if(p){Object.assign(p,{code,name,client,clientAddr,clientPhone,clientEmail,tasks,rate,status});}
    showToast('Project updated ‚úì');
  } else {
    projects.push({id:'p'+Date.now(),code,name,client,clientAddr,clientPhone,clientEmail,tasks,rate,status});
    showToast('Project created!');
  }
  sp(); closeModal('modal-project'); renderProjects(); populateTimerProjects();
}
function deleteCurrentProject(){
  const id=document.getElementById('proj-editing-id').value;
  if(id&&confirm('Delete this project? Time entries linked to it will remain.')){
    projects=projects.filter(p=>p.id!==id);sp();closeModal('modal-project');renderProjects();showToast('Project deleted');
  }
}

// ============ EXPENSES (add + edit) ============
function toggleMileage(){
  const cat=document.getElementById('exp-category').value;
  document.getElementById('mileage-section').style.display=cat==='Mileage'?'block':'none';
}
function calcMileage(){
  const miles=parseFloat(document.getElementById('exp-miles').value)||0;
  const rate=parseFloat(document.getElementById('exp-mileage-rate').value)||0.67;
  const amt=(miles*rate);
  document.getElementById('exp-amount').value=amt.toFixed(2);
  document.getElementById('mileage-calc-display').textContent=`${miles} miles √ó $${rate}/mi = $${amt.toFixed(2)}`;
}
function initExpenses(){
  const today=new Date();
  const ms=new Date(today.getFullYear(),today.getMonth(),1);
  document.getElementById('exp-filter-from').value=ms.toISOString().split('T')[0];
  document.getElementById('exp-filter-to').value=today.toISOString().split('T')[0];
  document.getElementById('exp-filter-project').innerHTML='<option value="">All Projects</option>'+
    projects.map(p=>`<option value="${p.id}">${p.code} ‚Äî ${p.name}</option>`).join('');
  renderExpenses();
}
function renderExpenses(){
  const from=document.getElementById('exp-filter-from').value;
  const to=document.getElementById('exp-filter-to').value;
  const pid=document.getElementById('exp-filter-project').value;
  const cat=document.getElementById('exp-filter-cat').value;
  let filtered=expenses.filter(e=>e.date>=from&&e.date<=to);
  if(pid)filtered=filtered.filter(e=>e.projectId===pid);
  if(cat)filtered=filtered.filter(e=>e.category===cat);
  filtered.sort((a,b)=>b.date.localeCompare(a.date));
  const today=new Date();
  const ms=new Date(today.getFullYear(),today.getMonth(),1).toISOString().split('T')[0];
  const me=today.toISOString().split('T')[0];
  document.getElementById('exp-stat-month').textContent='$'+expenses.filter(e=>e.date>=ms&&e.date<=me).reduce((s,e)=>s+e.amount,0).toFixed(2);
  document.getElementById('exp-stat-unreimb').textContent='$'+expenses.filter(e=>e.reimbursed==='no').reduce((s,e)=>s+e.amount,0).toFixed(2);
  document.getElementById('exp-stat-billable').textContent='$'+expenses.filter(e=>e.billable==='yes').reduce((s,e)=>s+e.amount,0).toFixed(2);
  const catColors={Travel:'var(--orange)',Meals:'var(--green)',Mileage:'#0891b2',Software:'var(--pink)','Office Supplies':'#0891b2',Subcontractor:'#7c3aed',Other:'var(--muted)'};
  let totalAmt=0;
  document.getElementById('expenses-body').innerHTML=filtered.length?filtered.map(e=>{
    const p=gp(e.projectId);totalAmt+=e.amount;
    const cc=catColors[e.category]||'var(--muted)';
    const milesCell=e.miles?`${e.miles} mi`:'‚Äî';
    return `<tr class="clickable-row" onclick="openExpenseModal('${e.id}')" title="Click to edit">
      <td style="color:var(--muted);white-space:nowrap">${fmtDate(e.date)}</td>
      <td style="font-weight:500">${e.vendor}</td>
      <td><span style="background:${cc}22;color:${cc};border-radius:20px;padding:2px 9px;font-size:11px;font-weight:600">${e.category}</span></td>
      <td>${p ? '<span class="tag-pink">'+p.code+'</span>' : '<span style="color:var(--muted)">‚Äî</span>'}</td>
      <td style="color:var(--muted)">${milesCell}</td>
      <td style="font-weight:600">$${e.amount.toFixed(2)}</td>
      <td>${e.billable==='yes'?'<span class="invoiced-badge">Billable</span>':'<span style="color:var(--muted);font-size:11px">Internal</span>'}</td>
      <td>${e.reimbursed==='yes' ? '<span class="invoiced-badge">‚úì Reimbursed</span>' : e.reimbursed==='internal' ? '<span style="background:var(--surface2);color:var(--muted);border-radius:20px;padding:2px 8px;font-size:11px;font-weight:600">Internal</span>' : '<button class="btn btn-sm" style="font-size:10px;padding:3px 8px;border-color:var(--orange);color:var(--orange)" onclick="event.stopPropagation();markReimbursed(\''+e.id+'\')">Mark Paid</button>'}</td>
      <td><button class="btn btn-sm btn-danger" onclick="event.stopPropagation();deleteExpenseById('${e.id}')">‚úï</button></td>
    </tr>`;
  }).join(''):`<tr><td colspan="9"><div class="empty-state"><div class="icon">üßæ</div>No expenses found.</div></td></tr>`;
  document.getElementById('expenses-foot').innerHTML=filtered.length?`<tr><td colspan="5" style="font-weight:700;padding-left:14px">Total</td><td style="font-weight:700;color:var(--orange)">$${totalAmt.toFixed(2)}</td><td colspan="3"></td></tr>`:'';
}
function openExpenseModal(editId){
  const x=editId?gx(editId):null;
  document.getElementById('exp-editing-id').value=editId||'';
  document.getElementById('exp-modal-title').textContent=x?'Edit Expense':'Add Expense';
  document.getElementById('exp-delete-btn').style.display=x?'inline-flex':'none';
  document.getElementById('exp-project').innerHTML='<option value="">None / General</option>'+
    projects.filter(isActiveProject).map(p=>`<option value="${p.id}">${p.code} ‚Äî ${p.name}</option>`).join('');
  document.getElementById('exp-date').value=x?x.date:new Date().toISOString().split('T')[0];
  document.getElementById('exp-amount').value=x?x.amount:'0';
  document.getElementById('exp-vendor').value=x?x.vendor:'';
  document.getElementById('exp-category').value=x?x.category:'Travel';
  document.getElementById('exp-project').value=x?x.projectId:'';
  document.getElementById('exp-billable').value=x?x.billable:'yes';
  document.getElementById('exp-reimbursed').value=x?x.reimbursed:'no';
  document.getElementById('exp-receipt').value=x?x.receipt:'';
  document.getElementById('exp-miles').value=x?x.miles||'':'';
  document.getElementById('exp-mileage-rate').value=x?x.mileageRate||0.67:0.67;
  document.getElementById('mileage-calc-display').textContent='';
  toggleMileage();
  document.getElementById('modal-expense').classList.add('open');
}
function openAddExpense(){ openExpenseModal(); }
function saveExpense(){
  const editId=document.getElementById('exp-editing-id').value;
  const date=document.getElementById('exp-date').value;
  const amount=parseFloat(document.getElementById('exp-amount').value)||0;
  const vendor=document.getElementById('exp-vendor').value.trim();
  const category=document.getElementById('exp-category').value;
  const projectId=document.getElementById('exp-project').value;
  const billable=document.getElementById('exp-billable').value;
  const reimbursed=document.getElementById('exp-reimbursed').value;
  const receipt=document.getElementById('exp-receipt').value.trim();
  const miles=parseFloat(document.getElementById('exp-miles').value)||0;
  const mileageRate=parseFloat(document.getElementById('exp-mileage-rate').value)||0.67;
  if(!date||!vendor){showToast('Please fill date and vendor');return;}
  const rec={date,amount,vendor,category,projectId,billable,reimbursed,receipt,miles,mileageRate};
  if(editId){
    const x=gx(editId);if(x)Object.assign(x,rec);showToast('Expense updated ‚úì');
  } else {
    expenses.push({id:'x'+Date.now(),...rec});showToast('Expense saved! ‚úì');
  }
  sx();closeModal('modal-expense');renderExpenses();
}
function deleteCurrentExpense(){
  const id=document.getElementById('exp-editing-id').value;
  if(id&&confirm('Delete this expense? This cannot be undone.')){expenses=expenses.filter(x=>x.id!==id);sx();closeModal('modal-expense');renderExpenses();showToast('Expense deleted');}
}
function deleteExpenseById(id){if(confirm('Delete this expense? This cannot be undone.')){expenses=expenses.filter(x=>x.id!==id);sx();renderExpenses();showToast('Expense deleted');}}
function markReimbursed(id){const x=gx(id);if(x){x.reimbursed='yes';sx();renderExpenses();showToast('Marked as reimbursed ‚úì');}}
function exportExpensesCSV(){
  const rows=[['Date','Vendor','Category','Project','Miles','Amount','Billable','Reimbursed','Receipt']];
  expenses.forEach(e=>{const p=gp(e.projectId);rows.push([e.date,e.vendor,e.category,p?p.name:'',e.miles||0,e.amount.toFixed(2),e.billable,e.reimbursed,e.receipt]);});
  dl(rows.map(r=>r.map(v=>'"'+v+'"').join(',')).join('\n'),'text/csv','CWR-expenses-'+td()+'.csv');
  showToast('Expenses CSV exported ‚úì');
}
function exportExpensesQB(){
  const lines=['!TRNS\tTRNSTYPE\tDATE\tACCNT\tNAME\tAMOUNT\tMEMO\tCLASS','!SPL\tTRNSTYPE\tDATE\tACCNT\tNAME\tAMOUNT\tMEMO\tCLASS','!ENDTRNS'];
  expenses.forEach(e=>{
    const p=gp(e.projectId);const ds=new Date(e.date+'T12:00:00').toLocaleDateString('en-US');
    const acct=e.category==='Travel'?'Travel & Entertainment':e.category==='Meals'?'Meals & Entertainment':e.category==='Software'?'Software Subscriptions':e.category==='Mileage'?'Vehicle & Mileage':e.category==='Subcontractor'?'Contract Labor':'Office Expenses';
    lines.push(`TRNS\tEXPENSE\t${ds}\tChecking\t${e.vendor}\t-${e.amount.toFixed(2)}\t${e.vendor}\t${p?p.name:''}`);
    lines.push(`SPL\tEXPENSE\t${ds}\t${acct}\t${e.vendor}\t${e.amount.toFixed(2)}\t${e.category}\t${p?p.name:''}`);
    lines.push('ENDTRNS');
  });
  dl(lines.join('\n'),'text/plain','CWR-expenses-QB-'+td()+'.iif');
  showToast('QuickBooks IIF exported ‚úì');
}

// ============ REPORTS ============
function initReports(){
  const today=new Date();
  document.getElementById('report-from').value=new Date(today.getFullYear(),today.getMonth(),1).toISOString().split('T')[0];
  document.getElementById('report-to').value=today.toISOString().split('T')[0];
  document.getElementById('report-project').innerHTML='<option value="">All Projects</option>'+
    projects.map(p=>`<option value="${p.id}">${p.code} ‚Äî ${p.name}</option>`).join('');
}
function runReport(){
  const from=document.getElementById('report-from').value;
  const to=document.getElementById('report-to').value;
  const pid=document.getElementById('report-project').value;
  const groupBy=document.getElementById('report-group').value;
  let filtered=entries.filter(e=>e.date>=from&&e.date<=to);
  if(pid)filtered=filtered.filter(e=>e.projectId===pid);
  const billExpenses=expenses.filter(e=>e.date>=from&&e.date<=to&&e.billable==='yes'&&(!pid||e.projectId===pid));
  const expTotal=billExpenses.reduce((s,e)=>s+e.amount,0);

  // Generate written summary
  const totalHrs=filtered.reduce((s,e)=>s+e.hours,0);
  const totalAmt=filtered.reduce((s,e)=>{const p=gp(e.projectId);return s+(p?e.hours*p.rate:0);},0)+expTotal;
  const projSet={};filtered.forEach(e=>{const p=gp(e.projectId);if(p)projSet[p.name]=(projSet[p.name]||0)+e.hours;});
  const projNames=Object.entries(projSet).sort((a,b)=>b[1]-a[1]);
  const dateFrom=fmtDateLong(from),dateTo=fmtDateLong(to);
  let summary=`<strong>Summary for ${dateFrom} ‚Äì ${dateTo}:</strong> `;
  if(filtered.length===0){summary+='No time entries were recorded in this period.';}
  else {
    summary+=`A total of <strong>${totalHrs.toFixed(1)} hours</strong> were logged across <strong>${projNames.length} project${projNames.length!==1?'s':''}</strong>, generating <strong>$${totalAmt.toFixed(2)}</strong> in billable fees`;
    if(expTotal>0) summary+=` (including <strong>$${expTotal.toFixed(2)}</strong> in billable expenses)`;
    summary+='. ';
    if(projNames.length>0){
      summary+=`The largest share of time was devoted to <strong>${projNames[0][0]}</strong> (${projNames[0][1].toFixed(1)} hrs)`;
    if(projNames.length>1) summary+=', followed by '+projNames.slice(1).map(([n,h])=>'<strong>'+n+'</strong> ('+h.toFixed(1)+' hrs)').join(', ');      summary+='. ';
    }
    const taskSet={};filtered.forEach(e=>{taskSet[e.task]=(taskSet[e.task]||0)+e.hours;});
    const topTasks=Object.entries(taskSet).sort((a,b)=>b[1]-a[1]).slice(0,3);
    if(topTasks.length>0) summary+='Primary activities included: '+topTasks.map(([t,h])=>t+' ('+h.toFixed(1)+' hrs)').join(', ')+'. ';
    if(billExpenses.length>0) summary+=`${billExpenses.length} billable expense${billExpenses.length!==1?'s were':' was'} recorded totaling <strong>$${expTotal.toFixed(2)}</strong>.`;
  }
  const summaryEl=document.getElementById('report-summary');
  summaryEl.style.display='block';
  summaryEl.innerHTML=summary;

  // Build grouped rows (time)
  const groups={};
  filtered.forEach(e=>{
    const p=gp(e.projectId);
    const key=groupBy==='project'?(p?p.name:'Unknown'):groupBy==='task'?e.task:e.date;
    if(!groups[key])groups[key]={entries:[],project:p};
    groups[key].entries.push(e);
  });
  let totH=0,totA=0;
  const rows=Object.entries(groups).sort((a,b)=>a[0].localeCompare(b[0])).map(([key,data])=>{
    const hrs=data.entries.reduce((s,e)=>s+e.hours,0);
    const amt=data.entries.reduce((s,e)=>{const p=gp(e.projectId);return s+(p?e.hours*p.rate:0);},0);
    totH+=hrs;totA+=amt;
    const p=data.project;
    const proj=p?'<span class="tag-pink">'+p.code+'</span> '+p.name:'Various';
    const task=groupBy==='task'?key:data.entries.map(e=>e.task).filter((v,i,a)=>a.indexOf(v)===i).slice(0,3).join(', ');
    const desc=data.entries.map(e=>e.desc).filter(Boolean).filter((v,i,a)=>a.indexOf(v)===i).slice(0,2).join(' ¬∑ ');
    return `<tr><td style="font-weight:600">${groupBy==='date'?fmtDate(key):key}</td><td>${proj}</td><td style="color:var(--muted)">${task}</td><td style="color:var(--muted);font-size:12px;max-width:200px">${desc}</td><td class="tag-pink">${hrs.toFixed(1)}h</td><td style="color:var(--muted)">${p?'$'+p.rate+'/hr':'‚Äî'}</td><td class="amt">$${amt.toFixed(2)}</td></tr>`;
  });
  // Billable expenses rows
  const expRows=billExpenses.map(e=>{
    const p=gp(e.projectId);
    return `<tr style="background:var(--orange-light)"><td style="color:var(--muted);font-size:11px">${fmtDate(e.date)}</td><td><span style="color:var(--orange);font-weight:600">${p?p.code:'EXP'}</span> ${e.vendor}</td><td style="color:var(--muted)">${e.category}${e.miles?' ¬∑ '+e.miles+' mi':''}</td><td style="color:var(--muted);font-size:12px">${e.receipt||''}</td><td style="color:var(--muted)">‚Äî</td><td style="color:var(--muted)">Expense</td><td class="amt">$${e.amount.toFixed(2)}</td></tr>`;
  });
  const grandTotal=totA+expTotal;
  document.getElementById('report-body').innerHTML=(rows.length||expRows.length)?
    (rows.length?`<tr><td colspan="7" style="background:var(--surface2);font-size:11px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;color:var(--muted);padding:8px 14px">Time Entries</td></tr>`+rows.join(''):'')
    +(expRows.length?`<tr><td colspan="7" style="background:var(--orange-light);font-size:11px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;color:var(--orange);padding:8px 14px">Billable Expenses</td></tr>`+expRows.join(''):'')
    :`<tr><td colspan="7"><div class="empty-state"><div class="icon">üìä</div>No data</div></td></tr>`;
  document.getElementById('report-foot').innerHTML=rows.length||expRows.length?`<tr>
    <td colspan="4" style="font-weight:700;padding-left:14px">Grand Total</td>
    <td class="tag-pink">${totH.toFixed(1)}h</td><td></td>
    <td class="amt" style="font-weight:700">$${grandTotal.toFixed(2)}</td></tr>`:'';
}
function exportCSV(){
  const from=document.getElementById('report-from').value,to=document.getElementById('report-to').value;
  const rows=[['Type','Date','Project Code','Project Name','Client','Task/Vendor','Description','Hours','Rate','Amount']];
  entries.filter(e=>e.date>=from&&e.date<=to).forEach(e=>{
    const p=gp(e.projectId);rows.push(['Time',e.date,p?.code||'',p?.name||'',p?.client||'',e.task,'"'+e.desc+'"',e.hours,p?.rate||0,((p?.rate||0)*e.hours).toFixed(2)]);
  });
  expenses.filter(e=>e.date>=from&&e.date<=to&&e.billable==='yes').forEach(e=>{
    const p=gp(e.projectId);rows.push(['Expense',e.date,p?.code||'','',p?.client||'',e.category,'"'+e.vendor+'"',e.miles||0,e.mileageRate||0,e.amount.toFixed(2)]);
  });
  dl(rows.map(r=>r.join(',')).join('\n'),'text/csv','CWR-report-'+from+'-to-'+to+'.csv');
  showToast('CSV exported ‚úì');
}

function getReportData(){
  const from=document.getElementById('report-from').value;
  const to=document.getElementById('report-to').value;
  const pid=document.getElementById('report-project').value;
  const groupBy=document.getElementById('report-group').value;
  let filtered=entries.filter(e=>e.date>=from&&e.date<=to);
  if(pid)filtered=filtered.filter(e=>e.projectId===pid);
  const billExpenses=expenses.filter(e=>e.date>=from&&e.date<=to&&e.billable==='yes'&&(!pid||e.projectId===pid));
  const groups={};
  filtered.forEach(e=>{
    const p=gp(e.projectId);
    const key=groupBy==='project'?(p?p.name:'Unknown'):groupBy==='task'?e.task:e.date;
    if(!groups[key])groups[key]={entries:[],project:p};
    groups[key].entries.push(e);
  });
  const rows=Object.entries(groups).sort((a,b)=>a[0].localeCompare(b[0])).map(([key,data])=>{
    const p=data.project;
    const hrs=data.entries.reduce((s,e)=>s+e.hours,0);
    const amt=data.entries.reduce((s,e)=>{const pp=gp(e.projectId);return s+(pp?e.hours*pp.rate:0);},0);
    const task=groupBy==='task'?key:data.entries.map(e=>e.task).filter((v,i,a)=>a.indexOf(v)===i).slice(0,3).join(', ');
    const desc=data.entries.map(e=>e.desc).filter(Boolean).filter((v,i,a)=>a.indexOf(v)===i).slice(0,2).join(' ¬∑ ');
    return {group:groupBy==='date'?fmtDate(key):key,proj:p?p.code+' '+p.name:'Various',task,desc,hrs,rate:p?'$'+p.rate+'/hr':'‚Äî',amt};
  });
  const expRows=billExpenses.map(e=>{const p=gp(e.projectId);return {group:fmtDate(e.date),proj:p?p.code:'EXP',task:e.category,desc:e.vendor+(e.miles?' ('+e.miles+' mi)':''),hrs:0,rate:'Expense',amt:e.amount};});
  const totH=rows.reduce((s,r)=>s+r.hrs,0);
  const totA=rows.reduce((s,r)=>s+r.amt,0)+expRows.reduce((s,r)=>s+r.amt,0);
  const summary=document.getElementById('report-summary').innerText||'';
  return {from,to,rows,expRows,totH,totA,summary,pid};
}

function exportReportWord(){
  const {from,to,rows,expRows,totH,totA,summary}=getReportData();
  const htmlDoc='<!DOCTYPE html><html><head><meta charset="UTF-8">'
    +'<style>body{font-family:Arial,sans-serif;margin:40px;color:#1a1612;font-size:12pt}'
    +'h1{color:#e8187a;font-size:20pt;margin-bottom:4px}'
    +'h2{font-size:13pt;color:#4a4540;margin:24px 0 8px;border-bottom:1.5px solid #e8e4de;padding-bottom:4px}'
    +'.summary{background:#fce8f2;border-left:4px solid #e8187a;padding:12px 16px;margin:16px 0;border-radius:4px;font-size:11pt;line-height:1.7}'
    +'table{width:100%;border-collapse:collapse;margin:12px 0;font-size:10.5pt}'
    +'th{background:#e8187a;color:#fff;text-align:left;padding:8px 10px;font-size:10pt}'
    +'td{padding:7px 10px;border-bottom:1px solid #e8e4de}'
    +'tr:nth-child(even) td{background:#faf9f7}'
    +'.section-row td{background:#f8f6f2;font-weight:700;color:#4a4540;font-size:10pt;text-transform:uppercase;letter-spacing:.5px}'
    +'.exp-row td{background:#fff0e8}'
    +'.total-row td{font-weight:700;background:#f8f6f2}'
    +'.amt{color:#15803d;font-weight:600}'
    +'.footer{margin-top:32px;font-size:9pt;color:#8a847c;border-top:1px solid #e8e4de;padding-top:12px}'
    +'</style></head><body>'
    +'<h1>CWR Consulting ‚Äî Activity Report</h1>'
    +'<div style="color:#8a847c;font-size:10pt;margin-bottom:12px">Period: '+fmtDateLong(from)+' ‚Äì '+fmtDateLong(to)+' &nbsp;¬∑&nbsp; Generated '+new Date().toLocaleDateString()+'</div>'
    +(summary?'<div class="summary">'+summary+'</div>':'')
    +'<h2>Time Entries</h2>'
    +'<table><thead><tr><th>Group</th><th>Project</th><th>Task</th><th>Description</th><th>Hours</th><th>Rate</th><th>Amount</th></tr></thead><tbody>'
    +rows.map(r=>'<tr><td><strong>'+r.group+'</strong></td><td>'+r.proj+'</td><td>'+r.task+'</td><td style="color:#8a847c;font-size:10pt">'+r.desc+'</td><td>'+r.hrs.toFixed(1)+'h</td><td style="color:#8a847c">'+r.rate+'</td><td class="amt">$'+r.amt.toFixed(2)+'</td></tr>').join('')
    +(expRows.length?'<tr class="section-row"><td colspan="7">Billable Expenses</td></tr>'+expRows.map(r=>'<tr class="exp-row"><td>'+r.group+'</td><td>'+r.proj+'</td><td>'+r.task+'</td><td style="color:#8a847c">'+r.desc+'</td><td>‚Äî</td><td style="color:#8a847c">Expense</td><td class="amt">$'+r.amt.toFixed(2)+'</td></tr>').join(''):'')
    +'<tr class="total-row"><td colspan="4"><strong>Grand Total</strong></td><td>'+totH.toFixed(1)+'h</td><td></td><td class="amt">$'+totA.toFixed(2)+'</td></tr>'
    +'</tbody></table>'
    +'<div class="footer">CWR Consulting ¬∑ TimeTrack Pro ¬∑ Confidential</div>'
    +'</body></html>';
  dl(htmlDoc,'application/msword','CWR-Report-'+from+'-to-'+to+'.doc');
  showToast('Word document exported ‚úì');
}

function exportReportPDF(){
  const {from,to,rows,expRows,totH,totA,summary}=getReportData();
  // Build a print-ready HTML page and open in new window for Save as PDF
  const win=window.open('','_blank');
  win.document.write('<!DOCTYPE html><html><head><meta charset="UTF-8"><title>CWR Report '+from+' to '+to+'</title>'
    +'<style>@page{margin:0.75in}body{font-family:Arial,sans-serif;color:#1a1612;font-size:11pt;margin:0}'
    +'h1{color:#e8187a;font-size:19pt;margin-bottom:4px}'
    +'h2{font-size:12pt;color:#4a4540;margin:20px 0 6px;border-bottom:1.5px solid #e8e4de;padding-bottom:3px}'
    +'.summary{background:#fce8f2;border-left:4px solid #e8187a;padding:10px 14px;margin:14px 0;border-radius:4px;font-size:10.5pt;line-height:1.7}'
    +'table{width:100%;border-collapse:collapse;margin:10px 0;font-size:10pt}'
    +'th{background:#e8187a;color:#fff;text-align:left;padding:7px 9px;font-size:9.5pt}'
    +'td{padding:6px 9px;border-bottom:1px solid #e8e4de}'
    +'tr:nth-child(even) td{background:#faf9f7}'
    +'.section-row td{background:#f8f6f2;font-weight:700;color:#4a4540;font-size:9pt;text-transform:uppercase}'
    +'.exp-row td{background:#fff0e8}'
    +'.total-row td{font-weight:700;background:#f0ede8;font-size:11pt}'
    +'.amt{color:#15803d;font-weight:600}'
    +'.footer{margin-top:28px;font-size:8.5pt;color:#8a847c;border-top:1px solid #e8e4de;padding-top:10px;text-align:center}'
    +'</style></head><body>'
    +'<h1>CWR Consulting</h1>'
    +'<div style="color:#8a847c;font-size:10pt;margin-bottom:10px"><strong>Activity Report</strong> &nbsp;¬∑&nbsp; '+fmtDateLong(from)+' ‚Äì '+fmtDateLong(to)+' &nbsp;¬∑&nbsp; Generated '+new Date().toLocaleDateString()+'</div>'
    +(summary?'<div class="summary">'+summary+'</div>':'')
    +'<h2>Time Entries</h2>'
    +'<table><thead><tr><th>Group</th><th>Project</th><th>Task</th><th>Description</th><th>Hours</th><th>Rate</th><th>Amount</th></tr></thead><tbody>'
    +rows.map(r=>'<tr><td><strong>'+r.group+'</strong></td><td>'+r.proj+'</td><td>'+r.task+'</td><td style="color:#8a847c;font-size:9.5pt">'+r.desc+'</td><td>'+r.hrs.toFixed(1)+'h</td><td style="color:#8a847c">'+r.rate+'</td><td class="amt">$'+r.amt.toFixed(2)+'</td></tr>').join('')
    +(expRows.length?'<tr class="section-row"><td colspan="7">Billable Expenses</td></tr>'+expRows.map(r=>'<tr class="exp-row"><td>'+r.group+'</td><td>'+r.proj+'</td><td>'+r.task+'</td><td style="color:#8a847c">'+r.desc+'</td><td>‚Äî</td><td style="color:#8a847c">Expense</td><td class="amt">$'+r.amt.toFixed(2)+'</td></tr>').join(''):'')
    +'<tr class="total-row"><td colspan="4"><strong>Grand Total</strong></td><td>'+totH.toFixed(1)+'h</td><td></td><td class="amt">$'+totA.toFixed(2)+'</td></tr>'
    +'</tbody></table>'
    +'<div class="footer">CWR Consulting ¬∑ TimeTrack Pro ¬∑ Confidential ¬∑ '+new Date().toLocaleDateString()+'</div>'
    +'</body></html>');
  win.document.close();
  setTimeout(()=>{win.print();},400);
  showToast('PDF print dialog opened ‚úì');
}
function exportTimeQB(){
  const lines=['!TIMERHDR\tVER\tREL\tCOMPANYNAME\tIMPORTEDBEFORE\tFROMTIMER','TIMERHDR\t8\t0\tCWR Consulting\tN\tN','!TIMER\tEMPLOYEE\tCUSTOMER:JOB\tSERVICEITEM\tDURATION\tPROJECT\tNOTES\tBILLINGSTATUS','!ENDTIMER'];
  entries.forEach(e=>{
    const p=gp(e.projectId);
    const hrs=Math.floor(e.hours),mins=Math.round((e.hours-hrs)*60);
    const dur=`${String(hrs).padStart(2,'0')}:${String(mins).padStart(2,'0')}`;
    lines.splice(lines.length-1,0,`TIMER\tConsultant\t${p?p.client:''}\t${e.task}\t${dur}\t${p?p.name:''}\t${e.desc}\t1`);
  });
  dl(lines.join('\n'),'text/plain',`CWR-time-QB-${td()}.iif`);
  showToast('QuickBooks Time IIF exported ‚úì');
}

// ============ INVOICE ============
function autofillClientFromProject(){
  const pid=document.getElementById('inv-project').value;
  const p=gp(pid);
  if(p){
    document.getElementById('inv-client-name').value=p.client||'';
    document.getElementById('inv-client-addr').value=p.clientAddr||'';
    document.getElementById('inv-client-phone').value=p.clientPhone||'';
    document.getElementById('inv-client-email').value=p.clientEmail||'';
  }
}
function initInvoice(){
  const today=new Date();
  const due=new Date(today);due.setDate(due.getDate()+30);
  document.getElementById('inv-date').value=today.toISOString().split('T')[0];
  document.getElementById('inv-due').value=due.toISOString().split('T')[0];
  const ms=new Date(today.getFullYear(),today.getMonth(),1);
  document.getElementById('inv-from').value=ms.toISOString().split('T')[0];
  document.getElementById('inv-to').value=today.toISOString().split('T')[0];
  document.getElementById('inv-number').value=nextInvNum();
  document.getElementById('inv-number').readOnly=true;
  document.getElementById('inv-project').innerHTML='<option value="">Select project‚Ä¶</option>'+
    projects.filter(isActiveProject).map(p=>`<option value="${p.id}">${p.code} ‚Äî ${p.name}</option>`).join('');
  // Restore saved biz profile
  if(bizProfile.fromName)  document.getElementById('inv-from-name').value=bizProfile.fromName;
  if(bizProfile.fromAddr1) document.getElementById('inv-from-addr1').value=bizProfile.fromAddr1;
  if(bizProfile.fromPhone) document.getElementById('inv-from-phone').value=bizProfile.fromPhone;
  if(bizProfile.fromEmail) document.getElementById('inv-from-email').value=bizProfile.fromEmail;
  if(bizProfile.footerText !== undefined) document.getElementById('inv-footer-text').value=bizProfile.footerText||'';
  renderInvoiceHistory();
  buildInvoice();
}
function buildInvoice(){
  // Save biz profile
  bizProfile={
    fromName: document.getElementById('inv-from-name').value,
    fromAddr1: document.getElementById('inv-from-addr1').value,
    fromPhone: document.getElementById('inv-from-phone').value,
    fromEmail: document.getElementById('inv-from-email').value,
    footerText: document.getElementById('inv-footer-text').value,
  };
  sbiz();
  const invNum=document.getElementById('inv-number').value||nextInvNum();
  const invDate=document.getElementById('inv-date').value;
  const invDue=document.getElementById('inv-due').value;
  const fromName=bizProfile.fromName||'CWR Consulting';
  const fromAddr1=bizProfile.fromAddr1||'';
  const fromPhone=bizProfile.fromPhone||'';
  const fromEmail=bizProfile.fromEmail||'';
  const pid=document.getElementById('inv-project').value;
  const from=document.getElementById('inv-from').value;
  const to=document.getElementById('inv-to').value;
  const taxRate=parseFloat(document.getElementById('inv-tax').value)||0;
  const terms=document.getElementById('inv-terms').value||'Net 30';
  const notes=document.getElementById('inv-notes').value||'Thank you for your business!';
  const clientName=document.getElementById('inv-client-name').value||(pid?gp(pid)?.client||'Client':'Client');
  const clientAddr=document.getElementById('inv-client-addr').value;
  const clientPhone=document.getElementById('inv-client-phone').value;
  const clientEmail=document.getElementById('inv-client-email').value;
  const footerText=document.getElementById('inv-footer-text').value.trim();

  let filteredTime=entries.filter(e=>e.date>=from&&e.date<=to);
  if(pid)filteredTime=filteredTime.filter(e=>e.projectId===pid);
  const billExpenses=expenses.filter(e=>e.date>=from&&e.date<=to&&e.billable==='yes'&&(!pid||e.projectId===pid));

  if(!filteredTime.length&&!billExpenses.length){
    document.getElementById('invoice-preview-area').innerHTML=`<div class="empty-state card"><div class="icon">üßæ</div>No entries or billable expenses found for selected project and date range.</div>`;
    return;
  }

  // Group time by task
  const taskGroups={};
  filteredTime.forEach(e=>{
    const ep=gp(e.projectId);
    const key=`${ep?ep.code:''}_${e.task}`;
    if(!taskGroups[key])taskGroups[key]={task:e.task,project:ep,hours:0};
    taskGroups[key].hours+=e.hours;
  });
  const lineItems=Object.values(taskGroups);
  const timeSubtotal=lineItems.reduce((s,li)=>s+(li.project?li.hours*li.project.rate:0),0);
  const expSubtotal=billExpenses.reduce((s,e)=>s+e.amount,0);
  const subtotal=timeSubtotal+expSubtotal;
  const tax=subtotal*taxRate/100;
  const total=subtotal+tax;

  const timeSection=lineItems.length?
    '<tr class="section-header"><td colspan="5">Strategic Communications Consulting ‚Äî Time</td></tr>'
    +lineItems.map(li=>{
      const amt = li.project ? li.hours*li.project.rate : 0;
      const rate = li.project ? li.project.rate : 0;
      const code = li.project ? li.project.code : '';
      return '<tr><td style="color:var(--muted)">'+code+'</td><td>'+li.task+'</td><td style="text-align:center">'+li.hours.toFixed(2)+'</td><td style="text-align:right;color:var(--muted)">$'+rate+'/hr</td><td style="text-align:right;font-weight:600">$'+amt.toFixed(2)+'</td></tr>';
    }).join('')
    +'<tr><td colspan="4" style="text-align:right;color:var(--muted);font-size:12px">Time Subtotal</td><td style="text-align:right;font-weight:600">$'+timeSubtotal.toFixed(2)+'</td></tr>'
  :'';
  const expSection=billExpenses.length?
    '<tr class="section-header"><td colspan="5">Reimbursable Expenses</td></tr>'
    +billExpenses.map(e=>{
      const mileNote = e.miles ? ' (' + e.miles + ' mi \u00d7 $' + e.mileageRate + '/mi)' : '';
      return '<tr><td style="color:var(--muted)">'+e.category+'</td>'
        +'<td>'+e.vendor+mileNote+'</td>'
        +'<td style="text-align:center">'+fmtDate(e.date)+'</td>'
        +'<td style="text-align:right;color:var(--muted)">Expense</td>'
        +'<td style="text-align:right;font-weight:600">$'+e.amount.toFixed(2)+'</td></tr>';
    }).join('')
    +'<tr><td colspan="4" style="text-align:right;color:var(--muted);font-size:12px">Expenses Subtotal</td><td style="text-align:right;font-weight:600">$'+expSubtotal.toFixed(2)+'</td></tr>'
  :'';

  const bothSections = !!(timeSection && expSection);
  const totalsHTML = bothSections
    ? `<div class="invoice-total-row"><span>Time Subtotal</span><span>$${timeSubtotal.toFixed(2)}</span></div><div class="invoice-total-row"><span>Expenses Subtotal</span><span>$${expSubtotal.toFixed(2)}</span></div><div class="invoice-total-row"><span>Subtotal</span><span>$${subtotal.toFixed(2)}</span></div>`
    : `<div class="invoice-total-row"><span>Subtotal</span><span>$${subtotal.toFixed(2)}</span></div>`;

  document.getElementById('invoice-preview-area').innerHTML=`
        <div style="font-size:12px;color:var(--muted);margin-top:4px">Strategic Communications Consulting</div>
        <div style="margin-top:12px;font-size:12px;color:var(--muted);line-height:1.8">
          ${fromAddr1?fromAddr1+'<br>':''}
          ${fromPhone?fromPhone+'<br>':''}
          ${fromEmail?fromEmail:''}
        </div>
      </div>
      <div class="invoice-number">
        <span class="invoice-badge">Invoice</span>
        <strong>${invNum}</strong>
        <div style="margin-top:8px;font-size:11px;color:var(--muted)">
          Issued: ${fmtDateLong(invDate)}<br>
          Due: ${fmtDateLong(invDue)}
        </div>
      </div>
    </div>
    <div class="invoice-parties">
      <div>
        <div class="invoice-party-label">Bill From</div>
        <div class="invoice-party-name">${fromName}</div>
        <div class="invoice-party-detail">${fromAddr1}<br>${fromPhone}<br>${fromEmail}</div>
      </div>
      <div>
        <div class="invoice-party-label">Bill To</div>
        <div class="invoice-party-name">${clientName}</div>
        <div class="invoice-party-detail">${clientAddr}<br>${clientPhone}${clientEmail?'<br>'+clientEmail:''}<br><br>Services rendered: ${fmtDateLong(from)} ‚Äì ${fmtDateLong(to)}</div>
      </div>
    </div>
    <table class="invoice-table">
      <thead><tr>
        <th style="text-align:left">Code / Category</th>
        <th style="text-align:left">Description</th>
        <th style="text-align:center">Hours / Qty</th>
        <th style="text-align:right">Rate</th>
        <th style="text-align:right">Amount</th>
      </tr></thead>
      <tbody>${timeSection}${expSection}</tbody>
    </table>
    <div class="invoice-totals">
      ${totalsHTML}
      ${taxRate>0 ? '<div class="invoice-total-row"><span>Tax ('+taxRate+'%)</span><span>$'+tax.toFixed(2)+'</span></div>' : ''}
      <div class="invoice-total-row grand"><span>Total Due</span><span>$${total.toFixed(2)}</span></div>
    </div>
    <div class="invoice-footer">
      <strong>Payment Terms:</strong> ${terms}<br>
      ${notes}
      ${footerText ? '<br><br>'+footerText : ''}
    </div>
  </div>
  <div class="no-print" style="max-width:760px;margin:16px auto 0;display:flex;gap:10px;justify-content:flex-end">
    <button class="btn btn-green" onclick="markInvoiceSent('${invNum}','${clientName}',${total},'${invDate}','${invDue}')">‚úì Mark as Sent & Save to History</button>
    <button class="btn btn-primary" onclick="autoMarkEntriesInvoiced('${from}','${to}','${pid}')">üìå Mark All Entries as Invoiced</button>
  </div>`;
}
function markInvoiceSent(num,client,total,date,due){
  if(invoiceHistory.find(i=>i.num===num)){showToast('Already saved to history');return;}
  invoiceHistory.unshift({num,client,total,date,due,status:'sent',savedAt:new Date().toISOString()});
  sih();bumpInvCounter();
  document.getElementById('inv-number').value=nextInvNum();
  renderInvoiceHistory();showToast(`Invoice ${num} saved ‚úì`);
}
function autoMarkEntriesInvoiced(from,to,pid){
  let n=0;
  entries.forEach(e=>{if(e.date>=from&&e.date<=to&&!e.invoiced&&(!pid||e.projectId===pid)){e.invoiced=true;e.invoicedDate=new Date().toISOString().split('T')[0];n++;}});
  se();showToast(`${n} entries marked as invoiced ‚úì`);
}
function renderInvoiceHistory(){
  const el=document.getElementById('invoice-history-list');if(!el)return;
  if(!invoiceHistory.length){el.innerHTML='<div style="color:var(--muted);font-size:12px;padding:12px 0">No invoices sent yet.</div>';return;}
  el.innerHTML=invoiceHistory.map(inv=>`
    <div class="invoice-history-row">
      <div class="inv-hist-num">${inv.num}</div>
      <div class="inv-hist-client"><div style="font-weight:500">${inv.client}</div><div style="color:var(--muted);font-size:11px">Sent ${fmtDateLong(inv.date)} ¬∑ Due ${fmtDateLong(inv.due)}</div></div>
      <div class="inv-hist-amt">$${Number(inv.total).toFixed(2)}</div>
      <div>
        <select style="font-size:11px;padding:4px 8px;width:auto" onchange="updateInvStatus('${inv.num}',this.value)">
          <option value="sent" ${inv.status==='sent'?'selected':''}>Sent</option>
          <option value="paid" ${inv.status==='paid'?'selected':''}>Paid ‚úì</option>
          <option value="overdue" ${inv.status==='overdue'?'selected':''}>Overdue</option>
          <option value="draft" ${inv.status==='draft'?'selected':''}>Draft</option>
        </select>
      </div>
      <div><button class="btn btn-sm btn-danger" onclick="deleteInvHistory('${inv.num}')">‚úï</button></div>
    </div>`).join('');
}
function updateInvStatus(num,status){const inv=invoiceHistory.find(i=>i.num===num);if(inv){inv.status=status;sih();showToast(`Invoice ${num} marked as ${status}`);}}
function deleteInvHistory(num){invoiceHistory=invoiceHistory.filter(i=>i.num!==num);sih();renderInvoiceHistory();showToast('Removed from history');}
function manualInvNum(){const v=prompt('Enter invoice number:',document.getElementById('inv-number').value);if(v){document.getElementById('inv-number').value=v;document.getElementById('inv-number').readOnly=false;}}

// ============ ANNUAL REPORT ============
const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
function initAnnual(){
  const sel=document.getElementById('annual-year');
  const now=new Date();
  const years=new Set([now.getFullYear()]);
  entries.forEach(e=>years.add(parseInt(e.date.substring(0,4))));
  const sorted=[...years].sort((a,b)=>b-a);
  sel.innerHTML=sorted.map(y=>'<option value="'+y+'"'+(y===now.getFullYear()?' selected':'')+'>'+y+'</option>').join('');
  renderAnnual();
}
function renderAnnual(){
  const yr=parseInt(document.getElementById('annual-year').value)||new Date().getFullYear();
  const yrStr=String(yr);
  // Only billable projects ‚Äî filter entries where project is billable
  const billableEntries=entries.filter(e=>{
    const p=gp(e.projectId);
    return e.date.startsWith(yrStr) && p && p.status==='active-billable';
  });
  // Also include inactive-billed projects (work done, billed to client)
  const allBillable=entries.filter(e=>{
    const p=gp(e.projectId);
    return e.date.startsWith(yrStr) && p && (p.status==='active-billable'||p.status==='inactive-billed');
  });
  const billExpenses=expenses.filter(e=>e.date.startsWith(yrStr)&&e.billable==='yes');

  // Monthly breakdown
  let totalRev=0, totalHrs=0;
  const monthlyData=MONTHS.map((mName,mi)=>{
    const mStr=yrStr+'-'+(String(mi+1).padStart(2,'0'));
    const mEntries=allBillable.filter(e=>e.date.startsWith(mStr));
    const mExpenses=billExpenses.filter(e=>e.date.startsWith(mStr));
    const hrs=mEntries.reduce((s,e)=>s+e.hours,0);
    const rev=mEntries.reduce((s,e)=>{const p=gp(e.projectId);return s+(p?e.hours*p.rate:0);},0);
    const expAmt=mExpenses.reduce((s,e)=>s+e.amount,0);
    const total=rev+expAmt;
    totalRev+=rev; totalHrs+=hrs;
    // top project
    const byProj={};
    mEntries.forEach(e=>{const p=gp(e.projectId);if(p)byProj[p.name]=(byProj[p.name]||0)+e.hours;});
    const top=Object.entries(byProj).sort((a,b)=>b[1]-a[1])[0];
    return {month:mi,name:mName,hrs,rev,expAmt,total,top};
  });

  // Stats
  const months12=monthlyData.filter(m=>m.rev>0);
  const avg=months12.length?totalRev/months12.length:0;
  const best=monthlyData.reduce((a,b)=>b.rev>a.rev?b:a,{rev:0,name:'‚Äî'});
  document.getElementById('annual-total').textContent='$'+Math.round(totalRev).toLocaleString();
  document.getElementById('annual-hours').textContent=totalHrs.toFixed(1);
  document.getElementById('annual-best-month').textContent=best.rev>0?best.name.substring(0,3):'‚Äî';
  document.getElementById('annual-best-amt').textContent=best.rev>0?'$'+Math.round(best.rev).toLocaleString():'no data';
  document.getElementById('annual-avg').textContent='$'+Math.round(avg).toLocaleString();

  // Bar chart ‚Äî revenue by month
  const maxRev=Math.max(...monthlyData.map(m=>m.rev),1);
  const clrs=['pink','orange','green'];
  document.getElementById('annual-bar-chart').innerHTML=monthlyData.map((m,i)=>`
    <div class="bar-row" onclick="drillMonth(${yr},${m.month})" style="cursor:pointer" title="View ${m.name} report">
      <div class="bar-label" title="${m.name}">${m.name.substring(0,3)}</div>
      <div class="bar-track"><div class="bar-fill ${clrs[i%3]}" style="width:${m.rev>0?(m.rev/maxRev*100).toFixed(1):0}%"></div></div>
      <div class="bar-val">${m.rev>0?'$'+Math.round(m.rev/1000)+'k':'‚Äî'}</div>
    </div>`).join('');

  // Client chart
  const byClient={};
  allBillable.forEach(e=>{const p=gp(e.projectId);if(!p)return;const c=p.client||p.name;const amt=e.hours*p.rate;byClient[c]=(byClient[c]||0)+amt;});
  const clientSorted=Object.entries(byClient).sort((a,b)=>b[1]-a[1]).slice(0,8);
  const maxC=clientSorted[0]?clientSorted[0][1]:1;
  document.getElementById('annual-client-chart').innerHTML=clientSorted.length?clientSorted.map(([name,amt],i)=>`
    <div class="bar-row">
      <div class="bar-label" title="${name}">${name}</div>
      <div class="bar-track"><div class="bar-fill ${clrs[i%3]}" style="width:${(amt/maxC*100).toFixed(1)}%"></div></div>
      <div class="bar-val">$${Math.round(amt/1000)}k</div>
    </div>`).join(''):'<div style="color:var(--muted)">No billable data</div>';

  // Table
  let tRev=0,tHrs=0,tExp=0,tTot=0;
  document.getElementById('annual-body').innerHTML=monthlyData.map(m=>{
    tRev+=m.rev;tHrs+=m.hrs;tExp+=m.expAmt;tTot+=m.total;
    const isEmpty=m.hrs===0&&m.expAmt===0;
    if(isEmpty) return `<tr><td style="color:var(--muted)">${m.name}</td><td style="color:var(--muted)">‚Äî</td><td style="color:var(--muted)">‚Äî</td><td style="color:var(--muted)">‚Äî</td><td style="color:var(--muted)">‚Äî</td><td style="color:var(--muted)">‚Äî</td></tr>`;
    return `<tr>
      <td><span class="annual-month-link" onclick="drillMonth(${yr},${m.month})">${m.name}</span></td>
      <td class="tag-pink">${m.hrs.toFixed(1)}h</td>
      <td class="amt">$${m.rev.toFixed(2)}</td>
      <td style="color:var(--muted)">${m.expAmt>0?'$'+m.expAmt.toFixed(2):'‚Äî'}</td>
      <td style="font-weight:700">$${m.total.toFixed(2)}</td>
      <td style="color:var(--muted);font-size:12px">${m.top?m.top[0]:'‚Äî'}</td>
    </tr>`;
  }).join('');
  document.getElementById('annual-foot').innerHTML=`<tr>
    <td style="font-weight:700;padding-left:14px">Year Total</td>
    <td class="tag-pink">${tHrs.toFixed(1)}h</td>
    <td class="amt" style="font-weight:700">$${tRev.toFixed(2)}</td>
    <td style="color:var(--muted)">${tExp>0?'$'+tExp.toFixed(2):'‚Äî'}</td>
    <td style="font-weight:700;color:var(--pink)">$${tTot.toFixed(2)}</td>
    <td></td>
  </tr>`;
}
function drillMonth(yr,mi){
  // Navigate to Reports with that month pre-filled
  const from=new Date(yr,mi,1).toISOString().split('T')[0];
  const to=new Date(yr,mi+1,0).toISOString().split('T')[0];
  showView('reports');
  document.getElementById('report-from').value=from;
  document.getElementById('report-to').value=to;
  runReport();
}
function exportAnnualCSV(){
  const yr=document.getElementById('annual-year').value;
  const rows=[['Month','Billable Hours','Revenue','Billable Expenses','Total','Top Project']];
  MONTHS.forEach((mName,mi)=>{
    const mStr=yr+'-'+(String(mi+1).padStart(2,'0'));
    const mEntries=entries.filter(e=>{const p=gp(e.projectId);return e.date.startsWith(mStr)&&p&&(p.status==='active-billable'||p.status==='inactive-billed');});
    const mExp=expenses.filter(e=>e.date.startsWith(mStr)&&e.billable==='yes');
    const hrs=mEntries.reduce((s,e)=>s+e.hours,0);
    const rev=mEntries.reduce((s,e)=>{const p=gp(e.projectId);return s+(p?e.hours*p.rate:0);},0);
    const expAmt=mExp.reduce((s,e)=>s+e.amount,0);
    const byProj={};mEntries.forEach(e=>{const p=gp(e.projectId);if(p)byProj[p.name]=(byProj[p.name]||0)+e.hours;});
    const top=Object.entries(byProj).sort((a,b)=>b[1]-a[1])[0];
    rows.push([mName,hrs.toFixed(1),'$'+rev.toFixed(2),'$'+expAmt.toFixed(2),'$'+(rev+expAmt).toFixed(2),top?top[0]:'‚Äî']);
  });
  dl(rows.map(r=>r.map(v=>'"'+v+'"').join(',')).join('\n'),'text/csv','CWR-Annual-'+yr+'.csv');
  showToast('Annual CSV exported ‚úì');
}
function exportAnnualPDF(){
  const yr=document.getElementById('annual-year').value;
  const win=window.open('','_blank');
  // Re-gather data for PDF
  const yrStr=String(yr);
  const allBillable=entries.filter(e=>{const p=gp(e.projectId);return e.date.startsWith(yrStr)&&p&&(p.status==='active-billable'||p.status==='inactive-billed');});
  const billExp=expenses.filter(e=>e.date.startsWith(yrStr)&&e.billable==='yes');
  let totalRev=0,totalHrs=0;
  const rows=MONTHS.map((mName,mi)=>{
    const mStr=yrStr+'-'+(String(mi+1).padStart(2,'0'));
    const mE=allBillable.filter(e=>e.date.startsWith(mStr));
    const mX=billExp.filter(e=>e.date.startsWith(mStr));
    const hrs=mE.reduce((s,e)=>s+e.hours,0);
    const rev=mE.reduce((s,e)=>{const p=gp(e.projectId);return s+(p?e.hours*p.rate:0);},0);
    const expAmt=mX.reduce((s,e)=>s+e.amount,0);
    totalRev+=rev;totalHrs+=hrs;
    const byProj={};mE.forEach(e=>{const p=gp(e.projectId);if(p)byProj[p.name]=(byProj[p.name]||0)+e.hours;});
    const top=Object.entries(byProj).sort((a,b)=>b[1]-a[1])[0];
    return {mName,hrs,rev,expAmt,total:rev+expAmt,top};
  });
  const byClient={};
  allBillable.forEach(e=>{const p=gp(e.projectId);if(!p)return;const c=p.client||p.name;const amt=e.hours*p.rate;byClient[c]=(byClient[c]||0)+amt;});
  const topClients=Object.entries(byClient).sort((a,b)=>b[1]-a[1]).slice(0,5);
  win.document.write('<!DOCTYPE html><html><head><meta charset="UTF-8"><title>CWR Annual Report '+yr+'</title>'
    +'<style>@page{margin:.75in}body{font-family:Arial,sans-serif;color:#1a1612;font-size:11pt}'
    +'h1{color:#e8187a;font-size:20pt;margin-bottom:2px}h2{font-size:13pt;color:#4a4540;margin:20px 0 8px;border-bottom:1.5px solid #e8e4de;padding-bottom:3px}'
    +'.stats{display:flex;gap:20px;margin:16px 0}.stat{background:#fce8f2;border-radius:8px;padding:12px 16px;flex:1}.stat-val{font-size:20pt;font-weight:700;color:#e8187a}.stat-lab{font-size:9pt;color:#8a847c;text-transform:uppercase;letter-spacing:.5px}'
    +'table{width:100%;border-collapse:collapse;margin:10px 0;font-size:10pt}'
    +'th{background:#e8187a;color:#fff;padding:7px 10px;text-align:left;font-size:9.5pt}'
    +'td{padding:6px 10px;border-bottom:1px solid #e8e4de}'
    +'tr:nth-child(even) td{background:#faf9f7}.total-row td{font-weight:700;background:#f8f6f2}'
    +'.amt{color:#15803d;font-weight:600}.muted{color:#8a847c}'
    +'.footer{margin-top:28px;font-size:8.5pt;color:#8a847c;border-top:1px solid #e8e4de;padding-top:10px;text-align:center}'
    +'</style></head><body>'
    +'<h1>CWR Consulting</h1>'
    +'<div style="color:#8a847c;font-size:10pt;margin-bottom:16px"><strong>Annual Summary ‚Äî '+yr+'</strong> &nbsp;¬∑&nbsp; Billable revenue only &nbsp;¬∑&nbsp; Generated '+new Date().toLocaleDateString()+'</div>'
    +'<div class="stats"><div class="stat"><div class="stat-val">$'+Math.round(totalRev).toLocaleString()+'</div><div class="stat-lab">Annual Revenue</div></div>'
    +'<div class="stat" style="background:#fff0e8"><div class="stat-val" style="color:#f4620a">'+totalHrs.toFixed(1)+'h</div><div class="stat-lab">Total Hours</div></div>'
    +'<div class="stat" style="background:#dcfce7"><div class="stat-val" style="color:#15803d">$'+Math.round(totalRev/Math.max(rows.filter(r=>r.rev>0).length,1)).toLocaleString()+'</div><div class="stat-lab">Avg / Month</div></div></div>'
    +'<h2>Month-by-Month Breakdown</h2>'
    +'<table><thead><tr><th>Month</th><th>Hours</th><th>Revenue</th><th>Expenses</th><th>Total</th><th>Top Project</th></tr></thead><tbody>'
    +rows.map(r=>'<tr><td><strong>'+r.mName+'</strong></td><td>'+r.hrs.toFixed(1)+'h</td><td class="amt">$'+r.rev.toFixed(2)+'</td><td class="muted">'+( r.expAmt>0?'$'+r.expAmt.toFixed(2):'‚Äî')+'</td><td style="font-weight:600">$'+r.total.toFixed(2)+'</td><td class="muted" style="font-size:9pt">'+(r.top?r.top[0]:'‚Äî')+'</td></tr>').join('')
    +'<tr class="total-row"><td>Year Total</td><td>'+totalHrs.toFixed(1)+'h</td><td class="amt">$'+totalRev.toFixed(2)+'</td><td></td><td class="amt">$'+rows.reduce((s,r)=>s+r.total,0).toFixed(2)+'</td><td></td></tr>'
    +'</tbody></table>'
    +(topClients.length?'<h2>Top Clients</h2><table><thead><tr><th>Client</th><th>Revenue</th></tr></thead><tbody>'+topClients.map(([c,a])=>'<tr><td>'+c+'</td><td class="amt">$'+a.toFixed(2)+'</td></tr>').join('')+'</tbody></table>':'')
    +'<div class="footer">CWR Consulting ¬∑ TimeTrack Pro ¬∑ Annual Report '+yr+' ¬∑ Confidential</div>'
    +'</body></html>');
  win.document.close();
  setTimeout(()=>win.print(),400);
  showToast('PDF print dialog opened ‚úì');
}

// ============ RETAINER TRACKER ============
function renderRetainers(){
  const now=new Date();
  const container=document.getElementById('retainer-list');
  if(!retainers.length){
    container.innerHTML='<div class="card"><div class="empty-state"><div class="icon">‚è≥</div>No retainers set up yet.<br><button class="btn btn-primary" onclick="openRetainerModal()" style="margin-top:16px">Ôºã Add Your First Retainer</button></div></div>';
    document.getElementById('retainer-log-card').style.display='none';
    return;
  }
  container.innerHTML=retainers.map(ret=>buildRetainerCard(ret,now)).join('');
  // Recent retainer-linked entries
  const retPids=new Set(retainers.map(r=>r.projectId).filter(Boolean));
  const recentLog=[...entries].filter(e=>retPids.has(e.projectId)).sort((a,b)=>b.date.localeCompare(a.date)).slice(0,10);
  document.getElementById('retainer-log-card').style.display=recentLog.length?'block':'none';
  document.getElementById('retainer-log-body').innerHTML=recentLog.map(e=>{
    const p=gp(e.projectId);
    return `<tr><td style="color:var(--muted);white-space:nowrap">${fmtDate(e.date)}</td><td><span class="tag-pink">${p?p.code:'?'}</span> ${p?p.name:'Unknown'}</td><td><span style="background:var(--orange-light);color:var(--orange);border-radius:20px;padding:2px 8px;font-size:11px;font-weight:600">${e.task}</span></td><td style="color:var(--muted);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${e.desc}</td><td class="tag-pink">${e.hours}h</td></tr>`;
  }).join('');
}
function buildRetainerCard(ret, now){
  // Get current month (or allow month nav per card ‚Äî use current month)
  const y=now.getFullYear(), m=now.getMonth();
  const mStr=y+'-'+(String(m+1).padStart(2,'0'));
  const retEntries=entries.filter(e=>e.date.startsWith(mStr)&&e.projectId===ret.projectId);
  const burned=retEntries.reduce((s,e)=>s+e.hours,0);
  const cap=ret.hours||0;
  const pct=cap>0?Math.min(burned/cap,1):0;
  const overPct=cap>0&&burned>cap?((burned-cap)/cap):0;
  const gaugeClass=pct<0.75?'ok':pct<1?'warn':'over';
  const remaining=Math.max(cap-burned,0);
  const p=gp(ret.projectId);
  const feePerHr=cap>0&&ret.fee?ret.fee/cap:0;
  const burnedAmt=feePerHr>0?burned*feePerHr:0;
  const isActive=!ret.endDate||ret.endDate>=mStr.substring(0,7)+'-01';
  const status=isActive?'<span class="status-badge status-active">Active</span>':'<span class="status-badge status-inactive">Ended</span>';
  return `<div class="retainer-card">
    <div class="retainer-header">
      <div>
        <div class="retainer-name">${ret.name} ${status}</div>
        <div class="retainer-meta">${p?p.code+' ‚Äî '+p.name:'No project linked'} &nbsp;¬∑&nbsp; $${(ret.fee||0).toLocaleString()}/mo &nbsp;¬∑&nbsp; ${cap}h included</div>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-sm" onclick="openRetainerModal('${ret.id}')">‚úèÔ∏è Edit</button>
      </div>
    </div>
    <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-bottom:4px;">
      <span>Hours burned this month</span>
      <span style="font-weight:700;color:${gaugeClass==='over'?'#dc2626':gaugeClass==='warn'?'var(--orange)':'var(--green)'}">${burned.toFixed(1)} / ${cap}h &nbsp; (${(pct*100).toFixed(0)}%)</span>
    </div>
    <div class="retainer-gauge-track">
      <div class="retainer-gauge-fill ${gaugeClass}" style="width:${Math.min(pct*100,100).toFixed(1)}%"></div>
    </div>
    ${burned>cap?`<div style="font-size:11px;color:#dc2626;font-weight:600;margin-bottom:8px;">‚ö†Ô∏è ${(burned-cap).toFixed(1)}h over retainer cap this month</div>`:''}
    <div class="retainer-stats">
      <div class="retainer-stat"><div class="retainer-stat-val" style="color:var(--pink)">${burned.toFixed(1)}h</div><div class="retainer-stat-label">Burned</div></div>
      <div class="retainer-stat"><div class="retainer-stat-val" style="color:var(--green)">${remaining.toFixed(1)}h</div><div class="retainer-stat-label">Remaining</div></div>
      <div class="retainer-stat"><div class="retainer-stat-val">${cap}h</div><div class="retainer-stat-label">Monthly Cap</div></div>
      ${burnedAmt>0?`<div class="retainer-stat"><div class="retainer-stat-val" style="color:var(--muted)">$${burnedAmt.toFixed(0)}</div><div class="retainer-stat-label">Value Used</div></div>`:''}
      ${ret.notes?`<div style="flex:1;font-size:11px;color:var(--muted);align-self:center;padding-left:8px;border-left:2px solid var(--border)">${ret.notes}</div>`:''}
    </div>
  </div>`;
}
function openRetainerModal(editId){
  const ret=editId?gr(editId):null;
  document.getElementById('ret-editing-id').value=editId||'';
  document.getElementById('retainer-modal-title').textContent=ret?'Edit Retainer':'Add Retainer';
  document.getElementById('ret-delete-btn').style.display=ret?'inline-flex':'none';
  document.getElementById('ret-project').innerHTML='<option value="">No specific project</option>'+projects.map(p=>`<option value="${p.id}">${p.code} ‚Äî ${p.name}</option>`).join('');
  document.getElementById('ret-name').value=ret?ret.name:'';
  document.getElementById('ret-project').value=ret?ret.projectId:'';
  document.getElementById('ret-hours').value=ret?ret.hours:'';
  document.getElementById('ret-fee').value=ret?ret.fee:'';
  document.getElementById('ret-start').value=ret?ret.startDate:'';
  document.getElementById('ret-end').value=ret?ret.endDate||'':'';
  document.getElementById('ret-notes').value=ret?ret.notes||'':'';
  document.getElementById('modal-retainer').classList.add('open');
}
function saveRetainer(){
  const editId=document.getElementById('ret-editing-id').value;
  const name=document.getElementById('ret-name').value.trim();
  const projectId=document.getElementById('ret-project').value;
  const hours=parseFloat(document.getElementById('ret-hours').value)||0;
  const fee=parseFloat(document.getElementById('ret-fee').value)||0;
  const startDate=document.getElementById('ret-start').value;
  const endDate=document.getElementById('ret-end').value;
  const notes=document.getElementById('ret-notes').value.trim();
  if(!name){showToast('Please enter a retainer name');return;}
  const rec={name,projectId,hours,fee,startDate,endDate,notes};
  if(editId){const r=gr(editId);if(r)Object.assign(r,rec);showToast('Retainer updated ‚úì');}
  else{retainers.push({id:'r'+Date.now(),...rec});showToast('Retainer saved ‚úì');}
  sr();closeModal('modal-retainer');renderRetainers();
}
function deleteCurrentRetainer(){
  const id=document.getElementById('ret-editing-id').value;
  if(id&&confirm('Delete this retainer? This cannot be undone.')){
    retainers=retainers.filter(r=>r.id!==id);sr();closeModal('modal-retainer');renderRetainers();showToast('Retainer deleted');
  }
}

// ============ UTILS ============
function fmtDate(ds){return new Date(ds+'T12:00:00').toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});}
function fmtDateLong(ds){if(!ds)return'';return new Date(ds+'T12:00:00').toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});}
function closeModal(id){document.getElementById(id).classList.remove('open');}
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500);}
function td(){return new Date().toISOString().split('T')[0];}
function dl(content,type,filename){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([content],{type}));a.download=filename;a.click();}
document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');}));

// INIT
populateTimerProjects();
renderDashboard();
renderTimesheet();
</script>
</body>
</html>
